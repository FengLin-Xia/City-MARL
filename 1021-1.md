# v5.0缺失功能全面清单

## 📋 概述

本文档详细记录了v5.0系统相对于v4.1缺失的所有关键功能，包括配置、代码实现、奖励机制等各个方面。

## 🔧 配置缺失

### 1. Council河流特殊规则配置 ❌
**缺失内容：**
- `river_bypass: true` - Council可以跨河流建造
- `start_after_month: 6` - Council在第6个月后开始
- `other_side_bonus` - 河流对岸奖励
- `proximity_scale` - 邻近度缩放

**影响：** Council智能体失去河流特殊处理能力

### 2. 评估系统配置 ❌
**缺失内容：**
- `evaluation` 配置块
- `proximity_threshold` - 邻近阈值
- `proximity_reward` - 邻近奖励
- `council` 特殊规则配置

**影响：** 评估系统参数缺失

### 3. Hub点配置 ❌
**缺失内容：**
- Hub点配置是否与v4.1对齐
- 可能存在hub点配置缺失问题

**影响：** Hub点参数可能不一致

### 4. 河流溢价参数 ❌
**缺失内容：**
- `RiverPmax_pct` - 河流溢价最高占比
- `RiverPmax_pct_EDU_by_size` - EDU按尺寸的河流溢价
- `RiverD_half_m` - 河流衰减半衰距离
- `RiverPremiumCap_kGBP` - 河流溢价封顶

**影响：** 河流附近建造失去溢价奖励

## 🏗️ 功能缺失

### 5. 河流分割功能 ❌
**缺失内容：**
- 河流障碍物配置
- 连通域计算逻辑
- Hub侧别分配
- 智能体侧别限制

**影响：** 智能体可以在河流两侧自由建造，失去地理约束

### 6. 候选范围功能 ❌
**缺失内容：**
- Hub环带配置（R0, dR参数）
- 环带计算逻辑
- 半径计算公式
- 智能体候选范围限制

**影响：** 智能体可以在整个地图自由建造，失去渐进式扩展

## 💰 奖励机制缺失

### 7. 复杂奖励机制 ❌
**缺失内容：**
- NPV计算（未来收益 - 成本）
- 进度奖励（基于已有建筑数量）
- 协作奖励（智能体间协调）
- 预算惩罚（负债和破产检测）
- 奖励缩放（缩放到[-1, 1]范围）

**影响：** 奖励计算过于简化，缺少复杂机制

### 8. 河流溢价奖励 ❌
**缺失内容：**
- 河流距离计算
- 衰减函数：`2^(-d/RiverD_half_m)`
- 溢价计算：`base_for_premium * rpct * decay`
- IND: 20%, EDU: 25% 的河流溢价

**影响：** 河流附近建造失去溢价奖励

### 9. 地价货币化 ❌
**缺失内容：**
- LP_value计算：`LP_idx * LandPriceBase`
- EDU获得地价：`+LP_value`
- IND支付地价：`-LP_value`
- 地价对成本/收益的影响

**影响：** 地价失去对成本/收益的调节作用

### 10. 邻近性奖励/惩罚 ❌
**缺失内容：**
- 距离计算到最近建筑
- 邻近奖励：`proximity_reward_val * (1.0 - min_dist / proximity_threshold)`
- 距离惩罚：`(min_dist - proximity_threshold) * distance_penalty_coef`
- 按EDU A/B/C尺寸缩放

**影响：** 失去邻近性约束和奖励

### 11. 区位乘子 ❌
**缺失内容：**
- `m_zone` 乘子（near/mid/far）
- `m_adj` 乘子（相邻/不相邻）
- 区位对奖励的调节作用

**影响：** 失去区位差异对奖励的影响

### 12. 地价敏感度奖励 ❌
**缺失内容：**
- `RewardLP_k` 参数（IND: 0.25, EDU: 0.10）
- 地价正相关收益增益：`reward *= (1.0 + k_lp * lp_norm)`

**影响：** 失去地价对奖励的敏感度调节

### 13. 建筑规模奖励 ❌
**缺失内容：**
- Size Bonus机制
- 鼓励建造M/L型建筑
- 按建筑规模给予奖励

**影响：** 失去对大型建筑的鼓励机制

### 14. 运营成本计算 ❌
**缺失内容：**
- `OPEX_IND` 运营成本（S: 100, M: 180, L: 300）
- `OPEX_EDU` 运营成本（S: 70, M: 120, L: 190）
- 运营成本对收益的影响

**影响：** 失去运营成本对长期收益的影响

### 15. 租金收入 ❌
**缺失内容：**
- `Rent` 租金收入（S: 25, M: 45, L: 70）
- EDU获得租金收入
- 租金对EDU收益的影响

**影响：** EDU失去租金收入机制

### 16. 奖励缩放机制 ❌
**缺失内容：**
- `reward_scale` 缩放因子（默认3000.0）
- `reward_clip` 裁剪值（默认1.0）
- 奖励缩放到[-1, 1]范围

**影响：** 奖励值可能过大或过小

### 17. 协作奖励机制 ❌
**缺失内容：**
- 智能体间协调奖励
- 功能互补奖励（EDU和IND协调）
- 空间协调奖励

**影响：** 失去智能体间的协调机制

### 18. 预算惩罚机制 ❌
**缺失内容：**
- 负债惩罚：`abs(budget_after) * debt_penalty_coef`
- 破产检测：`budget_after < bankruptcy_threshold`
- 破产惩罚：`bankruptcy_penalty`

**影响：** 失去预算约束机制

### 19. 进度奖励机制 ❌
**缺失内容：**
- 基于已有建筑数量的奖励
- EDU: `len(self.buildings['public']) * 0.5`
- IND: `len(self.buildings['industrial']) * 0.5`

**影响：** 失去基于进度的奖励机制

## 📊 影响评估

### 高优先级（核心功能缺失）
1. **河流分割功能** - 影响地理约束
2. **候选范围功能** - 影响建造范围
3. **复杂奖励机制** - 影响奖励计算
4. **河流溢价奖励** - 影响河流附近建造
5. **地价货币化** - 影响地价对成本/收益的影响

### 中优先级（重要机制缺失）
6. **邻近性奖励/惩罚** - 影响邻近性约束
7. **区位乘子** - 影响区位差异
8. **地价敏感度奖励** - 影响地价调节
9. **运营成本计算** - 影响长期收益
10. **租金收入** - 影响EDU收益结构

### 低优先级（细节优化）
11. **建筑规模奖励** - 影响建筑类型选择
12. **奖励缩放机制** - 影响奖励值范围
13. **协作奖励机制** - 影响智能体协调
14. **预算惩罚机制** - 影响预算约束
15. **进度奖励机制** - 影响进度奖励

## 🔧 修复建议

### 1. 配置文件修复
- 添加缺失的配置项到 `configs/city_config_v5_0.json`
- 确保所有配置项与v4.1对齐

### 2. 代码实现修复
- 在 `envs/v5_0/city_env.py` 中实现复杂奖励机制
- 在 `logic/v5_scorer.py` 中实现详细奖励计算
- 添加河流分割、候选范围等功能

### 3. 测试验证
- 运行回归测试确保与v4.1行为一致
- 验证所有奖励机制的正确性

## 📝 总结

v5.0系统在算法层面是完整的，但在地理约束、奖励机制、配置完整性方面存在大量缺失。需要系统性地修复这些缺失功能，才能与v4.1行为一致。

**关键缺失：**
- 地理约束机制（河流分割、候选范围）
- 复杂奖励机制（NPV、进度、协作、预算惩罚）
- 详细奖励计算（河流溢价、地价货币化、邻近性奖励）
- 配置完整性（Council规则、评估系统、Hub配置）

**修复优先级：**
1. 高优先级：地理约束和核心奖励机制
2. 中优先级：重要奖励机制和运营机制
3. 低优先级：细节优化和配置完善

