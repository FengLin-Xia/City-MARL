# 单位系统修复报告

## ✅ 已完成的工作

### 1. 单位系统统一
- **米到像素转换比例**: 2.0 m/px
- **所有距离参数**现在同时提供米和像素单位
- **配置文件备份**到 `configs/city_config_v2_3_backup.json`

### 2. 像素单位参数添加

#### SDF系统参数
- `λ⊥_px = 60 px` (原 120 m) - 道路法向衰减长度
- `λ_hub_px = 50 px` (原 100 m) - Hub影响半径  
- `λ∥_px = 100 px` (原 200 m) - 道路切向衰减长度

#### 等值线布局参数
- **商业建筑**:
  - 深度: 10 px (原 20 m)
  - 间隔: 5 px (原 10 m)
  - 弧长间距: [12, 17] px (原 [25, 35] m)
- **住宅建筑**:
  - 深度: 7 px (原 14 m)
  - 间隔: 13 px (原 26 m)
  - 弧长间距: [17, 27] px (原 [35, 55] m)
- **通用参数**:
  - 法向偏移: 0 px (原 1.0 m) ⚠️ 需要修复
  - 切向抖动: 0 px (原 0.5 m) ⚠️ 需要修复

#### 分带参数
- 前排禁住宅区: [30, 60] px (原 [60, 120] m)
- 住宅侧带: [60, 130] px (原 [120, 260] m)

#### 公共设施参数
- 学校服务半径: 25 px (原 50 m)
- 诊所服务半径: 20 px (原 40 m)
- 公园服务半径: 30 px (原 60 m)

## ⚠️ 发现的关键问题

### 1. Hub影响半径过小
- **当前**: λ_hub_px = 50 px (100 m)
- **两个hub距离**: 176 px (352 m)
- **问题**: Hub影响半径过小，两个hub之间没有SDF重叠
- **建议**: 增加 `lambda_point_m` 到 176 m 以上

### 2. 法向偏移和切向抖动为0
- **问题**: 转换为像素后变为0，失去建筑位置微调功能
- **原因**: 1.0 m / 2.0 m/px = 0.5 px，取整后为0
- **建议**: 调整 `meters_per_pixel` 或增加最小偏移值

## 🔧 下一步修复计划

### 阶段1: 修复SDF场生成
1. **增加Hub影响半径**
   - 将 `lambda_point_m` 从 100m 增加到 200-300m
   - 确保两个hub之间有SDF重叠

2. **修复线SDF实现**
   - 确保 `_create_line_sdf()` 方法正确工作
   - 基于道路方向生成连续的SDF场

### 阶段2: 修复等值线生成
1. **替换分位数逻辑**
   - 当前使用 `[95, 90, 85]` 和 `[80, 70, 60, 50]` 分位数
   - 改为使用几何等值线: P₀ = 0.85, P₁ = 0.78, P₂ = 0.71...

2. **实现渐进式等值线**
   - 基于道路方向生成等值线
   - 确保等值线能够跨越两个hub区域

### 阶段3: 修复分带逻辑
1. **实现基于道路的分带**
   - 前排区域: 30-60 px (60-120 m)
   - 住宅侧带: 60-130 px (120-260 m)
   - 外围区域: >130 px (>260 m)

2. **分带与等值线匹配**
   - 确保等值线生成逻辑支持分带要求

### 阶段4: 激活城市演化逻辑
1. **实现住宅→商业替代**
   - 基于SDF变化的建筑重新分布
   - 滞后逻辑和冷却期

2. **渐进式建筑生成**
   - 逐层填满等值线
   - 城市"生长感"效果

## 📊 当前配置状态

```json
{
  "unit_system": {
    "meters_per_pixel": 2.0,
    "description": "所有距离参数同时提供米和像素单位，确保兼容性",
    "conversion_note": "像素参数 = 米参数 / meters_per_pixel"
  }
}
```

## 🎯 预期效果

修复完成后，应该实现：
1. **两个hub周围都有商业建筑生成**
2. **道路两侧有住宅建筑分布**
3. **随着城市发展，道路两侧住宅被商业替代**
4. **新的住宅向外延伸**
5. **形成连续的城市结构，而非分离的区域**

## 📝 注意事项

1. **保持米单位参数**: 为了向后兼容和可读性
2. **像素参数精度**: 避免过度取整导致功能丢失
3. **测试验证**: 每个阶段都要验证SDF场和建筑分布效果


