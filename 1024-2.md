# v5.0 实现任务清单与优先级计划

## 1. 功能模块与职责

### 1.1 配置与契约（**不动基石**）
- 完整维护 `configs/city_config_v5_0.json`，所有参数仅通过配置。
- 关键契约类：`ActionCandidate`、`Sequence`、`StepLog`，扩展信息统一放入 `meta` 字段。

### 1.2 控制层 *Pipeline*
- 文件：`enhanced_city_simulation_v5*.py`。
- 职责：串联流水线（枚举 → 中间件 → 计算 CRP → 评分 → 选择 → `env.step` → 记录 `StepLog`）。
- 通过注册表读取配置，动态装载模块。

### 1.3 中间件 `action_mw/**`
- 统一接口：`apply(seq, state) -> Sequence`。
- 子模块：合法性 / 冲突 / 裁剪、预算软/硬约束、策略裁剪等，全部参数化。

### 1.4 经济计算器 `logic/v5_reward_calculator.py`
- 成本、收益、声望三合一计算（CRP）。
- 插件化奖励项 `reward_terms/**`，支持 `land_price`、`proximity`、`river`、`size_bonus` 独立启停。
- 对接 `GaussianLandPriceSystem`，参数化地价区间与基准。

### 1.5 环境 `envs/v5_0/city_env.py`
- NPV 奖励机制（`expected_lifetime` 改为配置）。
- 月度收益累积 & 预算惩罚（负债 / 破产）。
- 协作奖励 (`cooperation_lambda`) 与奖励缩放 / 裁剪。

### 1.6 评分器 `V5ActionScorer`
- 归一化 + 加权评分，权重从配置 `objective` 获取。

### 1.7 调度器 `scheduler/**`
- 默认 `phase_cycle` 实现 `who_acts(t, state)`，支持配置切换。

### 1.8 工具与导出 `utils/**`
- 依据 `StepLog` 统一导出表格 / 图表 / 报告。

### 1.9 测试与校验
- 单元测试：CRP 各公式（用文档示例校验）。
- 集成测试：30 个月完整仿真；验证 “12 个月后 Budget ≈ NPV”。
- 兼容性：保持与 v4.1 核心接口一致。

---

## 2. 关键配置需补充/确认
- 经济项：`ZC`（区位成本）、`ZR`（区位收益）、`Rent`、`expected_lifetime`。
- 地价项：`LP_idx_min/max`、`LandPriceBase`、`RewardLP_k`。
- 奖励项：`reward_terms.components` 及其参数（邻近阈值、河流半衰等）。
- 策略项：调度策略、错误处理策略（`WARN` / `FAIL_FAST`）。
- RL 项：`reward_scale`、`reward_clip`、`cooperation_lambda`。
- 目标权重：`objective` 中各 agent 的 `w_r / w_p / w_c`。

### 2.1 `city_config_v5_0.json` 差异分析

#### 2.1.1 已存在且符合设计
- `expected_lifetime = 12`（在 `reward_mechanisms.npv_calculation`）
- 租金表 `Rent = {S:25, M:45, L:70}`（`reward_mechanisms.rental_income`）
- 四大动态奖励开关均已开启：`land_price`／`proximity`／`river`／`size_bonus`
- `scheduler.name = "phase_cycle"` 与完整参数

#### 2.1.2 缺失或需调整
| 类别 | 设计要求 | 当前状态 | 修改建议 |
|------|----------|----------|----------|
| ZC 区位成本 | `near:200, mid:100, far:0` | 未定义，仅有 `zone_multipliers` 系数 | 新增 `reward_terms.zone_cost` 常数表，或保持 multiplier 并同步公式 |
| ZR 区位收益 | `near:80, mid:40, far:0` | 未定义 | 同上，新增 `reward_terms.zone_reward` 常数表 |
| COUNCIL `RewardLP_k` | 0.15 | 0.10 | 调整 `reward_terms.land_price.RewardLP_k.COUNCIL = 0.15` |
| Size Bonus 数值 | M:1000, L:2000 | 目前 50/100 | 按 action_id 或 Size 重写 `reward_terms.size_bonus` |
| `action_params` 细节 | 需 `base_cost/base_reward/opex/...` | 仅 `cost/reward/prestige` | 补充各字段以符合“配置驱动” |
| IND 租金扣减 | 工业需支付租金 | `edu_only = true` | 增加 `ind_pays_rent: true` 并在计算器中实现扣减 |

> 若继续沿用 `zone_multipliers` 乘法方案，需同步 5.0 文档中的成本/收益公式，保持**配置↔文档**一致。

---

## 3. MVP 里程碑

| 里程碑 | 目标 | 关键交付 |
|--------|------|-----------|
| **MVP-1: 打通流水线** | CRP 计算 + 环境 NPV + 月度收益 + 评分器 + 最小调度 | 30 个月仿真跑通并生成月报 |
| **MVP-2: 约束与稳健** | 接入预算中间件、协作奖励；完善冲突/裁剪 | 预算软约束效果验证，协作奖励可配 |
| **MVP-3: 细化场景** | 插拔式地价 / 河流 / 邻近三大动态项；参数调优 | 不同场景参数集 + 性能基准报告 |

---

> **开发原则**：先查配置 → 用契约传参 → 新功能建模块 → 控制层只调度 → 不动基石。
