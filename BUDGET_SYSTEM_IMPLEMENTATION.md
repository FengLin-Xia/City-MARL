# Budgeté¢„ç®—ç³»ç»Ÿå®ç°æ€»ç»“

**å®ç°æ—¥æœŸï¼š** 2025-10-09  
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ  
**ç‰ˆæœ¬ï¼š** v1.0

---

## ğŸ“‹ å®ç°æ¸…å•

### âœ… Phase 1: åŸºç¡€å®ç°

#### 1. é…ç½®æ–‡ä»¶ä¿®æ”¹
**æ–‡ä»¶ï¼š** `configs/city_config_v4_1.json`

æ·»åŠ äº†å®Œæ•´çš„`budget_system`é…ç½®èŠ‚ï¼š
```json
{
  "budget_system": {
    "enabled": true,
    "mode": "soft_constraint",
    "initial_budgets": {
      "IND": 5000,
      "EDU": 4000
    },
    "debt_penalty_coef": 0.5,
    "max_debt": -2000,
    "monthly_grant": 0,
    "bankruptcy_threshold": -5000,
    "bankruptcy_penalty": -100.0,
    "budget_in_observation": true,
    "normalize_budget": true,
    "budget_norm_range": [-2000, 10000]
  }
}
```

#### 2. ç¯å¢ƒç±»ä¿®æ”¹
**æ–‡ä»¶ï¼š** `envs/v4_1/city_env.py`

**æ–°å¢å±æ€§ï¼š**
- `self.budget_cfg`: Budgeté…ç½®å­—å…¸
- `self.budgets`: å„æ™ºèƒ½ä½“å½“å‰é¢„ç®—
- `self.budget_history`: å„æ™ºèƒ½ä½“é¢„ç®—å†å²è®°å½•

**ä¿®æ”¹æ–¹æ³•ï¼š**

1. **`__init__`** (lines 41-49)
   - åŠ è½½Budgeté…ç½®
   - åˆå§‹åŒ–é¢„ç®—å’Œå†å²è®°å½•
   - æ‰“å°å¯ç”¨çŠ¶æ€

2. **`reset()`** (lines 168-172)
   - é‡ç½®é¢„ç®—åˆ°åˆå§‹å€¼
   - æ¸…ç©ºå†å²è®°å½•

3. **`_calculate_reward()`** (lines 380-401)
   - æ›´æ–°é¢„ç®—ï¼ˆæ‰£é™¤costï¼Œå¢åŠ rewardï¼‰
   - è®¡ç®—è´Ÿå€ºæƒ©ç½š
   - æ£€æµ‹ç ´äº§
   - è®°å½•å†å²
   - å°†budget_penaltyçº³å…¥æ€»å¥–åŠ±

#### 3. è®­ç»ƒè„šæœ¬ä¿®æ”¹
**æ–‡ä»¶ï¼š** `enhanced_city_simulation_v4_1.py`

**ä¿®æ”¹å‡½æ•°ï¼š**

1. **`train_rl_model()`** (lines 725-746)
   - æ”¶é›†ç¯å¢ƒçš„budget_history
   - æ·»åŠ åˆ°è¿”å›ç»“æœä¸­

2. **`evaluate_rl_model()`** (lines 346-361)
   - æ”¶é›†ç¯å¢ƒçš„budget_history
   - æ·»åŠ åˆ°è¿”å›ç»“æœä¸­

3. **`main()`** (lines 856-872)
   - ä¿å­˜è®­ç»ƒç»“æœåˆ°JSONæ–‡ä»¶
   - åŒ…å«budget_historyæ•°æ®

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬
**æ–‡ä»¶ï¼š** `test_budget_system.py`

**æµ‹è¯•å†…å®¹ï¼š**
1. âœ… é…ç½®åŠ è½½æ­£ç¡®
2. âœ… Budgetåˆå§‹åŒ–æ­£ç¡®
3. âœ… Budgetæ›´æ–°é€»è¾‘æ­£ç¡®ï¼ˆæ‰£costã€åŠ rewardï¼‰
4. âœ… è´Ÿå€ºæƒ©ç½šè®¡ç®—æ­£ç¡®
5. âœ… ç ´äº§æ£€æµ‹æ­£ç¡®
6. âœ… å†å²è®°å½•æ­£ç¡®

**æµ‹è¯•ç»“æœï¼š**
```
[PASS] Budgetå·²åˆå§‹åŒ–
[PASS] Budgetæ›´æ–°æ­£ç¡®
[PASS] è´Ÿå€ºæ£€æµ‹æˆåŠŸï¼ˆbudget=-1780.0ï¼‰
[PASS] è´Ÿå€ºæƒ©ç½šç”Ÿæ•ˆï¼ˆrewardä¸ºè´Ÿï¼‰
[PASS] Budgetå†å²è®°å½•æ­£ç¡®
```

---

## ğŸ“Š å¯è§†åŒ–å·¥å…·

### å¯è§†åŒ–è„šæœ¬
**æ–‡ä»¶ï¼š** `visualize_budget_history.py`

**åŠŸèƒ½ï¼š**
1. åŠ è½½è®­ç»ƒç»“æœJSONæ–‡ä»¶
2. ç»˜åˆ¶4ä¸ªå­å›¾ï¼š
   - Budgetéšæ—¶é—´å˜åŒ–æ›²çº¿
   - Budgetåˆ†å¸ƒç›´æ–¹å›¾
   - Budgetç»Ÿè®¡æŸ±çŠ¶å›¾ï¼ˆMean/Min/Max/Finalï¼‰
   - è´Ÿå€ºåˆ†æå›¾ï¼ˆè´Ÿå€ºæ¯”ä¾‹ã€æœ€å¤§è´Ÿå€ºï¼‰
3. æ‰“å°è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯

**ä½¿ç”¨æ–¹æ³•ï¼š**
```bash
python visualize_budget_history.py
```

---

## ğŸ”§ æ ¸å¿ƒæœºåˆ¶

### è½¯çº¦æŸé¢„ç®—æ¨¡å¼

#### é¢„ç®—æ›´æ–°å…¬å¼
```python
budget[agent] -= action.cost        # æ‰£é™¤å»ºé€ æˆæœ¬
budget[agent] += action.reward      # å¢åŠ æœˆåº¦æ”¶ç›Š
```

#### è´Ÿå€ºæƒ©ç½šå…¬å¼
```python
if budget[agent] < 0:
    debt_penalty = abs(budget[agent]) * debt_penalty_coef
    total_reward -= debt_penalty
```

#### ç ´äº§æ£€æµ‹
```python
if budget[agent] < bankruptcy_threshold:
    bankruptcy_penalty = abs(bankruptcy_penalty_value)
    budget_penalty += bankruptcy_penalty
```

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç­–ç•¥å¤šæ ·æ€§
- **æ¿€è¿›å‹ç­–ç•¥ï¼š** æ—©æœŸå¤§é‡æŠ•èµ„Lå‹å»ºç­‘ï¼ŒçŸ­æœŸè´Ÿå€ºï¼Œé•¿æœŸé«˜æ”¶ç›Š
- **ç¨³å¥å‹ç­–ç•¥ï¼š** é€æ­¥å»ºè®¾Må‹å»ºç­‘ï¼Œä¿æŒé¢„ç®—å¥åº·
- **æ··åˆå‹ç­–ç•¥ï¼š** INDæ¿€è¿›ï¼ŒEDUç¨³å¥ï¼Œå¹³è¡¡é£é™©

### è®­ç»ƒæŒ‡æ ‡
- **æ¢ç´¢ç¨‹åº¦ï¼š** â¬†ï¸ å¢åŠ ï¼ˆæ•¢äºå°è¯•é«˜æˆæœ¬å»ºç­‘ï¼‰
- **ç­–ç•¥å¤šæ ·æ€§ï¼š** â¬†ï¸ å¢åŠ ï¼ˆä¸åŒepisodeé‡‡ç”¨ä¸åŒç­–ç•¥ï¼‰
- **Lå‹å»ºç­‘å æ¯”ï¼š** â¬†ï¸ é¢„è®¡æå‡30%+
- **æœ€ç»ˆæ”¶ç›Šï¼š** â¬†ï¸ é¢„è®¡æå‡20%+

---

## ğŸ¯ é…ç½®å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | è°ƒä¼˜å»ºè®® |
|-----|--------|------|---------|
| `initial_budgets.IND` | 5000 | INDåˆå§‹é¢„ç®— | å¦‚æœç ´äº§ç‡é«˜ï¼Œå¢åŠ åˆ°6000-7000 |
| `initial_budgets.EDU` | 4000 | EDUåˆå§‹é¢„ç®— | å¦‚æœç ´äº§ç‡é«˜ï¼Œå¢åŠ åˆ°5000-6000 |
| `debt_penalty_coef` | 0.5 | è´Ÿå€ºæƒ©ç½šç³»æ•° | å¦‚æœè¿‡åº¦ä¿å®ˆï¼Œé™ä½åˆ°0.2-0.3 |
| `bankruptcy_threshold` | -5000 | ç ´äº§é˜ˆå€¼ | å¦‚æœé¢‘ç¹ç ´äº§ï¼Œé™ä½åˆ°-7000 |
| `bankruptcy_penalty` | -100.0 | ç ´äº§æƒ©ç½š | å¦‚æœç ´äº§ç‡é«˜ï¼Œå¢åŠ åˆ°-200.0 |

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. å¯ç”¨Budgetç³»ç»Ÿ
åœ¨ `city_config_v4_1.json` ä¸­è®¾ç½®ï¼š
```json
"budget_system": {
  "enabled": true
}
```

### 2. è®­ç»ƒæ¨¡å‹
```bash
python enhanced_city_simulation_v4_1.py --mode rl
```

### 3. æŸ¥çœ‹Budgetå†å²
è®­ç»ƒå®Œæˆåï¼Œä¼šè‡ªåŠ¨ä¿å­˜åˆ°ï¼š
```
models/v4_1_rl/training_results_YYYYMMDD_HHMMSS.json
```

### 4. å¯è§†åŒ–åˆ†æ
```bash
python visualize_budget_history.py
```

---

## ğŸ“ ä»£ç ç¤ºä¾‹

### æŸ¥çœ‹å½“å‰é¢„ç®—
```python
from envs.v4_1.city_env import CityEnvironment

env = CityEnvironment(cfg)
env.reset()

print(f"INDé¢„ç®—: {env.budgets['IND']}")
print(f"EDUé¢„ç®—: {env.budgets['EDU']}")
```

### æŸ¥çœ‹é¢„ç®—å†å²
```python
# è®­ç»ƒå
print(f"INDé¢„ç®—å†å²: {env.budget_history['IND']}")
print(f"EDUé¢„ç®—å†å²: {env.budget_history['EDU']}")
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç ´äº§ç‡ç›‘æ§
å¦‚æœè®­ç»ƒä¸­å‡ºç°å¤§é‡ç ´äº§ï¼ˆepisodeæå‰ç»ˆæ­¢ï¼‰ï¼Œéœ€è¦ï¼š
- å¢åŠ `initial_budgets`
- é™ä½`debt_penalty_coef`
- è°ƒæ•´`bankruptcy_threshold`

### 2. è¿‡åº¦ä¿å®ˆ
å¦‚æœæ™ºèƒ½ä½“è¿‡äºä¿å®ˆï¼ˆåªå»ºSå‹å»ºç­‘ï¼‰ï¼Œéœ€è¦ï¼š
- é™ä½`debt_penalty_coef`ï¼ˆ0.5 â†’ 0.2ï¼‰
- å¢åŠ `initial_budgets`
- æ£€æŸ¥å¥–åŠ±å‡½æ•°æ˜¯å¦åˆç†

### 3. è®­ç»ƒä¸ç¨³å®š
å¦‚æœè®­ç»ƒè¿‡ç¨‹ä¸­å¥–åŠ±æ³¢åŠ¨å‰§çƒˆï¼Œéœ€è¦ï¼š
- è°ƒæ•´å¥–åŠ±ç¼©æ”¾å› å­ï¼ˆå½“å‰ä¸º /100.0ï¼‰
- å¢åŠ `rollout_steps`æ”¶é›†æ›´å¤šç»éªŒ
- é™ä½å­¦ä¹ ç‡

---

## ğŸ”„ åç»­ä¼˜åŒ–æ–¹å‘

### v1.1: åŠ¨æ€é¢„ç®—
- æ ¹æ®åŸå¸‚å‘å±•é˜¶æ®µè°ƒæ•´åˆå§‹é¢„ç®—
- å¼•å…¥"æ”¿ç­–çº¢åˆ©"ï¼ˆç‰¹å®šæ¡ä»¶ä¸‹é¢å¤–æ‹¨æ¬¾ï¼‰

### v1.2: é¢„ç®—é¢„æµ‹
- æ™ºèƒ½ä½“é¢„æµ‹æœªæ¥Nä¸ªæœˆçš„é¢„ç®—å˜åŒ–
- åŸºäºé¢„æµ‹è¿›è¡Œé•¿æœŸè§„åˆ’

### v1.3: å¤šç›®æ ‡ä¼˜åŒ–
- åŒæ—¶ä¼˜åŒ–ï¼šæ€»æ”¶ç›Šã€é¢„ç®—å¥åº·åº¦ã€å»ºç­‘å¤šæ ·æ€§
- Paretoå‰æ²¿åˆ†æ

---

## âœ… éªŒæ”¶æ ‡å‡†

### å¿…é¡»æ»¡è¶³ âœ…
- [x] é…ç½®æ–‡ä»¶æ­£ç¡®è§£æ
- [x] é¢„ç®—æ›´æ–°é€»è¾‘æ— bug
- [x] è®­ç»ƒè¿‡ç¨‹ä¸å´©æºƒ
- [x] é¢„ç®—å†å²æ­£ç¡®è®°å½•
- [x] æµ‹è¯•è„šæœ¬å…¨éƒ¨é€šè¿‡

### åº”è¯¥æ»¡è¶³ ğŸ¯
- [ ] ç­–ç•¥å¤šæ ·æ€§æå‡ > 30%
- [ ] Lå‹å»ºç­‘å æ¯”æå‡ > 20%
- [ ] æœ€ç»ˆæ”¶ç›Šæå‡ > 10%

### å¯ä»¥æ»¡è¶³ ğŸŒŸ
- [ ] å‡ºç°3ç§ä»¥ä¸Šæ˜æ˜¾ä¸åŒçš„ç­–ç•¥
- [ ] é¢„ç®—æ›²çº¿ç¬¦åˆç»æµå­¦ç›´è§‰
- [ ] è®­ç»ƒé€Ÿåº¦ä¸‹é™ < 20%

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶
- `configs/city_config_v4_1.json` - Budgeté…ç½®
- `envs/v4_1/city_env.py` - Budgeté€»è¾‘å®ç°
- `enhanced_city_simulation_v4_1.py` - è®­ç»ƒè„šæœ¬

### æµ‹è¯•æ–‡ä»¶
- `test_budget_system.py` - å•å…ƒæµ‹è¯•
- `visualize_budget_history.py` - å¯è§†åŒ–å·¥å…·

### æ–‡æ¡£æ–‡ä»¶
- `BUDGET_SYSTEM_PRD.md` - PRDæ–‡æ¡£
- `BUDGET_SYSTEM_IMPLEMENTATION.md` - æœ¬æ–‡æ¡£

---

## ğŸ‰ æ€»ç»“

Budgeté¢„ç®—ç³»ç»Ÿå·²æˆåŠŸå®ç°ï¼ŒåŒ…æ‹¬ï¼š
1. âœ… å®Œæ•´çš„é…ç½®ç³»ç»Ÿ
2. âœ… é¢„ç®—è¿½è¸ªå’Œæ›´æ–°é€»è¾‘
3. âœ… è´Ÿå€ºæƒ©ç½šæœºåˆ¶
4. âœ… ç ´äº§æ£€æµ‹
5. âœ… å†å²è®°å½•
6. âœ… æµ‹è¯•éªŒè¯
7. âœ… å¯è§†åŒ–å·¥å…·

ç³»ç»Ÿå·²å‡†å¤‡å¥½è¿›è¡Œè®­ç»ƒå’Œè¯„ä¼°ï¼

---

**å®ç°è€…ï¼š** AI Assistant  
**å®¡æ ¸è€…ï¼š** Fenglin  
**æœ€åæ›´æ–°ï¼š** 2025-10-09




