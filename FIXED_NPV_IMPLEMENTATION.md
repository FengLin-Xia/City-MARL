# å›ºå®šNPV Rewardæœºåˆ¶å®æ–½æ€»ç»“

## âœ… å®æ–½å®Œæˆ

**æ ¸å¿ƒæ”¹é€ **ï¼šå°†rewardä»"æœˆåº¦æ”¶ç›Šç´¯ç§¯"æ”¹ä¸º"å›ºå®šNPV"

---

## ğŸ¯ è§£å†³çš„é—®é¢˜

### é—®é¢˜ï¼šEpisode 2å°±å›ºå®šåœ¨90.0

**æ ¹æœ¬åŸå› **ï¼š
```python
# æ—§æœºåˆ¶
reward = monthly_income - build_cost

åæœŸï¼šmonthly_income=1500, build_cost=1010
  å»ºé€ : 1500 - 1010 = 490
  ä¸å»ºé€ : 1500 - 0 = 1500 (æ›´é«˜ï¼)
  
â†’ RLå­¦åˆ°ï¼š"å»º10ä¸ªåèººå¹³"
â†’ Returnå›ºå®š90.0
```

**æ–°æœºåˆ¶**ï¼š
```python
# å›ºå®šNPV
if å»ºé€ :
    reward = (action.reward * 12) - action.cost
else:
    reward = 0

å»ºé€ : 162*12 - 1010 = 934
ä¸å»ºé€ : 0

â†’ RLå­¦åˆ°ï¼š"å¿…é¡»æŒç»­å»ºé€ "
â†’ Returnåº”è¯¥æŒç»­æå‡
```

---

## ğŸ”§ ä»£ç ä¿®æ”¹

### 1. é…ç½®å‚æ•°ï¼ˆconfigs/city_config_v4_1.jsonï¼‰

```json
{
  "solver": {
    "rl": {
      "reward_scale": 3000.0,      // ä»2000æé«˜åˆ°3000
      "expected_lifetime": 12,     // æ–°å¢ï¼šå›ºå®šå›æŠ¥æœŸ
      "reward_clip": 1.0,
      // ...
    }
  }
}
```

### 2. Rewardè®¡ç®—ï¼ˆenvs/v4_1/city_env.pyï¼‰

**æ ¸å¿ƒé€»è¾‘**ï¼š
```python
def _calculate_reward(self, agent, action):
    build_cost = action.cost
    
    if build_cost > 0:  # å»ºé€ 
        # å›ºå®šå›æŠ¥æœŸçš„æœªæ¥æ”¶ç›Š
        expected_lifetime = 12
        future_income = action.reward * expected_lifetime
        
        # NPV
        npv = future_income - build_cost
        
        # Total
        reward = npv + progress - budget_penalty
    else:  # ä¸å»ºé€ 
        reward = 0
    
    return reward / 3000.0
```

**å…³é”®å˜åŒ–**ï¼š
- âŒ ä¸å†ä½¿ç”¨`monthly_income`ï¼ˆè¢«åŠ¨æ”¶ç›Šï¼‰
- âœ… åªç”¨`action.reward * lifetime`ï¼ˆä¸»åŠ¨ä»·å€¼ï¼‰
- âœ… ä¸å»ºé€  = 0ï¼ˆä¸é¼“åŠ±èººå¹³ï¼‰

### 3. Budgetç´¯ç§¯ï¼ˆä¿æŒä¸å˜ï¼‰

```python
# åœ¨_advance_turn()ä¸­
for agent in agents:
    monthly_income = self._calculate_monthly_income(agent)
    budget += monthly_income  # âœ… ä»ç„¶ç´¯ç§¯

# Budgetåæ˜ çœŸå®ç°é‡‘æµï¼ˆä¸å˜ï¼‰
```

---

## ğŸ“Š Rewardç»“æ„å¯¹æ¯”

### å„Sizeçš„Rewardï¼ˆprogress=5ï¼‰

| Size | Cost | Monthly | Future(12æœˆ) | NPV | Bonus | Total | Scaled |
|------|------|---------|-------------|-----|-------|-------|--------|
| **S** | 1010 | 162 | 1944 | 934 | 0 | 939 | **0.31** |
| **M** | 1500 | 210 | 2520 | 1020 | 1000 | 2025 | **0.68** |
| **L** | 2400 | 276 | 3312 | 912 | 2000 | 2917 | **0.97** |

**Skip**: reward = 0

**å…³é”®æ´å¯Ÿ**ï¼š
- âœ… Lå‹rewardæœ€é«˜ï¼ˆ0.97ï¼‰
- âœ… æ‰€æœ‰å»ºé€ éƒ½ä¼˜äºskipï¼ˆ>0ï¼‰
- âœ… Scaledåœ¨[-1, 1]èŒƒå›´å†…

---

## ğŸ”„ æœºåˆ¶å®Œæ•´æµç¨‹

### Episodeæ‰§è¡Œç¤ºä¾‹

```
Month 0 (IND):
  1. è®¡ç®—reward: NPV(Så‹) = 162*12-1010 = 934
  2. Scaled: 934/3000 = 0.31
  3. å»ºé€  â†’ active_assets += 1
  4. Budget -= 1010

Month 1 (_advance_turn):
  - Budget += monthly_income(IND) = 162  âœ… çœŸå®æ”¶ç›Š
  - Budget += monthly_income(EDU) = 0
  
Month 1 (EDU):
  1. è®¡ç®—reward: NPV(Så‹) = 162*12-700 = 1244
  2. Scaled: 1244/3000 = 0.41
  3. å»ºé€  â†’ active_assets += 1
  4. Budget -= 700

Month 2 (_advance_turn):
  - Budget(IND) += 162  âœ… æŒç»­æ”¶ç›Š
  - Budget(EDU) += 162  âœ… æŒç»­æ”¶ç›Š
  
...

Month 10 (INDå·²æœ‰5ä¸ªå»ºç­‘):
  - Budgetå¾ˆå¥åº·ï¼ˆå› ä¸ºmonthly_incomeç´¯ç§¯ï¼‰
  - å»ºé€ reward = 934 (å›ºå®šï¼ä¸å˜ï¼)
  - ä¸å»ºé€ reward = 0
  â†’ ä»ç„¶é¼“åŠ±å»ºé€ 

Month 29 (æ¥è¿‘ç»“æŸ):
  - å»ºé€ reward = 934 (ä»ç„¶å›ºå®šï¼)
  - Budgetä»ç„¶å¢é•¿
  â†’ ä»ç„¶é¼“åŠ±å»ºé€ 
```

---

## âœ… ä¼˜åŠ¿

### 1. **è§£å†³"èººå¹³"é—®é¢˜** âœ…
```
æ—§: åæœŸä¸å»ºé€ reward=1500 â†’ èººå¹³æœ€ä¼˜
æ–°: ä¸å»ºé€ reward=0, å»ºé€ reward=934 â†’ å»ºé€ æœ€ä¼˜
```

### 2. **é¼“åŠ±M/Lå‹** âœ…
```
Lå‹scaled reward = 0.97ï¼ˆæœ€é«˜ï¼‰
Må‹scaled reward = 0.68
Så‹scaled reward = 0.31
```

### 3. **Rewardç¨³å®š** âœ…
```
æ— è®ºå“ªä¸ªæœˆå»ºé€ ï¼Œrewardéƒ½ä¸€æ ·
â†’ Value Functionå®¹æ˜“å­¦ä¹ 
â†’ Value Lossåº”è¯¥<1000
```

### 4. **BudgetçœŸå®** âœ…
```
Budgetä»ç„¶æ¯æœˆç´¯ç§¯æ”¶ç›Š
â†’ ç»æµå¯æŒç»­
â†’ ä¸ä¼šç ´äº§
```

---

## ğŸ“ˆ é¢„æœŸè®­ç»ƒæ•ˆæœ

### Episode 1-10
```
Return: 100-200ï¼ˆæ³¢åŠ¨ï¼Œä¸å›ºå®šï¼‰
å»ºç­‘æ•°é‡: 40-60ä¸ªï¼ˆæ›´å¤šï¼‰
Size: å¼€å§‹æ¢ç´¢M/Lå‹
Value Loss: 500-1000
KL: 0.5-2.0
```

### Episode 20-30
```
Return: 150-250
å»ºç­‘æ•°é‡: 60-90ä¸ª
Size: S 40-50%, M 20-30%, L 20-30%
Value Loss: 100-300
KL: 0.1-0.5
```

---

## ğŸš€ æµ‹è¯•è®¡åˆ’

### **å…ˆæµ‹è¯•5 episodes**

```bash
python enhanced_city_simulation_v4_1.py --mode rl
```

**è§‚å¯Ÿ**ï¼š
1. Returnæ˜¯å¦>100ï¼ˆä¸æ˜¯å›ºå®š90ï¼‰
2. å»ºç­‘æ•°é‡æ˜¯å¦>40
3. æ˜¯å¦å‡ºç°M/Lå‹
4. Value Lossæ˜¯å¦<1000

**å¦‚æœé€šè¿‡** â†’ ç»§ç»­è®­ç»ƒåˆ°30
**å¦‚æœä¸é€šè¿‡** â†’ å†åˆ†æè°ƒæ•´

---

## ğŸ“ å…³é”®ç‚¹æ€»ç»“

**å›ºå®šNPVæœºåˆ¶ = æ‘Šé”€æ³•çš„è¿›åŒ–ç‰ˆ**

- âœ… ä¿ç•™äº†æœˆåº¦æ”¶ç›Šç´¯ç§¯ï¼ˆbudgetçœŸå®ï¼‰
- âœ… ä¿®å¤äº†"èººå¹³"é—®é¢˜ï¼ˆä¸å»ºé€ =0ï¼‰
- âœ… é¼“åŠ±å¤§å»ºç­‘ï¼ˆLå‹rewardæœ€é«˜ï¼‰
- âœ… Rewardç¨³å®šï¼ˆå®¹æ˜“å­¦ä¹ ï¼‰

**vs çº¯æœˆåº¦æ”¶ç›Š**ï¼š
- Rewardä¸åŒ…å«"è¢«åŠ¨æ”¶ç›Š"
- åªè¯„ä¼°"è¿™æ¬¡å»ºé€ "çš„ä»·å€¼
- æ›´ç¬¦åˆ"action value"çš„è¯­ä¹‰

---

**å®æ–½æ—¥æœŸ**: 2025-10-12  
**çŠ¶æ€**: âœ… ä»£ç å·²ä¿®æ”¹ï¼Œé…ç½®å·²æ›´æ–°  
**ä¸‹ä¸€æ­¥**: æµ‹è¯•è®­ç»ƒ5-10 episodes



