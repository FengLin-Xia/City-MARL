{
    "schema_version": "5.0.0",
    "scenario_name": "default_city_v5_numeric",
    "description": "Reinforcement learning city simulation (numeric-action version)",
    "paths": {
        "slots_txt": "./slots_with_angle.txt",
        "river_geojson": "./data/river.geojson",
        "adj_graph": "./data/city.graphml",
        "outputs_dir": "./outputs",
        "checkpoints_dir": "./checkpoints",
        "logs_dir": "./logs"
    },
    "seeds": {
        "global": 42,
        "env": 123,
        "policy": 456,
        "dataloader": 789
    },
    "land_price": {
        "gaussian_system": {
            "meters_per_pixel": 2.0,
            "hub_sigma_base_m": 32,
            "road_sigma_base_m": 20,
            "hub_peak_value": 1.0,
            "road_peak_value": 0.6,
            "min_threshold": 0.04,
            "alpha_inertia": 0.25,
            "hub_growth_rate": 0.03,
            "road_growth_rate": 0.02,
            "max_hub_multiplier": 2.0,
            "max_road_multiplier": 2.5,
            "extra_hub_point_peak": 1.2,
            "extra_hub_point_sigma_px": 6.0,
            "fusion_mode": "weighted_sum",
            "fusion_weights": {
                "hub": 0.8,
                "road": 0.4,
                "river": 0.8,
                "build": 0.2
            },
            "component_normalize": true,
            "fusion_normalize": "minmax"
        },
        "evolution": {
            "enabled": true,
            "road_activation_month": 0,
            "hub_activation_month": 7,
            "hub_growth_duration_months": 6,
            "hub_initial_peak": 0.7,
            "hub_final_peak": 1.0
        }
    },
    "slots": {
        "source": "file",
        "path": "${paths.slots_txt}",
        "adjacency": "4-neighbor"
    },
    "city": {
        "map_size": [
            200,
            200
        ],
        "transport_hubs": [
            [
                122,
                80
            ],
            [
                112,
                121
            ]
        ]
    },
    "hubs": {
        "mode": "explicit",
        "candidate_mode": "cumulative",
        "tol": 0.5,
        "list": [
            {
                "id": "hub1",
                "x": 122,
                "y": 80,
                "R0": 5,
                "dR": 1.5,
                "weight": 0.5
            },
            {
                "id": "hub2",
                "x": 112,
                "y": 121,
                "R0": 2,
                "dR": 1.5,
                "weight": 0.5
            }
        ]
    },
    "env": {
        "time_model": {
            "step_unit": "month",
            "total_steps": 30
        },
        "land_price": {
            "base": 1.0,
            "river_multiplier": 1.2,
            "hub_multiplier": 1.3
        },
        "coordinates": {
            "default_z": 0.0,
            "z_management": "fixed"
        },
        "river_premium": {
            "RiverPmax_pct": {
                "IND": 20.0,
                "EDU": 25.0
            },
            "RiverPmax_pct_EDU_by_size": {
                "A": 30,
                "B": 35,
                "C": 32
            },
            "RiverD_half_m": 120.0,
            "RiverPremiumCap_kGBP": 10000.0
        },
        "river_restrictions": {
            "enabled": true,
            "affects_agents": [
                "IND",
                "EDU"
            ],
            "council_bypass": true,
            "river_side_assignment": {
                "method": "hub_based",
                "fallback": "random",
                "hub_side_mapping": {
                    "hub1": "north",
                    "hub2": "south"
                }
            },
            "connectivity_check": {
                "enabled": true,
                "algorithm": "flood_fill",
                "max_distance": 200.0
            }
        },
        "base_environment": {
            "import_slots": "${paths.slots_txt}",
            "import_river": "${paths.river_geojson}"
        }
    },
    "agents": {
        "order": [
            "IND",
            "EDU",
            "COUNCIL"
        ],
        "defs": {
            "EDU": {
                "action_ids": [
                    0,
                    1,
                    2
                ],
                "obs_pack": [
                    "geo",
                    "history"
                ],
                "constraints": {
                    "max_actions_per_turn": 1,
                    "budget_limit": 0,
                    "budget_sharing": "EDU_COUNCIL_SHARED"
                }
            },
            "IND": {
                "action_ids": [
                    3,
                    4,
                    5
                ],
                "obs_pack": [
                    "geo",
                    "demand",
                    "history"
                ],
                "constraints": {
                    "max_actions_per_turn": 2,
                    "budget_limit": 15000
                }
            },
            "COUNCIL": {
                "action_ids": [
                    6,
                    7,
                    8
                ],
                "obs_pack": [
                    "geo",
                    "network"
                ],
                "constraints": {
                    "max_actions_per_turn": 1,
                    "budget_limit": 0,
                    "budget_sharing": "EDU_COUNCIL_SHARED",
                    "special_rules": {
                        "river_bypass": true,
                        "start_after_month": 6,
                        "other_side_bonus": {
                            "A": 70.0,
                            "B": 90.0,
                            "C": 110.0
                        },
                        "proximity_scale": {
                            "A": 0.12,
                            "B": 0.1,
                            "C": 0.1
                        }
                    }
                }
            }
        }
    },
    "action_params": {
        "0": {
            "desc": "EDU_S",
            "cost": 650,
            "reward": 160,
            "prestige": 0.2
        },
        "1": {
            "desc": "EDU_M",
            "cost": 1150,
            "reward": 530,
            "prestige": 0.6
        },
        "2": {
            "desc": "EDU_L",
            "cost": 2700,
            "reward": 360,
            "prestige": 1.0
        },
        "3": {
            "desc": "IND_S",
            "cost": 900,
            "reward": 150,
            "prestige": 0.2
        },
        "4": {
            "desc": "IND_M",
            "cost": 1500,
            "reward": 280,
            "prestige": 0.1
        },
        "5": {
            "desc": "IND_L",
            "cost": 2400,
            "reward": 450,
            "prestige": -0.1
        },
        "6": {
            "desc": "COUNCIL_A",
            "cost": 570,
            "reward": 570,
            "prestige": 0.3
        },
        "7": {
            "desc": "COUNCIL_B",
            "cost": 870,
            "reward": 870,
            "prestige": 0.7
        },
        "8": {
            "desc": "COUNCIL_C",
            "cost": 1150,
            "reward": 1150,
            "prestige": 1.2
        }
    },
    "relations": {
        "across_river": {
            "type": "pairs_true",
            "zones": [
                "ZoneA",
                "ZoneB",
                "ZoneC",
                "ZoneD"
            ],
            "pairs_true": [
                [
                    "ZoneA",
                    "ZoneC"
                ],
                [
                    "ZoneB",
                    "ZoneD"
                ]
            ]
        },
        "adjacency": {
            "source": "graphml",
            "path": "${paths.adj_graph}",
            "distance_threshold": 200.0
        },
        "groups": {
            "hubs": [
                "Hub1",
                "Hub2"
            ]
        }
    },
    "budget_pools": {
        "EDU_COUNCIL_SHARED": {
            "members": [
                "EDU",
                "COUNCIL"
            ],
            "total_budget": 20000,
            "allocation_strategy": "dynamic"
        }
    },
    "ledger": {
        "initial_budget": {
            "IND": 15000,
            "EDU": 20000,
            "COUNCIL": 20000
        },
        "share_matrix": [],
        "carryover": {
            "enabled": true,
            "ratio": 1.0
        },
        "overdraft": {
            "enabled": true,
            "interest": 0.1,
            "penalty": 100.0
        },
        "bankruptcy_threshold": -5000,
        "bankruptcy_policy": "skip_turn"
    },
    "constraints": {
        "zoning_rules": {
            "enabled": true
        },
        "sequence": {
            "max_len": 5,
            "dedup": true,
            "max_candidates": 50
        },
        "conflict_policy": "drop_late",
        "caps": {
            "max_actions_per_step": 5,
            "per_zone_month_cap": 3
        },
        "advance_policy": "advance_if_empty"
    },
    "evaluation": {
        "proximity_threshold": 15.0,
        "proximity_reward": 900.0,
        "distance_penalty_coef": 0.6,
        "size_bonus": {
            "S": 0,
            "M": 0,
            "L": 0
        },
        "council": {
            "enabled": true,
            "river_bypass": true,
            "proximity_strategy": "independent",
            "skip_if_no_candidates": true,
            "start_after_month": 6,
            "size_bonus": {
                "A": 2550,
                "B": 3550,
                "C": 4050
            },
            "other_side_bonus": {
                "A": 70.0,
                "B": 90.0,
                "C": 110.0
            },
            "proximity_scale": {
                "A": 0.12,
                "B": 0.1,
                "C": 0.1
            }
        }
    },
    "reward_mechanisms": {
        "npv_calculation": {
            "enabled": true,
            "expected_lifetime": 12,
            "discount_rate": 0.05
        },
        "progress_reward": {
            "enabled": true,
            "building_count_multiplier": 0.5,
            "agents": {
                "EDU": {
                    "building_type": "public"
                },
                "IND": {
                    "building_type": "industrial"
                }
            }
        },
        "cooperation_reward": {
            "enabled": true,
            "lambda": 0.1,
            "functional_complement": {
                "edu_ind_bonus": 0.05,
                "ind_edu_bonus": 0.05
            },
            "spatial_coordination": {
                "optimal_distance_min": 5,
                "optimal_distance_max": 20,
                "coordination_bonus": 0.02
            }
        },
        "land_price_monetization": {
            "enabled": true,
            "land_price_base": 11,
            "edu_receives_land": true,
            "ind_pays_land": true
        },
        "river_premium": {
            "enabled": true,
            "river_half_distance": 120.0,
            "max_premium_cap": 10000.0,
            "premium_rates": {
                "IND": 0.2,
                "EDU": 0.15
            }
        },
        "operational_costs": {
            "enabled": true,
            "opex_rates": {
                "IND": {
                    "S": 100,
                    "M": 180,
                    "L": 300
                },
                "EDU": {
                    "S": 70,
                    "M": 120,
                    "L": 190
                }
            }
        },
        "rental_income": {
            "enabled": true,
            "rent_rates": {
                "S": 25,
                "M": 45,
                "L": 70
            },
            "edu_only": true
        },
        "proximity_reward": {
            "enabled": true,
            "proximity_threshold": 15.0,
            "proximity_reward": 900.0,
            "distance_penalty_coef": 0.6
        },
        "zone_multipliers": {
            "enabled": true,
            "m_zone": {
                "near": 1.2,
                "mid": 1.0,
                "far": 0.8
            },
            "m_adj": {
                "adjacent": 1.1,
                "non_adjacent": 1.0
            }
        },
        "land_price_sensitivity": {
            "enabled": true,
            "reward_lp_k": {
                "IND": 0.25,
                "EDU": 0.1
            }
        },
        "building_size_bonus": {
            "enabled": true,
            "size_bonus_rates": {
                "S": 0,
                "M": 0.1,
                "L": 0.2
            }
        },
        "reward_scaling": {
            "enabled": true,
            "reward_scale": 3000.0,
            "reward_clip": 1.0,
            "target_range": [
                -1.0,
                1.0
            ]
        }
    },
    "featurizers": {
        "enabled": [
            "geo",
            "demand",
            "history",
            "network"
        ],
        "norm": {
            "type": "standard",
            "stats_path": "./outputs/norm_stats.json"
        },
        "history_windows": {
            "diversity": 12,
            "demand": 6
        }
    },
    "rules": {
        "aggregation": {
            "clip": null,
            "normalize": false
        },
        "terms": [
            {
                "name": "revenue",
                "fn": "revenue.base",
                "weight": 1.0
            },
            {
                "name": "cost",
                "fn": "cost.base",
                "weight": -1.0
            },
            {
                "name": "prestige",
                "fn": "prestige.base",
                "weight": 0.2
            },
            {
                "name": "cross_river",
                "fn": "spatial.cross_river_bonus",
                "weight": 0.1
            },
            {
                "name": "adjacency",
                "fn": "spatial.adjacency_score",
                "weight": 0.1
            },
            {
                "name": "diversity",
                "fn": "stats.entropy_window",
                "weight": 0.05
            }
        ],
        "term_params": {
            "spatial.cross_river_bonus": {
                "bonus": 2.0
            },
            "spatial.adjacency_score": {
                "radius": 200.0,
                "same_type_bonus": 0.2,
                "mix_bonus": 0.1
            },
            "stats.entropy_window": {
                "window": 12,
                "epsilon": 1e-06
            }
        }
    },
    "scheduler": {
        "name": "phase_cycle",
        "params": {
            "step_unit": "month",
            "period": 1,
            "offset": 0,
            "phases": [
                {
                    "agents": [
                        "IND"
                    ],
                    "mode": "sequential"
                },
                {
                    "agents": [
                        "EDU",
                        "COUNCIL"
                    ],
                    "mode": "concurrent"
                }
            ]
        }
    },
    "action_mw": [
        "conflict.drop_late",
        "budget.shared_ledger",
        "legality.env",
        "river_restriction",
        "candidate_range",
        "sequence.trim_to_max_len"
    ],
    "mappo": {
        "net": {
            "obs_dim": 512,
            "share_encoder": true,
            "actor_hidden": [
                256,
                128
            ],
            "critic_hidden": [
                256,
                128
            ],
            "use_lstm": false
        },
        "ppo": {
            "clip_eps": 0.25,
            "gamma": 0.99,
            "gae_lambda": 0.8,
            "entropy_coef": 0.1,
            "value_coef": 0.5,
            "target_kl": 0.02,
            "max_grad_norm": 0.5,
            "lr": 0.0003,
            "lr_schedule": "cosine"
        },
        "rollout": {
            "num_envs": 8,
            "horizon": 20,
            "minibatch_size": 32,
            "updates_per_iter": 4,
            "max_updates": 999999
        },
        "exploration": {
            "temperature": 2.0,
            "anneal_to": 0.7,
            "anneal_steps": 200000
        }
    },
    "eval": {
        "frequency_steps": 5000,
        "episodes": 8,
        "seeds": [
            101,
            102,
            103,
            104
        ],
        "fixed_maps": [
            "map_A",
            "map_B"
        ]
    },
    "export": {
        "enabled": true,
        "every_n_episodes": 0
    },
    "reward_terms": {
        "enabled": true,
        "calculation_mode": "v4_1_compatible",
        "debug_mode": false,
        "precision": "float",
        "rounding_mode": "nearest",
        "components": {
            "land_price": true,
            "proximity": true,
            "river": true,
            "size_bonus": true
        },
        "land_price": {
            "LP_idx_min": 10,
            "LP_idx_max": 100,
            "LandPriceBase": 11.0,
            "RewardLP_k": {"IND": 0.25, "EDU": 0.10, "COUNCIL": 0.10}
        },
        "proximity": {
            "proximity_threshold": 10.0,
            "proximity_reward": 50.0,
            "distance_penalty_coef": 2.0,
            "proximity_scale_COUNCIL_by_action": {"6": 1.0, "7": 1.2, "8": 1.5}
        },
        "river": {
            "RiverD_half_m": 120.0,
            "RiverPmax_pct": {"IND": 20.0, "EDU": 15.0, "COUNCIL": 15.0},
            "RiverPremiumCap_kGBP": 10000.0
        },
        "size_bonus": {
            "0": 0, "1": 50, "2": 100,
            "3": 0, "4": 50, "5": 100,
            "6": 0, "7": 50, "8": 100
        }
    },
    "checkpointing": {
        "save_best_metric": "eval/return_mean",
        "save_every_steps": 10000,
        "max_to_keep": 5
    },
    "logging": {
        "enabled": true,
        "level": "INFO",
        "format": "plain",
        "sinks": {
            "console": true,
            "file": "${paths.logs_dir}/v5_0.log",
            "jsonl": false,
            "rotate": {
                "enabled": true,
                "max_bytes": 10485760,
                "backup_count": 3
            }
        },
        "modules": {
            "env": "INFO",
            "enumeration": "WARN",
            "trainer": "INFO",
            "exporter": "INFO",
            "reward": "WARN",
            "scheduler": "INFO",
            "budget": "INFO"
        },
        "topics": {
            "candidates": false,
            "river_filter": false,
            "occupied_slots": false,
            "export_coords": false,
            "reward_terms": false,
            "policy_select": true,
            "pipeline_traceback": false,
            "phase_switch": false,
            "budget_flow": false,
            "experience_collection": false,
            "training_step": false,
            "environment_step": false,
            "action_execution": false
        },
        "sampling": {
            "every_n_steps": 1,
            "sample_agents": [
                "IND",
                "EDU",
                "COUNCIL"
            ],
            "sample_months": []
        },
        "export": {
            "strict_slot_positions": true,
            "error_policy": "FAIL_FAST"
        }
    },
    "performance": {
        "device": "cuda",
        "amp": true,
        "num_workers": 4,
        "pin_memory": true
    },
    "validators": {
        "unique_action_ids": true,
        "non_negative_budget": true
    },
    "multi_action": {
        "enabled": true,
        "max_actions_per_step": 3,
        "mode": "two_stage",
        "candidate_topP": 64,
        "dup_policy": "no_repeat_point",
        "stop_bias": -0.2,
        "penalty_k": 0.05,
        "curriculum": {
            "enabled": true,
            "initial_max_k": 1,
            "final_max_k": 3,
            "increment_every_n_episodes": 50
        }
    }
}
