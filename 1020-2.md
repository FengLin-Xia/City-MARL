# v5.0 契约层设计文档

## 📋 概述

契约层(Contract Layer)是v5.0架构中的关键层，它定义了各模块之间的接口和约定，确保系统各组件能够正确协作，同时保持松耦合和高内聚的设计原则。

## 🎯 契约层的核心作用

1. **定义接口**: 各模块之间如何交互
2. **约定行为**: 每个模块应该做什么，不应该做什么
3. **数据契约**: 输入输出的数据格式和验证
4. **错误处理**: 异常情况的处理约定
5. **版本兼容**: 接口变更的兼容性管理

## 📋 契约层需要定义的内容

### 1. 环境契约 (Environment Contracts)

```python
# 环境接口契约
class EnvironmentContract:
    """环境模块的接口契约"""
    
    @abstractmethod
    def reset(self) -> EnvironmentState:
        """重置环境，返回初始状态"""
        pass
    
    @abstractmethod
    def step(self, actions: Dict[str, Action]) -> StepResult:
        """执行一步，返回结果"""
        pass
    
    @abstractmethod
    def get_observation(self, agent_id: str) -> Observation:
        """获取智能体观察"""
        pass
    
    @abstractmethod
    def is_done(self) -> bool:
        """检查是否结束"""
        pass
```

### 2. 智能体契约 (Agent Contracts)

```python
# 智能体接口契约
class AgentContract:
    """智能体模块的接口契约"""
    
    @abstractmethod
    def select_action(self, observation: Observation) -> Action:
        """选择动作"""
        pass
    
    @abstractmethod
    def update_policy(self, experiences: List[Experience]) -> None:
        """更新策略"""
        pass
    
    @abstractmethod
    def get_action_probabilities(self, observation: Observation) -> ActionProbabilities:
        """获取动作概率分布"""
        pass
```

### 3. 数据契约 (Data Contracts)

```python
# 数据格式契约
@dataclass
class EnvironmentState:
    """环境状态数据契约"""
    month: int
    land_prices: LandPriceField
    buildings: List[Building]
    budgets: Dict[str, float]
    slots: List[Slot]
    
    def validate(self) -> bool:
        """验证数据完整性"""
        assert self.month >= 0, "Month must be non-negative"
        assert all(budget >= 0 for budget in self.budgets.values()), "Budgets must be non-negative"
        return True

@dataclass
class Action:
    """动作数据契约"""
    agent_id: str
    action_type: str
    target_slot: Optional[Slot]
    parameters: Dict[str, Any]
    
    def validate(self) -> bool:
        """验证动作合法性"""
        assert self.agent_id in ["EDU", "IND", "COUNCIL"], "Invalid agent_id"
        assert self.action_type in ["BUILD", "SKIP"], "Invalid action_type"
        return True
```

### 4. 计算契约 (Computation Contracts)

```python
# 计算模块契约
class LandPriceCalculatorContract:
    """地价计算器接口契约"""
    
    @abstractmethod
    def calculate_land_prices(self, state: EnvironmentState) -> LandPriceField:
        """计算地价"""
        pass
    
    @abstractmethod
    def update_hub_influence(self, hubs: List[Hub]) -> None:
        """更新枢纽影响"""
        pass

class RewardCalculatorContract:
    """奖励计算器接口契约"""
    
    @abstractmethod
    def calculate_reward(self, action: Action, state: EnvironmentState) -> float:
        """计算奖励"""
        pass
    
    @abstractmethod
    def calculate_prestige(self, action: Action, state: EnvironmentState) -> float:
        """计算声望"""
        pass
```

### 5. 事件契约 (Event Contracts)

```python
# 事件系统契约
class EventContract:
    """事件接口契约"""
    
    @abstractmethod
    def emit(self, event_type: str, data: Dict[str, Any]) -> None:
        """发送事件"""
        pass
    
    @abstractmethod
    def subscribe(self, event_type: str, handler: Callable) -> None:
        """订阅事件"""
        pass
    
    @abstractmethod
    def unsubscribe(self, event_type: str, handler: Callable) -> None:
        """取消订阅"""
        pass

# 事件数据契约
@dataclass
class BuildingPlacedEvent:
    """建筑放置事件"""
    agent_id: str
    building_type: str
    slot_id: str
    timestamp: int
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "event_type": "building_placed",
            "agent_id": self.agent_id,
            "building_type": self.building_type,
            "slot_id": self.slot_id,
            "timestamp": self.timestamp
        }
```

### 6. 配置契约 (Configuration Contracts)

```python
# 配置验证契约
class ConfigurationValidator:
    """配置验证器契约"""
    
    @abstractmethod
    def validate_config(self, config: Dict[str, Any]) -> ValidationResult:
        """验证配置"""
        pass
    
    @abstractmethod
    def validate_action_params(self, action_params: Dict[str, Any]) -> bool:
        """验证动作参数"""
        pass
    
    @abstractmethod
    def validate_agent_config(self, agent_config: Dict[str, Any]) -> bool:
        """验证智能体配置"""
        pass
```

## 🏗️ 契约层的文件结构

```
contracts/
├── __init__.py
├── environment.py          # 环境契约
├── agents.py              # 智能体契约
├── data_models.py         # 数据契约
├── computation.py         # 计算契约
├── events.py             # 事件契约
├── configuration.py      # 配置契约
├── validation.py         # 验证契约
└── exceptions.py         # 异常契约
```

## 🔧 契约层的实现策略

### 1. 接口定义
- 使用抽象基类定义接口
- 使用类型注解确保类型安全
- 使用dataclass定义数据结构

### 2. 验证机制
- 运行时类型检查
- 数据完整性验证
- 业务规则验证

### 3. 错误处理
- 定义标准异常类型
- 统一的错误处理机制
- 详细的错误信息

### 4. 版本管理
- 接口版本控制
- 向后兼容性
- 迁移指南

## 💡 契约层的优势

1. **解耦**: 模块间通过接口交互，不直接依赖实现
2. **可测试**: 可以轻松创建mock对象进行测试
3. **可维护**: 接口变更影响范围明确
4. **可扩展**: 新功能通过实现接口添加
5. **文档化**: 接口本身就是最好的文档

## 🚀 实施计划

### 阶段1: 核心契约定义
- 定义环境、智能体、数据模型契约
- 实现基础验证机制
- 建立异常处理体系

### 阶段2: 计算和事件契约
- 定义计算模块契约
- 实现事件系统契约
- 添加配置验证契约

### 阶段3: 集成和测试
- 实现契约验证器
- 编写单元测试
- 集成测试验证

### 阶段4: 文档和优化
- 完善接口文档
- 性能优化
- 版本管理

## 📊 与v4.1的对比

| 方面 | v4.1 | v5.0契约层 |
|------|------|------------|
| 模块耦合 | 高耦合，直接依赖 | 低耦合，接口依赖 |
| 测试性 | 难以单独测试 | 易于mock测试 |
| 维护性 | 修改影响面大 | 修改影响面小 |
| 扩展性 | 需要修改多处 | 只需实现接口 |
| 文档化 | 分散在代码中 | 集中在契约中 |

## 🎯 总结

契约层是v5.0架构的核心，它通过定义清晰的接口和约定，实现了系统各模块的解耦，提高了系统的可维护性、可测试性和可扩展性。通过实施契约层，我们可以构建一个更加健壮和灵活的城市模拟系统。
