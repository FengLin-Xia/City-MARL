å¢å¼ºåŸå¸‚æ¨¡æ‹Ÿç³»ç»Ÿ PRD v3.2
1. é¡¹ç›®æ¦‚è¿°
1.1 é¡¹ç›®åç§°

å¢å¼ºåŸå¸‚æ¨¡æ‹Ÿç³»ç»Ÿ (Enhanced City Simulation System)

1.2 é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ªåŸºäºå¤šæ™ºèƒ½ä½“çš„åŸå¸‚å‘å±•æ¨¡æ‹Ÿç³»ç»Ÿï¼Œé€šè¿‡ é«˜æ–¯æ ¸åœ°ä»·æ½œåŠ›åœºã€æ™ºèƒ½ä½“å†³ç­–ã€çœŸå®é€šå‹¤è½¨è¿¹å’Œå¤šæ—¶é—´å°ºåº¦æ›´æ–°ï¼Œæ¨¡æ‹ŸåŸå¸‚çš„åŠ¨æ€æ¼”åŒ–ï¼Œç‰¹åˆ«çªå‡º é€å±‚æ¶Ÿæ¼ªå¼ç”Ÿé•¿æ„Ÿï¼šå»ºç­‘å¿…é¡»å…ˆå¡«æ»¡æœ€å†…å±‚ç­‰å€¼çº¿åæ‰èƒ½å¤–æ‰©ã€‚

1.3 æ ¸å¿ƒç‰¹æ€§

å¤šæ™ºèƒ½ä½“å†³ç­–ç³»ç»Ÿï¼ˆæ”¿åºœã€ä¼ä¸šã€å±…æ°‘ï¼‰

é«˜æ–¯æ ¸é©±åŠ¨çš„åœ°ä»·æ¼”åŒ–ä¸å»ºç­‘åˆ†å¸ƒ

çœŸå®é€šå‹¤è½¨è¿¹å’Œçƒ­åŠ›å›¾

æ—¶é—´åˆ†å±‚ï¼šæ…¢ï¼ˆåœ°ä»·åœºï¼‰ã€ä¸­ï¼ˆäººå£ï¼‰ã€å¿«ï¼ˆå»ºç­‘ï¼‰

é€å±‚å¡«æ»¡ â†’ å¤–æ‰© çš„ä¸¥æ ¼å¢é•¿æœºåˆ¶

ä½å®… â†’ å•†ä¸šæ›¿ä»£ï¼ˆæ»åé€»è¾‘ï¼‰

æ”¿åºœå…¬å…±ç”¨åœ°å¼ºåˆ¶ä»‹å…¥ï¼ˆå­¦æ ¡ã€åŒ»é™¢ã€ç»¿åœ°ã€å¹¿åœºï¼‰

å¯è§†åŒ–"æ¶Ÿæ¼ªå¼"åŸå¸‚æ‰©å¼ 

1.4 ä¸€å¥è¯æ¶æ„

æ”¿åºœå®šéª¨æ¶ï¼šä¸€æ¡ä¸»èµ°å»Šå¸¦ï¼ˆä¸»å¹²é“ï¼‰+ ä¸¤ä¸ªé¡¶ç‚¹ï¼ˆHub1=å•†ä¸šå®¢è¿æ ¸ï¼ŒHub2=å·¥ä¸š/è´§è¿æ ¸ï¼‰ã€‚å…ˆå¸¦åç‚¹ã€å…ˆå†…åå¤–ï¼šé¦–å­£æ²¿èµ°å»Šä¸¤ä¾§"è¡—å¢™"æ’æ»¡ï¼Œå†ä»ä¸¤é¡¶ç‚¹å‘å¤–æ”¾å°„æ‰©å¼ ï¼Œå±‚å±‚è§£é”ã€‚ç»Ÿä¸€å†³ç­–å™¨ï¼šåŒä¸€å¥—æ§½ä½ï¼ŒæŒ‰å•†ä¸š/ä½å®…/å·¥ä¸šçš„åˆ†æ•°æŠ•æ ‡ï¼Œä¸­æ ‡è½ä½ï¼ˆå—é…é¢ä¸åˆ†åŒºçº¦æŸï¼‰ã€‚

2. ç³»ç»Ÿæ¶æ„
2.1 æ•´ä½“æ¶æ„
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é…ç½®ç³»ç»Ÿ      â”‚    â”‚   é€»è¾‘ç³»ç»Ÿ      â”‚    â”‚   å¯è§†åŒ–ç³»ç»Ÿ    â”‚
â”‚  - åŸå¸‚é…ç½®     â”‚    â”‚  - åœ°ä»·åœºç³»ç»Ÿ   â”‚    â”‚  - æ¸²æŸ“å¼•æ“     â”‚
â”‚  - å»ºç­‘é…ç½®     â”‚    â”‚  - æ™ºèƒ½ä½“ç³»ç»Ÿ   â”‚    â”‚  - åŠ¨ç”»ç³»ç»Ÿ     â”‚
â”‚  - æ™ºèƒ½ä½“é…ç½®   â”‚    â”‚  - è½¨è¿¹ç³»ç»Ÿ     â”‚    â”‚  - çƒ­åŠ›å›¾æ˜¾ç¤º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æ•°æ®ç³»ç»Ÿ      â”‚
                    â”‚  - çŠ¶æ€ç®¡ç†     â”‚
                    â”‚  - è¾“å‡ºç³»ç»Ÿ     â”‚
                    â”‚  - ç»Ÿè®¡ç³»ç»Ÿ     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2.2 æ¨¡å—åˆ’åˆ†

é…ç½®æ¨¡å— (configs/)ï¼šç³»ç»Ÿå‚æ•°é…ç½®

é€»è¾‘æ¨¡å— (logic/)ï¼šåœ°ä»·åœºã€æ™ºèƒ½ä½“ã€è½¨è¿¹

å¯è§†åŒ–æ¨¡å— (viz/)ï¼šæ¸²æŸ“ã€çƒ­åŠ›å›¾ã€åŠ¨ç”»

æ•°æ®æ¨¡å—ï¼šçŠ¶æ€ç®¡ç†ä¸è¾“å‡º

2.3 æ”¿åºœéª¨æ¶ç³»ç»Ÿ

2.3.1 èµ°å»Šå¸¦ï¼ˆæ¡å¸¦ï¼‰

å‡ ä½•ï¼šä¸»å¹²é“ä¸­å¿ƒçº¿ Î“ï¼›æ”¿åºœå‘å¸ƒå‚æ•°ï¼š

setback_mï¼ˆé“è·¯é€€çº¿ï¼‰ã€sigma_perpï¼ˆæ³•å‘å½±å“å®½åº¦ï¼‰ã€‚

Road-L0 é¦–å‘å¸ƒç½®å±‚ï¼šåœ¨ Î“ ä¸¤ä¾§åç§»çº¿ LÂ± ç­‰å¼§é•¿é‡‡æ ·ä¸ºæ§½ä½ï¼ˆå•†ä¸š 25â€“35mã€ä½å®… 30â€“45mã€å·¥ä¸š 35â€“55mï¼‰ï¼Œå†»ç»“ä¸º layer=road_L0ã€‚

2.3.2 åŒé¡¶ç‚¹ï¼ˆä¸¤æ”¾å°„æºï¼‰

Hub1ï¼ˆå•†ä¸š/å®¢è¿ï¼‰ï¼šåæ ‡ Hcï¼ŒåŠè½´å‚æ•° sigma_perp_c / sigma_para_cï¼ˆå„å‘å¼‚æ€§ï¼Œæ²¿èµ°å»Šæ–¹å‘æ›´é•¿ï¼‰ã€‚

Hub2ï¼ˆå·¥ä¸š/è´§è¿ï¼‰ï¼šåæ ‡ Hiï¼Œå‚æ•° sigma_perp_i / sigma_para_iã€‚

æ”¿åºœç»™å‡ºåˆ†åŒºæ©æ¨¡ï¼ˆzoningï¼‰ï¼šHub1 åŠå¾„å†…ä¼˜å…ˆå•†ä¸šã€Hub2 å‘¨è¾¹ä¼˜å…ˆå·¥ä¸šï¼›ä¸­æ®µèµ°å»Šä¸ºä½å®…ä¼˜å…ˆå¸¦ã€‚

2.3.3 é…é¢ä¸çºªå¾‹

å­£åº¦é…é¢ï¼šquota_res / quota_com / quota_indï¼ˆå¯ç”±å±…æ°‘éœ€æ±‚ä¸æ”¿ç­–ç›®æ ‡å…±åŒå†³å®šï¼‰ã€‚

é€å±‚çºªå¾‹ï¼šå½“å­£åªåœ¨æœ€å†…ä¾§ active å±‚è½ä½ï¼›density==100% æ‰è§£é”ä¸‹ä¸€å±‚ï¼ˆä¸¥æ ¼"æ¶Ÿæ¼ª"ï¼‰ã€‚

3. æ•°æ®æ¨¡å‹
3.1 åŸå¸‚çŠ¶æ€ (City State)
{
  "simulation_info": {
    "current_month": 0,
    "total_residents": 100,
    "total_buildings": 5,
    "average_land_price": 100.0
  },
  "land_price_field": [[...]],      
  "buildings": {
    "public": [...],
    "residential": [...],
    "commercial": [...]
  },
  "residents": [...],
  "trajectory_system": {
    "commute_heatmap": [[...]],
    "commercial_heatmap": [[...]],
    "decay_rate": 0.8
  },
  "land_price_stats": {
    "min_price": 50.0,
    "max_price": 300.0,
    "avg_price": 100.0,
    "price_distribution": {...}
  },
  "hysteresis_flags": {...},
  "public_facilities": [...],
  "layers": [
    {
      "layer_id": "commercial_P0",
      "status": "active",   
      "activated_quarter": 1,
      "slots": [
        { "pos": [120, 80], "used": false, "dead": false, "allowed_types": ["com"] }
      ],
      "capacity": 25,
      "dead_slots": 1,
      "capacity_effective": 24,
      "placed": 20,
      "density": 0.83
    }
  ]
}

3.2 è½¨è¿¹ç³»ç»Ÿ
{
  "trajectory_types": {
    "commute": { "color": "#0066CC", "intensity": 1.0 },
    "commercial": { "color": "#CC3300", "intensity": 0.7 }
  },
  "heatmap_layers": {
    "commute": [[...]],
    "commercial": [[...]],
    "combined": [[...]]
  }
}

4. åŠŸèƒ½æ¨¡å—
4.1 æ—¶é—´ç³»ç»Ÿ

åœ°ä»·åœºæ›´æ–°ï¼šå¹´åº¦/åŠå¹´çº§åˆ«ï¼ŒÏƒ æ¸è¿›å¢é•¿

å»ºç­‘æ›´æ–°ï¼šå­£åº¦æ‰¹é‡æ–°å¢ï¼ˆä½å®… 10â€“20ï¼Œå•†ä¸š 5â€“12ï¼Œå…¬å…± 1â€“3ï¼‰

äººå£/çƒ­åŠ›æ›´æ–°ï¼šæ¯æœˆ

æ›´æ–°é€»è¾‘ï¼š

æ¯æœˆï¼šå±…æ°‘è½¨è¿¹ â†’ çƒ­åŠ›æ›´æ–° â†’ åœ°ä»·åœºå°ä¿®æ­£

æ¯å­£åº¦ï¼šåŸºäºç­‰å€¼çº¿åˆ†å¸¦ â†’ æ‰¹é‡ç”Ÿæˆå»ºç­‘

æ¯å¹´ï¼šåœ°ä»·åœºèŒƒå›´å¤–æ‰©ï¼ŒÏƒ å¹³æ»‘å¢é•¿

4.1.1 ç‰¹å¾ä¸è¯„åˆ†ç³»ç»Ÿ

ç»™æ¯ä¸ªæ§½ä½è®¡ç®—ä»¥ä¸‹ç‰¹å¾ï¼ˆfeaturesï¼‰ï¼Œç»Ÿä¸€å–‚ç»™è¯„åˆ†å™¨ï¼š

f_roadï¼šåˆ°èµ°å»Šçº¿ Î“ çš„æ³•å‘æ ¸ï¼ˆçº¿çŠ¶é«˜æ–¯ï¼‰ï¼šexp(-dâŠ¥Â²/2ÏƒâŠ¥Â²)

f_hub_comï¼šå•†ä¸šé¡¶ç‚¹æ ¸ï¼ˆå„å‘å¼‚æ€§é«˜æ–¯ï¼Œæ²¿çº¿æ›´é•¿ï¼‰

f_hub_indï¼šå·¥ä¸šé¡¶ç‚¹æ ¸ï¼ˆå„å‘å¼‚æ€§é«˜æ–¯ï¼Œæˆ–"é¿å¼€å•†ä¸š"çš„å·®åˆ†æ ¸ï¼‰

f_accessï¼šå…¬å…±è®¾æ–½å¯è¾¾ï¼ˆæ”¿åºœæŠ•æ”¾åå®æ—¶æ”¹å˜ï¼‰

f_heatï¼šå±…æ°‘è½¨è¿¹çƒ­åŠ›ï¼ˆå•†ä¸šæ¶ˆè´¹/é€šå‹¤ï¼‰

crowding/junction_penaltyï¼šæ‹¥æŒ¤ä¸è·¯å£æƒ©ç½š

ç»Ÿä¸€æ‰“åˆ†å‡½æ•°ï¼ˆåŒå½¢ä¸åŒæƒï¼‰ï¼š

å•†ä¸šï¼šscore_com = 0.6*f_hub_com + 0.2*f_road + 0.15*f_heat + 0.05*f_access - penalties

å·¥ä¸šï¼šscore_ind = 0.55*f_hub_ind + 0.25*f_road + 0.05*f_access - 0.10*crowding - 0.05*junction

ä½å®…ï¼šscore_res = 0.5*f_road + 0.15*f_access - 0.2*f_hub_com - 0.15*f_hub_ind - penalties

å¤š"åœº"åªæ˜¯ç‰¹å¾å±‚ï¼›å†³ç­–æ°¸è¿œä¸€å¥—ï¼šåˆ†åŒºè¿‡æ»¤ â†’ è®¡ç®—ä¸‰åˆ† â†’ èµ¢å®¶é€šåƒï¼ˆå—é…é¢ï¼‰

4.2 è½¨è¿¹ç³»ç»Ÿ

å±…æ°‘æ—¥ç¨‹ï¼šä½å®…â†’å·¥ä½œâ†’è´­ç‰©â†’ä½å®…

çƒ­åŠ›æ›´æ–°ï¼šæ¯æ¬¡ç§»åŠ¨ç´¯ç§¯ï¼Œæœˆåº¦è¡°å‡ 20%

è¾“å‡ºå±‚ï¼šé€šå‹¤çƒ­åŠ›ã€å•†ä¸šçƒ­åŠ›ã€ç»¼åˆçƒ­åŠ›

4.3 æ™ºèƒ½ä½“ç³»ç»Ÿ

æ”¿åºœï¼šæ¯å­£åº¦å†³ç­–å…¬å…±è®¾æ–½

ä¼ä¸šï¼šæŒ‰å­£åº¦æ–°å¢å»ºç­‘ï¼ŒåŸºäºç­‰å€¼çº¿é€‰å€

å±…æ°‘ï¼šé€‰ä½å®…/å·¥ä½œ â†’ æŒ‰æ—¥ç¨‹æ´»åŠ¨ï¼Œæ›´æ–°çƒ­åŠ›

4.4 é«˜æ–¯æ ¸åœ°ä»·æ½œåŠ›åœºç³»ç»Ÿ

ç‚¹æ ¸ (äº¤é€šæ¢çº½)ï¼š2D é«˜æ–¯å‡½æ•°

çº¿æ ¸ (é“è·¯)ï¼šåŸºäºå‚ç›´è·ç¦»çš„é«˜æ–¯è¡°å‡

èåˆæ–¹å¼ï¼šmax(P_hub, P_road)ï¼Œé˜ˆå€¼ä»¥ä¸‹è®¾ä¸º 0

æ—¶é—´æ¼”åŒ–ï¼šÏƒ_hub / Ïƒ_road éšæ—¶é—´å¢é•¿ï¼Œå¹³æ»‘è¿‡æ¸¡

å•ä½ä¸€è‡´æ€§ï¼šmeters_per_pixel å‚æ•°

4.5 å»ºç­‘å¢é•¿ç³»ç»Ÿï¼ˆé€å±‚ä¸¥æ ¼ç”Ÿé•¿ï¼‰

å†»ç»“æ–½å·¥çº¿ï¼šç­‰å€¼çº¿ä¸€æ—¦æ¿€æ´» â†’ polyline å’Œ slots å›ºå®šã€‚

é€å±‚ä¸¥æ ¼å¡«æ»¡æœºåˆ¶ï¼š

å½“å‰å±‚æ‰€æœ‰ æœ‰æ•ˆæ§½ä½ (capacity_effective) è¢«å æ»¡ â†’ æ‰èƒ½æ¿€æ´»å¤–å±‚ã€‚

æœ¬å­£åº¦å‰©ä½™çš„é…é¢ ä¸è·¨å±‚ï¼Œç›´æ¥ç»“è½¬ã€‚

æ­»æ§½æœºåˆ¶ï¼š

è¢«è¾¹ç•Œ/å…¬å…±ç”¨åœ°é®æŒ¡çš„æ§½ä½æ ‡è®°ä¸º deadï¼Œä¸è®¡å…¥æœ‰æ•ˆå®¹é‡ã€‚

æ­»æ§½ç‡ä¸å¾—è¶…è¿‡é…ç½®é˜ˆå€¼ã€‚

4.6 åˆ†å¸¦ä¸ç­‰å€¼çº¿å»ºç­‘ç”Ÿæˆ

åˆ†å¸¦è§„åˆ™ï¼š

å‰æ’ (60â€“120m)ï¼šä»…å•†ä¸š

ä½å®…å¸¦ (120â€“260m)ï¼šä½å®…ä¸ºä¸»

å¤–å›´ (>260m)ï¼šæ··åˆ

ç­‰å€¼çº¿æå–ï¼šmarching squares

æ§½ä½åŒ–ï¼ˆslottingï¼‰ï¼šç­‰å¼§é•¿é‡‡æ · â†’ æ¯ä¸ªç‚¹ç”Ÿæˆä¸€ä¸ªæ§½ä½

ç­‰å¼§é•¿é‡‡æ ·ï¼šå•†ä¸š 25â€“35mï¼Œä½å®… 35â€“55m

é€å±‚æ¿€æ´»æµç¨‹ï¼š

åˆå§‹å­£åº¦æ¿€æ´» P0 å±‚å¹¶å†»ç»“æ§½ä½

æ¯å­£åº¦é…é¢å…¨éƒ¨å…ˆæŠ•æ”¾å½“å‰å±‚

å±‚æ»¡æ ¼åï¼Œä¸‹å­£åº¦æ‰æ¿€æ´»å¤–å±‚

4.7 ä½å®… â†’ å•†ä¸šæ›¿ä»£

æ¡ä»¶ï¼šè¿ç»­ 2 å­£åº¦å•†ä¸šè¯„åˆ† > ä½å®…è¯„åˆ†+0.15

å†·å´æœŸï¼š4 å­£åº¦

ä¿åº•ï¼šä½å®…å æ¯” â‰¥ 35%

4.8 å…¬å…±ç”¨åœ°æœºåˆ¶

è§¦å‘æ¡ä»¶ï¼šäººå£å¯†åº¦ / å¯è¾¾æ€§ / å»ºç­‘å¯†åº¦ / å•†ä¸šå¯†åº¦

æ•ˆæœï¼šå±€éƒ¨åœ°ä»· +10â€“20%ï¼Œè¿å…¥ç‡ä¸Šå‡ï¼Œç¼“è§£æ‹¥æŒ¤

å…¬å…±ç”¨åœ°æ’å…¥ä¸æ¶ˆè€—ä½å®…/å•†ä¸šé…é¢ï¼Œä½†ä¼šå±è”½æ§½ä½

4.9 ç”Ÿé•¿æµç¨‹ï¼ˆæ¡å¸¦â†’æ”¾å°„ï¼‰

Q0â€“Q1ï¼šæ²¿èµ°å»Šé¦–å‘ï¼ˆRoad-L0ï¼‰

æ¿€æ´»å¹¶å†»ç»“ road_L0ï¼›

åªåœ¨ road_L0 æ§½ä½æŠ•æ”¾ï¼Œ**æ»¡æ ¼ï¼ˆâ‰¥95% æœ‰æ­»æ§½å®¹å¿ï¼‰**åï¼Œæ ‡è®° completeï¼›

æœŸé—´æ”¿åºœå¯åœ¨äº¤å‰å£/å°½å¤´æ’å…¥å…¬å…±ç”¨åœ°ï¼ˆå­¦æ ¡/å…¬å›­ï¼‰ï¼Œåˆ·æ–° f_accessã€‚

Q2+ï¼šåŒé¡¶ç‚¹æ”¾å°„ + èµ°å»Šå¤–æ‰©

åŒæ—¶æ¿€æ´»ä¸¤ç»„æ”¾å°„å±‚ï¼š

å•†ä¸šæ”¾å°„ P0_cï¼šå– f_hub_com çš„é«˜å€¼ç­‰å€¼çº¿ï¼ˆå¦‚ 0.85â†’0.78â†’0.71â€¦ï¼‰ï¼Œç”±å†…å‘å¤–è§£é”ã€‚

å·¥ä¸šæ”¾å°„ P0_iï¼šå– f_hub_ind çš„ç­‰å€¼çº¿ï¼ˆå¯è®¾è®¡æˆ"å¤–ä¾§æ›´ä¼˜"çš„åºåˆ— 0.6â†’0.7â†’0.8â€¦ï¼‰ï¼Œå‘å¤–æ‰©ã€‚

ä½å®…å±‚ï¼šåœ¨èµ°å»Šä¸­æ®µçš„ç›®æ ‡åŒºé—´ï¼ˆå¦‚ f_roadâˆˆ[0.45,0.65] ä¸”è¿œç¦»ä¸¤ hub é«˜å€¼åŒºï¼‰é€å±‚å¡«å……ã€‚

å½“å­£ä»…åœ¨"å½“å‰æœ€å†…ä¾§ active å±‚"ä¸­æ ‡æ”¾ç½®ï¼›å±‚æ»¡â†’ä¸‹å­£æ¿€æ´»ä¸‹ä¸€åœˆã€‚

å½¢æˆè§†è§‰ï¼šå…ˆæ˜¯ä¸€æ¡"è¡—å¢™"æ¡å¸¦â†’ ä¸¤ç«¯å„è‡ªæ”¾å°„çŠ¶å¤–æ‰©â†’ ä¸­æ®µå¹³è¡Œå¸¦å‘å¤–æ¶¨ã€‚

4.10 å†³ç­–å™¨ï¼ˆç»Ÿä¸€ä¸­æ ‡ï¼‰

def place_on_active_layer(active_layer, quotas):
    buckets = {"com":[], "res":[], "ind":[]}
    for slot in active_layer.free_slots():
        feats = compute_features(slot)  # f_road, f_hub_com, f_hub_ind, f_access, f_heat, penalties...
        scores = {
          "com": dot(W_com, feats) if slot.allow("com") else -inf,
          "res": dot(W_res, feats) if slot.allow("res") else -inf,
          "ind": dot(W_ind, feats) if slot.allow("ind") else -inf
        }
        winner = argmax(scores)
        buckets[winner].append((slot, scores[winner]))

    placed = []
    for k in ["com","res","ind"]:
        take = topN(buckets[k], quotas[k])  # é™åºå–å‰N
        placed += place_with_collision_check(take)

    if active_layer.density_effective()==1.0:
        active_layer.complete()
        schedule_activate_next_layer()  # ä¸‹å­£ç”Ÿæ•ˆ
    return placed

5. å¯è§†åŒ–ç³»ç»Ÿ

æ¸²æŸ“é¡ºåºï¼šç½‘æ ¼ â†’ çƒ­åŠ›å›¾ â†’ é“è·¯/æ¢çº½ â†’ ç­‰å€¼çº¿ â†’ æ§½ä½ â†’ å»ºç­‘ â†’ å±…æ°‘ â†’ ç»Ÿè®¡

å…¬å…±ç”¨åœ°ç¬¦å·ï¼šğŸ« ğŸ¥ ğŸŒ³ ğŸ›ï¸

æ§½ä½æ˜¾ç¤ºï¼š

Free = ç©ºå¿ƒåœ†

Used = å®å¿ƒåœ†

Dead = ç°è‰²å‰å·

å±‚çŠ¶æ€æ˜¾ç¤ºï¼š

Active å±‚ = é«˜äº®ç²—çº¿

Complete å±‚ = ç»¿è‰²å‹¾æ ‡è¯†

é¢æ¿ï¼šæ˜¾ç¤ºæ¯å±‚çš„å¡«å……è¿›åº¦ placed / capacity_effective

ç”Ÿé•¿åŠ¨ç”»ï¼šæ–°å»ºç­‘ä»ç‚¹çŠ¶æ§½ä½åœ¨ 0.6s å†…é•¿æˆ footprint

6. è¾“å‡ºç³»ç»Ÿ

6.1 å¢é‡å¼å»ºç­‘ä½ç½®å¯¼å‡ºï¼ˆv3.1æ–°å¢ï¼‰

é‡‡ç”¨çº¯å¢é‡æ–¹æ¡ˆä¼˜åŒ–å­˜å‚¨ç©ºé—´ï¼š

ç¬¬1ä¸ªæœˆï¼šå®Œæ•´çŠ¶æ€æ–‡ä»¶
- building_positions_month_01.jsonï¼ˆå®Œæ•´å»ºç­‘åˆ—è¡¨ï¼‰

ç¬¬2-Nä¸ªæœˆï¼šå¢é‡æ–‡ä»¶
- building_delta_month_*.jsonï¼ˆä»…æ–°å¢å»ºç­‘ï¼‰

å¢é‡æ–‡ä»¶æ ¼å¼ï¼š
```json
{
  "month": 5,
  "timestamp": "month_05", 
  "new_buildings": [
    {
      "id": "res_001",
      "type": "residential",
      "position": [123.456, 789.012],
      "land_price_value": 0.8,
      "slot_id": "slot_001"
    }
  ],
  "metadata": {
    "total_buildings": 150,
    "new_count": 3
  }
}
```

6.2 å…¶ä»–è¾“å‡ºæ–‡ä»¶

city_state_output.json

trajectory_data.json

land_price_evolution.json

land_price_field_quarterly.json

facility_events.json

conversion_events.json

layer_state_quarterly.jsonï¼ˆè®°å½•å±‚çŠ¶æ€å’Œæ§½ä½ä½¿ç”¨ï¼‰

simplified_buildings_*.jsonï¼ˆç®€åŒ–æ ¼å¼ï¼Œç”¨äºAPIï¼‰

æ¸²æŸ“ï¼šmonth_*.pngã€city_evolution.gif

6.3 çŠ¶æ€é‡å»ºåŠŸèƒ½

æä¾›é‡å»ºä»»æ„æœˆä»½å®Œæ•´çŠ¶æ€çš„å·¥å…·å‡½æ•°ï¼š
- get_full_state_at_month(target_month)
- ä»ç¬¬1ä¸ªæœˆå¼€å§‹ç´¯åŠ æ‰€æœ‰å¢é‡æ–‡ä»¶
- æ”¯æŒç¼“å­˜æœºåˆ¶æå‡æŸ¥è¯¢æ•ˆç‡

7. é…ç½®ç³»ç»Ÿ
"city": {
  "map_size": [110, 110],
  "trunk_road": [[20, 55], [90, 55]],
  "transport_hubs": [[20, 55], [90, 55]]
},
"government_backbone": {
  "road_corridor": { "sigma_perp_m": 40, "setback_m": { "com": 8, "res": 10, "ind": 14 } },
  "hubs": {
    "commercial": { "sigma_perp_m": 30, "sigma_parallel_m": 90 },
    "industrial": { "sigma_perp_m": 35, "sigma_parallel_m": 110 }
  },
  "zoning": {
    "hub_com_radius_m": 350, "hub_ind_radius_m": 450,
    "mid_corridor_residential": true
  },
  "quotas_per_quarter": { "res": [10,20], "com": [5,12], "ind": [4,10] },
  "strict_layering": true, "dead_slots_ratio_max": 0.05
},
"scoring_weights": {
  "com": { "f_hub_com": 0.6, "f_road": 0.2, "f_heat": 0.15, "f_access": 0.05,
           "crowding": 0.03, "junction_penalty": 0.02 },
  "ind": { "f_hub_ind": 0.55, "f_road": 0.25, "f_access": 0.05,
           "crowding": 0.10, "junction_penalty": 0.05 },
  "res": { "f_road": 0.5, "f_access": 0.15,
           "f_hub_com": -0.2, "f_hub_ind": -0.15, "crowding": 0.05 }
},
"gaussian_land_price_system": {
  "meters_per_pixel": 2.0,
  "hub_sigma_base_m": 40,
  "road_sigma_base_m": 20,
  "hub_peak_value": 1.0,
  "road_peak_value": 0.7,
  "min_threshold": 0.1,
  "hub_growth_rate": 0.03,
  "road_growth_rate": 0.02,
  "max_hub_multiplier": 2.0,
  "max_road_multiplier": 2.5,
  "alpha_inertia": 0.25
},
"isocontour_layout": {
  "commercial": { "start_P": 0.85, "depth_m": 20, "gap_m": 10, "arc_spacing_m": [25, 35] },
  "residential": { "start_P": 0.55, "depth_m": 14, "gap_m": 26, "arc_spacing_m": [35, 55] },
  "normal_offset_m": 1.0,
  "jitter_m": 0.5,
  "fallback_percentiles": { "commercial": [95, 90, 85], "residential": [80, 70, 60, 50] }
},
"bands": {
  "front_no_residential_m": [60, 120],
  "residential_side_band_m": [120, 260],
  "use_signed_normal": true
},
"landuse_hysteresis": {
  "delta_bid": 0.15,
  "L_quarters": 2,
  "cooldown_quarters": 4,
  "res_min_share": 0.35
},
"public_facility_rules": {
  "school": { "trigger_population": 500, "service_radius": 500, "symbol": "ğŸ«" },
  "hospital": { "trigger_distance_threshold": 800, "service_radius": 800, "symbol": "ğŸ¥" },
  "park": { "trigger_building_density": 0.6, "service_radius": 300, "symbol": "ğŸŒ³" },
  "plaza": { "trigger_commercial_density": 0.5, "service_radius": 400, "symbol": "ğŸ›ï¸" }
},
"progressive_growth": {
  "enabled": true,
  "strict_fill_required": true,       
  "allow_dead_slots_ratio": 0.05,     
  "carry_over_quota": true,           
  "freeze_contour_on_activation": true,
  "min_segment_length_factor": 3.0    
}

8. éªŒæ”¶æ ‡å‡†
ä¸»æ ‡å‡†

å»ºç­‘ä¸¥æ ¼è½åœ¨ç­‰å€¼çº¿ä¸Šï¼ˆè¯¯å·® â‰¤0.5mï¼‰

å•†ä¸šç­‰å€¼çº¿å¹³å‡é—´è· = 30m Â±10%ï¼›ä½å®… = 40m Â±10%

ç­‰å¼§é•¿é‡‡æ ·ç¬¦åˆé…ç½®åŒºé—´å æ¯” â‰¥90%

åˆ†å¸¦æ­£ç¡®ï¼šå‰æ’æ— ä½å®…ï¼Œä½å®…é›†ä¸­åœ¨å¸¦åŒº

åœ°ä»·åœºå¹´åº¦è¿‡æ¸¡å¹³æ»‘ï¼ˆÏƒ è¿ç»­å¢é•¿ï¼‰

å»ºç­‘åˆ†å¸ƒä¸åœ°ä»·åœºç›¸å…³æ€§ â‰¥0.7

8.1 æ”¿åºœéª¨æ¶éªŒæ”¶å£å¾„

æ¡å¸¦å…ˆæˆå‹ï¼šroad_L0 ä¸¤ä¾§"è¡—å¢™"å®Œæ•´åº¦ â‰¥95%ï¼Œè§’ç‚¹å‡€ç©ºåˆè§„ï¼›

åŒé¡¶ç‚¹æ”¾å°„ï¼šHub1/Hub2 å‘¨è¾¹"å†…åœˆä¼˜å…ˆ"æˆ–"å¤–åœˆä¼˜å…ˆ"ï¼ˆæŒ‰é…ç½®ï¼‰é€å±‚è§£é”ï¼Œæ— è·¨å±‚æ”¾ç½®ï¼›

ä¸­æ®µä½å®…å¸¦ï¼šèµ°å»Šä¸­æ®µçš„ä½å®…è¦†ç›–ç‡â‰¥ç›®æ ‡é˜ˆå€¼ï¼ˆå¦‚ 60%ï¼‰ï¼Œé è¿‘ä¸¤ç«¯æ¸å˜ä¸ºå•†/å·¥ï¼›

æ—¶é—´ç§©åºï¼šcomplete_at(road_L0) â‰¤ activated_at(P0_c/P0_i)ï¼›

å¯è§£é‡Šæ€§ï¼šä¸­æ ‡æ—¥å¿—è®°å½•æ§½ä½ç‰¹å¾ä¸ä¸‰ç±»åˆ†æ•°ï¼Œèƒœè€…å·®è·åˆ†å¸ƒåˆç†ã€‚

é€å±‚ä¸¥æ ¼æ€§

ä»»æ„å­£åº¦ï¼Œè‹¥å­˜åœ¨å¤–å±‚ active/usedï¼Œåˆ™æ‰€æœ‰å†…å±‚å¿…é¡» complete

å±‚çš„ density = placed / capacity_effective å¿…é¡» =100% æ‰èƒ½æ¿€æ´»å¤–å±‚

æœ¬å­£åº¦å‰©ä½™é…é¢ä¸å¯è·¨å±‚

æ­»æ§½å®¹å¿åº¦

æ¯å±‚ dead_slots / capacity â‰¤ allow_dead_slots_ratio

å¯è§†åŒ–ä¸€è‡´æ€§

é¢æ¿æ˜¾ç¤ºæ¯å±‚è¿›åº¦æ¡ä¸ dead æ§½ä½æ•°

æ‰©å¼ å‘ˆç°â€œæ¶Ÿæ¼ªå¼â€æ•ˆæœï¼šç”±å†…è€Œå¤–é€å±‚äº®èµ·

9. å¼€å‘è®¡åˆ’

é˜¶æ®µ1ï¼šæ—¶é—´ç³»ç»Ÿæ”¹é€ ï¼ˆ1â€“2 å¤©ï¼‰

é˜¶æ®µ2ï¼šè½¨è¿¹ç³»ç»Ÿå¼€å‘ï¼ˆ2â€“3 å¤©ï¼‰

é˜¶æ®µ2.5ï¼šé«˜æ–¯æ ¸åœ°ä»·åœºç³»ç»Ÿå®ç°ï¼ˆ1â€“2 å¤©ï¼‰

é˜¶æ®µ3ï¼šå¢é•¿ç³»ç»Ÿä¼˜åŒ–ï¼ˆ1â€“2 å¤©ï¼‰

é˜¶æ®µ3.5ï¼šç­‰å€¼çº¿å»ºç­‘ç”Ÿæˆä¸æ›¿ä»£é€»è¾‘ï¼ˆ2â€“3 å¤©ï¼‰

âœ… æ§½ä½åŒ–ä¸å†»ç»“æ–½å·¥çº¿

âœ… å±‚çŠ¶æ€æœºï¼ˆlocked/active/completeï¼‰

âœ… ä¸¥æ ¼æ»¡æ ¼åå¤–æ‰©é€»è¾‘

âœ… æ­»æ§½æœºåˆ¶ä¸ç»Ÿè®¡

é˜¶æ®µ4ï¼šå¯è§†åŒ–å¢å¼ºï¼ˆ1â€“2 å¤©ï¼‰

é˜¶æ®µ4.5ï¼šå…¬å…±ç”¨åœ°æœºåˆ¶å®ç°ï¼ˆ1 å¤©ï¼‰

é˜¶æ®µ5ï¼šæµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1 å¤©ï¼‰

10. é£é™©è¯„ä¼°

ç­‰å€¼çº¿æŠ–åŠ¨ï¼šÏƒ å¢é•¿è¿‡å¿« â†’ ä½¿ç”¨ Î±=0.25 å¹³æ»‘ + å†»ç»“æ–½å·¥çº¿

å±‚å¡ä½ï¼šè‹¥æ­»æ§½è¿‡å¤šå¯¼è‡´æ— æ³•æ»¡æ ¼ â†’ ä½¿ç”¨ allow_dead_slots_ratio å®¹å¿åº¦

å¤–å±‚è¿‡æ™šæ¿€æ´»ï¼šé€šè¿‡ max_quarters_per_layer æ§åˆ¶

å…¬å…±ç”¨åœ°è¿‡å¯†ï¼šåŠ æœ€å°é—´è·çº¦æŸ

çƒ­åŠ›æ•°æ®è†¨èƒ€ï¼šnumpy ä¼˜åŒ– + å†å²æ¸…ç†

å»ºç­‘é‡å é£é™©ï¼šåŠ å…¥å ä½/ç¢°æ’æ£€æµ‹

11. ç‰ˆæœ¬å†å²

v3.2ï¼ˆå½“å‰ï¼‰

å¼•å…¥æ”¿åºœéª¨æ¶ç³»ç»Ÿï¼šèµ°å»Šå¸¦ + åŒé¡¶ç‚¹æ¶æ„

ç»Ÿä¸€å†³ç­–å™¨ï¼šå•†ä¸š/ä½å®…/å·¥ä¸šç»Ÿä¸€è¯„åˆ†æŠ•æ ‡æœºåˆ¶

ç‰¹å¾åŒ–è¯„åˆ†ç³»ç»Ÿï¼šf_road, f_hub_com, f_hub_ind, f_access, f_heat ç­‰å¤šç‰¹å¾èåˆ

æ¡å¸¦â†’æ”¾å°„ç”Ÿé•¿æµç¨‹ï¼šå…ˆæ²¿èµ°å»Š"è¡—å¢™"æ’æ»¡ï¼Œå†åŒé¡¶ç‚¹å‘å¤–æ”¾å°„

åˆ†åŒºçº¦æŸä¸é…é¢ç®¡ç†ï¼šæ”¿åºœå®šéª¨æ¶ï¼Œæ™ºèƒ½ä½“æŒ‰è§„åˆ™æŠ•æ ‡

v3.1

å¼•å…¥ æ§½ä½åŒ– + å†»ç»“ç­‰å€¼çº¿

ä¸¥æ ¼é€å±‚æ»¡æ ¼æœºåˆ¶

æ–°å¢ dead æ§½ä½æœºåˆ¶ä¸å®¹å¿ç‡

å¯è§†åŒ–å¼ºåŒ–ï¼šæ§½ä½ä¸‰æ€ + å±‚è¿›åº¦é¢æ¿

ç½‘æ ¼å°ºå¯¸ä¼˜åŒ–ï¼š256Ã—256 â†’ 110Ã—110ï¼ˆæå‡æ€§èƒ½ï¼Œä¿æŒæ¯”ä¾‹ï¼‰

äº¤é€šæ¢çº½ä½ç½®è°ƒæ•´ï¼šé€‚é…æ–°ç½‘æ ¼å°ºå¯¸

v3.0

å…¨é¢æ›¿æ¢ SDF â†’ Gaussian Land Price Field

æ›´æ–°è¾“å‡º/é…ç½®å­—æ®µå

éªŒæ”¶æ ‡å‡†ã€é£é™©ã€å¯è§†åŒ–ç»Ÿä¸€ä¸ºåœ°ä»·åœºæœ¯è¯­

v2.3

é«˜æ–¯æ ¸ç³»ç»Ÿåˆæ­¥å®ç°ï¼Œä»å« SDF æ®‹ç•™

æ–°å¢æ—¶é—´åˆ†å±‚ã€ä½å®…/å•†ä¸šåˆ†å¸¦ã€ä½æ”¹å•†æ»åé€»è¾‘

v2.2

Logistic å»ºç­‘å¢é•¿æ›²çº¿

åˆ†æ‰¹é—ªç°æœºåˆ¶

æ ¸å¿ƒç‚¹ä¿®å¤

é˜²é‡å¤æœºåˆ¶

v2.0

æœˆçº§æ—¶é—´ç³»ç»Ÿ

çœŸå®é€šå‹¤è½¨è¿¹

çƒ­åŠ›å›¾ç³»ç»Ÿ

v1.0

åŸºç¡€å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ

æ—¥çº§æ—¶é—´ç³»ç»Ÿ

åŸºç¡€å¯è§†åŒ–