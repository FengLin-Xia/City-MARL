Project Memory — Rain’s RL City v5

这是一套城市强化学习系统（v5 结构），目前架构稳定。

系统分层：

配置层（Config）：所有参数、逻辑开关、奖励权重、调度顺序都写在 city_config_v5.json。遇到要改行为、加参数、调公式 → 先改配置，不写死在代码。

契约层（Contracts）：
已固定为 ActionCandidate, Sequence, StepLog 三个数据类。
模块之间只能通过这些类传数据。不要改结构；若要传额外信息，用 meta 字段。

模块层（Modules）：
所有功能（agent、中间件、奖励、计算器、调度器）都独立成文件，通过 @register("kind","name") 注册。
想加功能 → 新文件 + 注册 + 在配置启用。

控制层（Control）：
负责调度执行（pipeline + scheduler + env + ledger）。
不写业务 if-else；只调用注册模块。

工具层（Utils/Export）：
导出、日志、评估只读 StepLog。

工作思路：

新需求先看是不是配置能解决；如果不能，再加模块。

新奖励/规则 → reward_terms/ 或 action_mw/ 新文件。

新调度逻辑 → scheduler/ 新类。

控制层只调模块，不直接改逻辑。

遇到类型/接口问题，先查契约层定义，不随意加字段。

所有模块从配置读取参数，用 cfg[...]，不要硬编码。

风格约定：

模块协作：Pipeline（流水线）

状态管理：混合式（核心集中，agent 分散）

错误处理：可配置（WARN / FAIL_FAST）

性能目标：可扩展（先能跑，再优化）

兼容性：部分兼容 v4.1（主接口保留）

代码习惯：

中间件接口：apply(seq, state) -> Sequence

奖励接口：compute(prev_state, state, action_id) -> float

导出统一用：List[StepLog]

新字段 → 加在配置或 meta，不改契约类定义。

写模块时都用注册器，不手动 import。

口号：

先查配置 → 再用契约 → 新功能建模块 → 控制层只调度 → 不动基石。