# å¢å¼ºåŸå¸‚æ¨¡æ‹Ÿç³»ç»Ÿ PRD v2.0
## Product Requirements Document

### 1. é¡¹ç›®æ¦‚è¿°

#### 1.1 é¡¹ç›®åç§°
å¢å¼ºåŸå¸‚æ¨¡æ‹Ÿç³»ç»Ÿ (Enhanced City Simulation System)

#### 1.2 é¡¹ç›®ç›®æ ‡
æ„å»ºä¸€ä¸ªåŸºäºå¤šæ™ºèƒ½ä½“çš„åŸå¸‚å‘å±•æ¨¡æ‹Ÿç³»ç»Ÿï¼Œé€šè¿‡åœ°ä»·é©±åŠ¨ã€çœŸå®é€šå‹¤è½¨è¿¹å’Œæœˆçº§æ—¶é—´å°ºåº¦ï¼Œæ¨¡æ‹ŸåŸå¸‚çš„æœ‰æœºç”Ÿé•¿è¿‡ç¨‹ã€‚

#### 1.3 æ ¸å¿ƒç‰¹æ€§
- å¤šæ™ºèƒ½ä½“å†³ç­–ç³»ç»Ÿï¼ˆæ”¿åºœã€ä¼ä¸šã€å±…æ°‘ï¼‰
- åœ°ä»·é©±åŠ¨çš„å»ºç­‘å¸ƒå±€
- çœŸå®é€šå‹¤è½¨è¿¹å’Œçƒ­åŠ›å›¾
- æœˆçº§æ—¶é—´å°ºåº¦çš„åŸå¸‚å‘å±•
- å¯è§†åŒ–åŸå¸‚æ¼”åŒ–è¿‡ç¨‹

### 2. ç³»ç»Ÿæ¶æ„

#### 2.1 æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é…ç½®ç³»ç»Ÿ      â”‚    â”‚   é€»è¾‘ç³»ç»Ÿ      â”‚    â”‚   å¯è§†åŒ–ç³»ç»Ÿ    â”‚
â”‚  - åŸå¸‚é…ç½®     â”‚    â”‚  - åœ°ä»·ç³»ç»Ÿ     â”‚    â”‚  - æ¸²æŸ“å¼•æ“     â”‚
â”‚  - å»ºç­‘é…ç½®     â”‚    â”‚  - æ™ºèƒ½ä½“ç³»ç»Ÿ   â”‚    â”‚  - åŠ¨ç”»ç³»ç»Ÿ     â”‚
â”‚  - æ™ºèƒ½ä½“é…ç½®   â”‚    â”‚  - è½¨è¿¹ç³»ç»Ÿ     â”‚    â”‚  - çƒ­åŠ›å›¾æ˜¾ç¤º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   æ•°æ®ç³»ç»Ÿ      â”‚
                    â”‚  - çŠ¶æ€ç®¡ç†     â”‚
                    â”‚  - è¾“å‡ºç³»ç»Ÿ     â”‚
                    â”‚  - ç»Ÿè®¡ç³»ç»Ÿ     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.2 æ¨¡å—åˆ’åˆ†
- **é…ç½®æ¨¡å—** (`configs/`): ç³»ç»Ÿå‚æ•°é…ç½®
- **é€»è¾‘æ¨¡å—** (`logic/`): æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- **å¯è§†åŒ–æ¨¡å—** (`viz/`): æ¸²æŸ“å’ŒåŠ¨ç”»
- **æ•°æ®æ¨¡å—**: çŠ¶æ€ç®¡ç†å’Œè¾“å‡º

### 3. æ•°æ®æ¨¡å‹

#### 3.1 åŸå¸‚çŠ¶æ€ (City State)
```json
{
  "simulation_info": {
    "current_month": 0,
    "total_residents": 100,
    "total_buildings": 5,
    "average_land_price": 100.0
  },
  "buildings": {
    "public": [
      {
        "id": "pub_1",
        "type": "public",
        "xy": [x, y],
        "capacity": 500,
        "current_usage": 0,
        "service_radius": 50,
        "construction_cost": 1000,
        "revenue": 0
      }
    ],
    "residential": [
      {
        "id": "res_1",
        "type": "residential",
        "xy": [x, y],
        "capacity": 200,
        "current_usage": 0,
        "construction_cost": 500,
        "revenue_per_person": 10,
        "revenue": 0
      }
    ],
    "commercial": [
      {
        "id": "com_1",
        "type": "commercial",
        "xy": [x, y],
        "capacity": 800,
        "current_usage": 0,
        "construction_cost": 1000,
        "revenue_per_person": 20,
        "revenue": 0
      }
    ]
  },
  "residents": [
    {
      "id": "agent_1",
      "pos": [x, y],
      "home": "res_1",
      "workplace": "com_1",
      "income": 5000,
      "housing_cost": 0,
      "transport_cost": 0,
      "current_plan_index": 0,
      "plan": [
        {"type": "work", "target": "com_1", "duration": 8},
        {"type": "shop", "target": "com_2", "duration": 2},
        {"type": "home", "target": "res_1", "duration": 14}
      ]
    }
  ],
  "trajectory_system": {
    "commute_heatmap": [[...]],  // é€šå‹¤çƒ­åŠ›å›¾
    "commercial_heatmap": [[...]],  // å•†ä¸šæ´»åŠ¨çƒ­åŠ›å›¾
    "decay_rate": 0.8  // æ¯æœˆè¡°å‡ç‡
  },
  "land_price_stats": {
    "min_price": 50.0,
    "max_price": 300.0,
    "avg_price": 100.0,
    "price_distribution": {...}
  }
}
```

#### 3.2 è½¨è¿¹ç³»ç»Ÿ (Trajectory System)
```json
{
  "trajectory_types": {
    "commute": {
      "color": "#0066CC",
      "intensity": 1.0,
      "description": "ä½å®…åˆ°å·¥ä½œåœ°ç‚¹çš„é€šå‹¤è½¨è¿¹"
    },
    "commercial": {
      "color": "#CC3300", 
      "intensity": 0.7,
      "description": "è´­ç‰©å’Œå¨±ä¹æ´»åŠ¨è½¨è¿¹"
    }
  },
  "heatmap_layers": {
    "commute": [[...]],  // é€šå‹¤çƒ­åŠ›å›¾çŸ©é˜µ
    "commercial": [[...]],  // å•†ä¸šçƒ­åŠ›å›¾çŸ©é˜µ
    "combined": [[...]]  // ç»¼åˆçƒ­åŠ›å›¾çŸ©é˜µ
  }
}
```

### 4. åŠŸèƒ½æ¨¡å—

#### 4.1 æ—¶é—´ç³»ç»Ÿ (Time System)
**è®¾è®¡ç›®æ ‡**: ä»¥æœˆä¸ºå•ä½è¿›è¡Œæ¨¡æ‹Ÿï¼Œæé«˜ç³»ç»Ÿæ•ˆç‡

**æ ¸å¿ƒå‚æ•°**:
- æ¨¡æ‹Ÿå•ä½: æœˆ
- æ€»æ¨¡æ‹Ÿæ—¶é•¿: 24ä¸ªæœˆï¼ˆ2å¹´ï¼‰
- æ¯æœˆæ›´æ–°é¢‘ç‡: 1æ¬¡
- æ¸²æŸ“é¢‘ç‡: æ¯æœˆ1æ¬¡

**æ—¶é—´æ›´æ–°é€»è¾‘**:
```
æ¯æœˆæ›´æ–°æµç¨‹:
1. å±…æ°‘é€šå‹¤è½¨è¿¹æ›´æ–°
2. çƒ­åŠ›å›¾è¡°å‡ (20%)
3. åœ°ä»·ç³»ç»Ÿæ›´æ–°
4. æ™ºèƒ½ä½“å†³ç­–
5. æ–°å±…æ°‘ç”Ÿæˆ
6. å»ºç­‘ä½¿ç”¨ç»Ÿè®¡
7. æ¸²æŸ“è¾“å‡º
```

#### 4.2 è½¨è¿¹ç³»ç»Ÿ (Trajectory System)
**è®¾è®¡ç›®æ ‡**: å®ç°çœŸå®çš„é€šå‹¤è½¨è¿¹å’Œçƒ­åŠ›å›¾

**å±…æ°‘æ—¥ç¨‹**:
```
æ¯æ—¥è®¡åˆ’:
- æ—©ä¸Š (6:00-14:00): ä½å®… â†’ å·¥ä½œåœ°ç‚¹
- ä¸‹åˆ (14:00-16:00): å·¥ä½œåœ°ç‚¹ â†’ è´­ç‰©åœ°ç‚¹  
- æ™šä¸Š (16:00-6:00): è´­ç‰©åœ°ç‚¹ â†’ ä½å®…
```

**è½¨è¿¹ç”Ÿæˆ**:
```
è½¨è¿¹æ›´æ–°é€»è¾‘:
1. å±…æ°‘æŒ‰æ—¥ç¨‹ç§»åŠ¨
2. æ¯æ¬¡ç§»åŠ¨åœ¨å¯¹åº”çƒ­åŠ›å›¾ä¸Šç´¯ç§¯
3. é€šå‹¤è½¨è¿¹: ä½å®…åˆ°å·¥ä½œåœ°ç‚¹çš„è·¯å¾„
4. å•†ä¸šè½¨è¿¹: è´­ç‰©å’Œå¨±ä¹æ´»åŠ¨è·¯å¾„
5. æ¯æœˆè¡°å‡20%ä¿æŒåŠ¨æ€æ€§
```

**çƒ­åŠ›å›¾ç±»å‹**:
- **é€šå‹¤çƒ­åŠ›å›¾**: è“è‰²ç³»ï¼Œæ˜¾ç¤ºä½å®…åˆ°å·¥ä½œåœ°ç‚¹çš„äº¤é€šæµé‡
- **å•†ä¸šçƒ­åŠ›å›¾**: çº¢è‰²ç³»ï¼Œæ˜¾ç¤ºè´­ç‰©å’Œå¨±ä¹æ´»åŠ¨
- **ç»¼åˆçƒ­åŠ›å›¾**: ä¸¤ç§è½¨è¿¹çš„å åŠ æ•ˆæœ

#### 4.3 æ™ºèƒ½ä½“ç³»ç»Ÿ (Agent System)

##### 4.3.1 æ”¿åºœæ™ºèƒ½ä½“ (Government Agent)
**å†³ç­–é¢‘ç‡**: æ¯3ä¸ªæœˆä¸€æ¬¡
**å†³ç­–é€»è¾‘**:
```python
def make_decisions(self, city_state, land_price_system):
    # è¯„ä¼°å…¬å…±æœåŠ¡è¦†ç›–
    coverage = self.calculate_service_coverage(city_state)
    avg_time = self.calculate_average_travel_time(city_state)
    
    if coverage < 0.8 or avg_time > 10:
        # å»ºè®¾æ–°çš„å…¬å…±è®¾æ–½
        new_public = self.build_public_facility(city_state, land_price_system)
        return new_public
    return []
```

##### 4.3.2 ä¼ä¸šæ™ºèƒ½ä½“ (Business Agent)
**å†³ç­–é¢‘ç‡**: æ¯æœˆä¸€æ¬¡
**å†³ç­–é€»è¾‘**:
```python
def make_decisions(self, city_state, land_price_system):
    # åˆ†ç¦»å»ºè®¾é€»è¾‘å’Œå·¥ä½œåˆ†é…é€»è¾‘
    # 1. åŸºäºäººå£å¢é•¿å’Œåœ°ä»·å†³å®šå»ºè®¾
    new_residential = self.build_residential_if_needed(city_state, land_price_system)
    new_commercial = self.build_commercial_if_needed(city_state, land_price_system)
    
    # 2. å·¥ä½œåˆ†é…åœ¨å±…æ°‘ç³»ç»Ÿä¸­å¤„ç†
    return new_residential, new_commercial

def build_residential_if_needed(self, city_state, land_price_system):
    # åŸºäºä½å®…ä½¿ç”¨ç‡å’Œäººå£å¢é•¿éœ€æ±‚
    usage_ratio = self.calculate_residential_usage(city_state)
    population_growth = self.calculate_population_growth_needs(city_state)
    
    if usage_ratio > 0.7 or population_growth > 0:
        return self.construct_residential_building(city_state, land_price_system)
    return None

def build_commercial_if_needed(self, city_state, land_price_system):
    # åŸºäºäººå£åŸºç¡€å’Œå•†ä¸šå»ºç­‘å¯†åº¦
    residents = city_state.get('residents', [])
    commercial_buildings = city_state.get('commercial', [])
    residential_buildings = city_state.get('residential', [])
    
    # åŸºç¡€æ¡ä»¶ï¼šæœ‰è¶³å¤Ÿçš„äººå£å’Œä½å®…
    if len(residents) < 30 or len(residential_buildings) < 3:
        return None
    
    # å•†ä¸šå»ºç­‘å¯†åº¦ï¼šæ¯Xä¸ªå±…æ°‘éœ€è¦Yä¸ªå•†ä¸šå»ºç­‘
    target_commercial = len(residents) // 50  # æ¯50äººä¸€ä¸ªå•†ä¸šå»ºç­‘
    current_commercial = len(commercial_buildings)
    
    if current_commercial < target_commercial:
        return self.construct_commercial_building(city_state, land_price_system)
    return None
```

##### 4.3.3 å±…æ°‘æ™ºèƒ½ä½“ (Resident Agent)
**è¡Œä¸ºæ¨¡å¼**:
- é€‰æ‹©ä½å®…: åŸºäºåœ°ä»·ã€è·ç¦»ã€å®¹é‡
- é€‰æ‹©å·¥ä½œ: åŸºäºæ”¶å…¥ã€è·ç¦»ã€å»ºç­‘ç±»å‹
- æ—¥å¸¸é€šå‹¤: æŒ‰æ—¥ç¨‹è®¡åˆ’ç§»åŠ¨

#### 4.4 åœ°ä»·ç³»ç»Ÿ (Land Price System)
**åœ°ä»·è®¡ç®—å› ç´ **:
1. æ ¸å¿ƒè·ç¦»å½±å“ (50%)
2. äº¤é€šä¾¿åˆ©æ€§ (30%)
3. è®¾æ–½å¯†åº¦ (20%)

**åœ°ä»·æ›´æ–°**:
- æ¯æœˆæ›´æ–°ä¸€æ¬¡
- è€ƒè™‘äººå£å¯†åº¦å˜åŒ–
- è€ƒè™‘æ–°å»ºç­‘å½±å“

#### 4.5 å¢é•¿ç³»ç»Ÿ (Growth System)

##### 4.5.1 äººå£å¢é•¿
**å¢é•¿å‚æ•°**:
- åˆå§‹äººå£: 100äºº
- æ¯æœˆå¢é•¿ç‡: 8-12%
- æœ€å¤§äººå£å¯†åº¦: 80%
- ä½å®…å®¹é‡é™åˆ¶: è€ƒè™‘ç°æœ‰ä½å®…å®¹é‡

**æ–°å±…æ°‘ç”Ÿæˆ**:
```python
def spawn_new_residents(self):
    current_population = len(self.city_state['residents'])
    growth_rate = random.uniform(0.08, 0.12)
    new_residents_count = int(current_population * growth_rate)
    
    # è€ƒè™‘ä½å®…å®¹é‡é™åˆ¶
    total_capacity = self.calculate_total_housing_capacity()
    max_population = int(total_capacity * 0.8)
    
    if len(self.city_state['residents']) + new_residents_count > max_population:
        new_residents_count = max(0, max_population - len(self.city_state['residents']))
    
    return new_residents_count
```

##### 4.5.2 å»ºç­‘å¢é•¿ï¼ˆåœ°ä»·é©±åŠ¨ + Logisticå¢é•¿æ›²çº¿ï¼‰

**è®¾è®¡ç›®æ ‡**:
- é¿å…å»ºç­‘"å‡åŒ€éšæœºå¢åŠ "é€ æˆçš„ç”Ÿç¡¬æ„Ÿ
- é€šè¿‡Så‹å¢é•¿æ›²çº¿ï¼ˆå‰æœŸæ…¢ã€ä¸­æœŸå¿«ã€åæœŸæ”¶æ•›ï¼‰è¥é€ çœŸå®çš„åŸå¸‚ç”Ÿé•¿æ„Ÿ
- ä¿æŒæ€»é‡ç›®æ ‡ï¼š24ä¸ªæœˆæ–°å¢60â€“100æ ‹å»ºç­‘

**å¢é•¿å‡½æ•°å…¬å¼**:
é‡‡ç”¨Logisticå‡½æ•°æ¥æ§åˆ¶å»ºç­‘æ•°é‡éšæ—¶é—´çš„å¢é•¿ï¼š

```
N(t) = K / (1 + e^(-r(t-t0)))
```

å…¶ä¸­ï¼š
- `N(t)`ï¼šç¬¬tæœˆç´¯è®¡å»ºç­‘æ•°é‡
- `K`ï¼šæœ€å¤§å»ºç­‘å®¹é‡ï¼ˆç›®æ ‡æ€»é‡ï¼Œå»ºè®®80ï¼‰
- `r`ï¼šå¢é•¿é€Ÿç‡å‚æ•°ï¼ˆå»ºè®®0.3â€“0.5ï¼‰
- `t0`ï¼šæ‹ç‚¹ä½ç½®ï¼ˆå»ºè®®ç¬¬12æœˆï¼Œè¡¨ç¤ºä¸­æœŸåŠ é€ŸæœŸï¼‰
- æ¯æœˆæ–°å¢é‡ = N(t) - N(t-1)

**å¢é•¿é˜¶æ®µè§„åˆ’**:
- **å‰6æœˆ**ï¼šæ¯æœˆçº¦2â€“3æ ‹ï¼ˆä¸»è¦æ˜¯ä½å®…+å°‘é‡å•†ä¸šï¼‰
- **ä¸­é—´12æœˆ**ï¼šæ¯æœˆçº¦5â€“7æ ‹ï¼ˆä½å®…/å•†ä¸š/å…¬å…±é½å¤´å¹¶è¿›ï¼Œçƒ­åŠ›èµ°å»Šæ¸…æ™°ï¼‰
- **æœ€å6æœˆ**ï¼šæ¯æœˆçº¦3â€“5æ ‹ï¼ˆè¡¥å……çƒ­ç‚¹åŒºåŸŸï¼Œé€æ¸é¥±å’Œï¼‰

**å»ºç­‘ç±»å‹åˆ†å¸ƒ**:
- å…¬å…±å»ºç­‘: 20%
- ä½å®…å»ºç­‘: 40%
- å•†ä¸šå»ºç­‘: 40%

**æ ¸å¿ƒé—®é¢˜ä¿®å¤**:
1. **æ ¸å¿ƒç‚¹ä¿®æ­£**: åœ°ä»·ç³»ç»Ÿçš„æ ¸å¿ƒç‚¹åº”è¯¥æ˜¯ä¸¤ä¸ªäº¤é€šæ¢çº½(40, 128)å’Œ(216, 128)ï¼Œè€Œä¸æ˜¯åœ°å›¾ä¸­å¿ƒ(128, 128)
2. **é˜²é‡å¤æœºåˆ¶**: æ–°å¢å»ºç­‘ä½ç½®æ£€æŸ¥ï¼Œç¡®ä¿ä¸ä¸ç°æœ‰å»ºç­‘é‡å 
3. **ç©ºé—´åˆ†æ•£**: å¢åŠ å»ºç­‘é—´æœ€å°è·ç¦»çº¦æŸ
4. **è‡ªç„¶å¢é•¿**: ä½¿ç”¨Logisticå‡½æ•°å®ç°Så‹å¢é•¿æ›²çº¿
5. **å•†ä¸šå»ºç­‘åŒé‡å±æ€§**: åˆ†ç¦»å»ºè®¾é€»è¾‘å’Œå·¥ä½œåˆ†é…é€»è¾‘ï¼Œé¿å…å¾ªç¯ä¾èµ–

**æ–°å¢å‚æ•°**:
- `location_candidates`: æ¯æœˆç”Ÿæˆå€™é€‰åœ°å—ï¼ˆåŸºäºåœ°ä»·çŸ©é˜µç­›é€‰ top-N%ï¼‰
- `land_price_weight`: å»ºç­‘é€‰å€ä¸åœ°ä»·çš„è€¦åˆå¼ºåº¦ï¼ˆ0â€“1ï¼‰
- `heatmap_weight`: çƒ­åŠ›å¯¹å•†ä¸šå»ºç­‘é€‰å€çš„å½±å“ï¼ˆ0â€“1ï¼‰
- `facility_weight`: å…¬å…±è®¾æ–½å¯¹ä½å®…å¸å¼•åŠ›çš„å½±å“ï¼ˆ0â€“1ï¼‰
- `min_building_distance`: å»ºç­‘é—´æœ€å°è·ç¦»ï¼ˆåƒç´ ï¼‰
- `target_total`: ç›®æ ‡å»ºç­‘æ€»é‡
- `growth_function`: å¢é•¿å‡½æ•°ç±»å‹ï¼ˆ"logistic"ï¼‰
- `growth_params`: Logisticå‡½æ•°å‚æ•°ï¼ˆK, r, t0ï¼‰
- `min_new_per_month`: æ¯æœˆæœ€å°æ–°å¢é‡
- `max_new_per_month`: æ¯æœˆæœ€å¤§æ–°å¢é‡

**åˆ†æ‰¹é—ªç°æœºåˆ¶ï¼ˆè§†è§‰ä¼˜åŒ–ï¼‰**:
- æ–°å»ºç­‘ä¸è¦ä¸€æ¬¡æ€§å…¨éƒ¨å‡ºç°
- æ¯æœˆæ–°å¢å»ºç­‘åˆ†æˆ2â€“3æ‰¹æ¬¡ï¼ˆæ¯æ‰¹é—´éš”1â€“2ç§’æ¸²æŸ“ï¼‰ï¼Œæ¨¡æ‹Ÿæ–½å·¥/å¼€æ”¾çš„è¿‡ç¨‹

**é€»è¾‘æ›´æ–°**:
```python
def build_residential_if_needed(self, city_state, land_price_matrix):
    usage_ratio = self.calculate_residential_usage(city_state)
    if usage_ratio > 0.7:  # é«˜ä½¿ç”¨ç‡è§¦å‘æ‰©å»º
        # ç”Ÿæˆå€™é€‰ç‚¹ï¼ˆæ’é™¤å·²æœ‰å»ºç­‘ï¼‰
        candidates = self.get_available_land_price_zones(
            land_price_matrix, city_state, top_percent=20, min_distance=30
        )
        # æ‰“åˆ†å‡½æ•°
        scores = {
          c: (land_price_matrix[c] * self.land_price_weight
              + self.facility_proximity(c) * self.facility_weight)
          for c in candidates
        }
        best_loc = max(scores, key=scores.get)
        return self.construct_building("residential", best_loc)
    return None

def build_commercial_if_needed(self, city_state, land_price_matrix, heatmap):
    usage_ratio = self.calculate_commercial_usage(city_state)
    if usage_ratio > 0.6:
        candidates = self.get_available_land_price_zones(
            land_price_matrix, city_state, top_percent=30, min_distance=40
        )
        scores = {
          c: (land_price_matrix[c] * self.land_price_weight
              + heatmap[c] * self.heatmap_weight)
          for c in candidates
        }
        best_loc = max(scores, key=scores.get)
        return self.construct_building("commercial", best_loc)
    return None

def get_available_land_price_zones(self, land_price_matrix, city_state, top_percent=20, min_distance=30):
    """è·å–å¯ç”¨çš„é«˜åœ°ä»·åŒºåŸŸï¼Œç¡®ä¿ä¸ä¸ç°æœ‰å»ºç­‘é‡å """
    # è®¡ç®—åœ°ä»·é˜ˆå€¼
    flat_prices = land_price_matrix.flatten()
    threshold = np.percentile(flat_prices, 100 - top_percent)
    
    candidates = []
    for y in range(land_price_matrix.shape[0]):
        for x in range(land_price_matrix.shape[1]):
            if land_price_matrix[y, x] >= threshold:
                position = [x, y]
                # æ£€æŸ¥æ˜¯å¦ä¸ç°æœ‰å»ºç­‘ä¿æŒæœ€å°è·ç¦»
                if self.is_position_available(position, city_state, min_distance):
                    candidates.append((x, y))
    
    return candidates

def is_position_available(self, position, city_state, min_distance=30):
    """æ£€æŸ¥ä½ç½®æ˜¯å¦å¯ç”¨ï¼ˆä¸ç°æœ‰å»ºç­‘ä¿æŒæœ€å°è·ç¦»ï¼‰"""
    all_buildings = []
    all_buildings.extend(city_state.get('public', []))
    all_buildings.extend(city_state.get('residential', []))
    all_buildings.extend(city_state.get('commercial', []))
    
    for building in all_buildings:
        distance = self.calculate_distance(position, building['xy'])
        if distance < min_distance:
            return False
    
    return True
```

**å»ºç­‘åˆ†å¸ƒè§„å¾‹**:
- å…¬å…±å»ºç­‘ï¼šç”±æ”¿åºœæ™ºèƒ½ä½“æŒ‰è¦†ç›–ç‡å’Œå¹³å‡é€šå‹¤æ—¶é—´å†³å®š
- ä½å®…å»ºç­‘ï¼šä¼˜å…ˆåˆ†å¸ƒåœ¨ä¸­ç­‰åœ°ä»·åŒº + é è¿‘å…¬å…±è®¾æ–½ + è·ç¦»ç°æœ‰å»ºç­‘â‰¥30åƒç´ 
- å•†ä¸šå»ºç­‘ï¼šä¼˜å…ˆåˆ†å¸ƒåœ¨é«˜åœ°ä»·åŒº + çƒ­åŠ›èµ°å»Šé™„è¿‘ + è·ç¦»ç°æœ‰å»ºç­‘â‰¥40åƒç´ 

**å·¥ä½œåˆ†é…é€»è¾‘**:
- å•†ä¸šå»ºç­‘å»ºè®¾åï¼Œç«‹å³ä¸ºå±…æ°‘åˆ†é…å·¥ä½œåœ°ç‚¹
- è€ƒè™‘é€šå‹¤è·ç¦»å’Œåœ°ä»·å› ç´ 
- å¹³è¡¡å„å•†ä¸šå»ºç­‘çš„ä½¿ç”¨ç‡
- å·¥ä½œåˆ†é…ä¸å½±å“å•†ä¸šå»ºç­‘å»ºè®¾å†³ç­–

**åœ°ä»·ç³»ç»Ÿä¿®æ­£**:
```python
def initialize_land_prices(self, map_size, transport_hubs):
    """åˆå§‹åŒ–åœ°ä»·çŸ©é˜µï¼Œä»¥äº¤é€šæ¢çº½ä¸ºæ ¸å¿ƒç‚¹"""
    width, height = map_size
    self.land_price_matrix = np.zeros((height, width))
    self.transport_hubs = transport_hubs  # [(40, 128), (216, 128)]
    
    for y in range(height):
        for x in range(width):
            self.land_price_matrix[y, x] = self._calculate_land_price([x, y])

def _calculate_land_price(self, position):
    """è®¡ç®—åœ°ä»·ï¼Œä»¥æœ€è¿‘çš„äº¤é€šæ¢çº½ä¸ºæ ¸å¿ƒ"""
    x, y = position
    
    # è®¡ç®—åˆ°æœ€è¿‘äº¤é€šæ¢çº½çš„è·ç¦»
    min_hub_distance = float('inf')
    for hub in self.transport_hubs:
        distance = self._calculate_distance(position, hub)
        min_hub_distance = min(min_hub_distance, distance)
    
    # åœ°ä»·éšè·ç¦»äº¤é€šæ¢çº½çš„è·ç¦»è¡°å‡
    core_factor = math.exp(-min_hub_distance * self.decay_rate)
    
    # ä¸»å¹²é“ä¾¿åˆ©æ€§
    trunk_center_y = 128
    trunk_distance = abs(y - trunk_center_y)
    trunk_factor = math.exp(-trunk_distance * self.transport_decay_rate * 0.5)
    
    # ç»¼åˆè®¡ç®—
    land_price = self.base_price * (
        self.core_distance_weight * core_factor +
        self.transport_weight * trunk_factor +
        self.facility_weight * 1.0
    )
    
    return max(land_price, 50)
```

#### 7.2 å»ºç­‘é…ç½® (`configs/building_config.json`)
```json
{
  "building_types": {
    "public": {
      "capacity": 500,
      "cost": 1000,
      "service_radius": 50,
      "color": "#22A6B3",
      "symbol": "ğŸ›ï¸",
      "description": "å…¬å…±å»ºç­‘"
    },
    "residential": {
      "capacity": 200,
      "cost": 500,
      "revenue_per_person": 10,
      "color": "#F6C344",
      "symbol": "ğŸ ",
      "description": "ä½å®…å»ºç­‘"
    },
    "commercial": {
      "capacity": 800,
      "cost": 1000,
      "revenue_per_person": 20,
      "color": "#FD7E14",
      "symbol": "ğŸª",
      "description": "å•†ä¸šå»ºç­‘"
    }
  },
  "land_price_factors": {
    "core_distance_weight": 0.5,
    "transport_weight": 0.3,
    "facility_weight": 0.2,
    "decay_rate": 0.01,
    "transport_decay_rate": 0.02
  },
  "trajectory_config": {
    "commute_color": "#0066CC",
    "commercial_color": "#CC3300",
    "combined_color": "#660099",
    "heatmap_alpha": 0.6,
    "trajectory_width": 2
  },
  "building_growth": {
    "target_total": 80,
    "growth_function": "logistic",
    "params": {
      "K": 80,
      "r": 0.4,
      "t0": 12
    },
    "min_new_per_month": 2,
    "max_new_per_month": 7,
    "residential_ratio": 0.5,
    "commercial_ratio": 0.3,
    "public_ratio": 0.2,
    "land_price_weight": 0.6,
    "heatmap_weight": 0.3,
    "facility_weight": 0.1,
    "candidate_top_percent": 20,
    "min_building_distance": {
      "residential": 30,
      "commercial": 40,
      "public": 50
    },
    "batch_rendering": {
      "enabled": true,
      "batches_per_month": 3,
      "interval_seconds": 1.5
    }
  },
  "visualization": {
    "background": "#FFFFFF",
    "trunk_road": "#9AA4B2",
    "core_point": "#0B5ED7",
    "heat_map": "#FF00FF",
    "residents": "#FFFFFF"
  }
}
```

#### 8.4 å»ºç­‘åˆ†å¸ƒéªŒæ”¶æ ‡å‡†
- [ ] æ–°å»ºä½å®…çš„åˆ†å¸ƒä¸å…¬å…±è®¾æ–½/ä¸­ç­‰åœ°ä»·åŒºç›¸å…³æ€§ > 0.7
- [ ] æ–°å»ºå•†ä¸šçš„åˆ†å¸ƒä¸é«˜åœ°ä»·/çƒ­åŠ›çƒ­ç‚¹ç›¸å…³æ€§ > 0.7
- [ ] éšæœºç”Ÿæˆå»ºç­‘æ¯”ä¾‹ < 20%ï¼Œå…¶ä½™ç”±åœ°ä»·é©±åŠ¨
- [ ] æ¨¡æ‹Ÿ 24 ä¸ªæœˆåï¼Œå»ºç­‘ç©ºé—´åˆ†å¸ƒä¸åœ°ä»·åˆ†å¸ƒå‘ˆæ˜¾è‘—è€¦åˆï¼ˆå¯é€šè¿‡çš®å°”é€Šç›¸å…³ > 0.6 éªŒè¯ï¼‰
- [ ] å»ºç­‘é—´ä¿æŒæœ€å°è·ç¦»çº¦æŸï¼Œæ— é‡å ç°è±¡
- [ ] åœ°ä»·æœ€é«˜ç‚¹ä½äºäº¤é€šæ¢çº½é™„è¿‘ï¼Œè€Œéåœ°å›¾ä¸­å¿ƒ
- [ ] 24ä¸ªæœˆæ–°å¢å»ºç­‘æ€»é‡åœ¨60â€“100æ ‹ä¹‹é—´
- [ ] å¢é•¿æ›²çº¿ç¬¦åˆSå‹ç‰¹å¾ï¼ˆå‰æœŸæ…¢ã€ä¸­æœŸå¿«ã€åæœŸæ”¶æ•›ï¼‰
- [ ] æ–°å»ºç­‘åˆ†å¸ƒä¸åœ°ä»·/çƒ­åŠ›ç›¸å…³æ€§ä¿æŒ >0.6
- [ ] åŠ¨ç”»è§‚æ„Ÿè‡ªç„¶ï¼Œæ— çªå…€"çˆ†å‘å¼"å¢é•¿

### 5. å¯è§†åŒ–ç³»ç»Ÿ

#### 5.1 æ¸²æŸ“å±‚æ¬¡
```
æ¸²æŸ“é¡ºåº:
1. èƒŒæ™¯ç½‘æ ¼
2. çƒ­åŠ›å›¾ (é€šå‹¤ + å•†ä¸š)
3. ä¸»å¹²é“
4. äº¤é€šæ¢çº½
5. å»ºç­‘ (å…¬å…± â†’ ä½å®… â†’ å•†ä¸š)
6. å±…æ°‘ (å¯é€‰æ˜¾ç¤º)
7. ç»Ÿè®¡ä¿¡æ¯
```

#### 5.2 çƒ­åŠ›å›¾å¯è§†åŒ–
**é¢œè‰²æ–¹æ¡ˆ**:
- é€šå‹¤çƒ­åŠ›å›¾: è“è‰²æ¸å˜ (#0066CC â†’ #FFFFFF)
- å•†ä¸šçƒ­åŠ›å›¾: çº¢è‰²æ¸å˜ (#CC3300 â†’ #FFFFFF)
- ç»¼åˆçƒ­åŠ›å›¾: ç´«è‰²æ¸å˜ (#660099 â†’ #FFFFFF)

**é€æ˜åº¦è®¾ç½®**:
- çƒ­åŠ›å›¾é€æ˜åº¦: 0.6
- å»ºç­‘é€æ˜åº¦: 0.8
- å±…æ°‘é€æ˜åº¦: 0.7

#### 5.3 åŠ¨ç”»ç³»ç»Ÿ
**å¸§ç‡è®¾ç½®**:
- æ¸²æŸ“é¢‘ç‡: æ¯æœˆ1å¸§
- æ€»å¸§æ•°: 24å¸§ (24ä¸ªæœˆ)
- æ’­æ”¾é€Ÿåº¦: 1ç§’/å¸§

**åŠ¨ç”»ç±»å‹**:
- é€å¸§æ’­æ”¾
- GIFåŠ¨ç”»
- çƒ­åŠ›å›¾æ¼”åŒ–åŠ¨ç”»

### 6. è¾“å‡ºç³»ç»Ÿ

#### 6.1 æ•°æ®è¾“å‡º
**JSONæ–‡ä»¶**:
- `city_state_output.json`: æœ€ç»ˆåŸå¸‚çŠ¶æ€
- `daily_stats.json`: æ¯æœˆç»Ÿè®¡æ•°æ®
- `trajectory_data.json`: è½¨è¿¹ç³»ç»Ÿæ•°æ®
- `land_price_evolution.json`: åœ°ä»·æ¼”åŒ–æ•°æ®
- `final_summary.json`: æ¨¡æ‹Ÿæ€»ç»“

**ç»Ÿè®¡æ•°æ®**:
- äººå£å¢é•¿æ›²çº¿
- å»ºç­‘æ•°é‡å˜åŒ–
- åœ°ä»·åˆ†å¸ƒå˜åŒ–
- çƒ­åŠ›å›¾ç»Ÿè®¡

#### 6.2 å¯è§†åŒ–è¾“å‡º
**å›¾ç‰‡æ–‡ä»¶**:
- `final_city_layout.png`: æœ€ç»ˆåŸå¸‚å¸ƒå±€
- `month_*.png`: æ¯æœˆæ¸²æŸ“å¸§ (24å¼ )
- `trajectory_heatmap.png`: è½¨è¿¹çƒ­åŠ›å›¾
- `growth_curves.png`: å¢é•¿æ›²çº¿å›¾

**åŠ¨ç”»æ–‡ä»¶**:
- `city_evolution.gif`: åŸå¸‚æ¼”åŒ–åŠ¨ç”»
- `trajectory_evolution.gif`: è½¨è¿¹æ¼”åŒ–åŠ¨ç”»

### 7. é…ç½®ç³»ç»Ÿ

#### 7.1 åŸå¸‚é…ç½® (`configs/city_config.json`)
```json
{
  "city_name": "ç¤ºä¾‹åŸå¸‚",
  "map_size": [256, 256],
  "core_point": [128, 128],
  "trunk_road": [[40, 128], [216, 128]],
  "simulation_months": 24,
  "initial_population": 100,
  "monthly_growth_rate": [0.08, 0.12],
  "max_population_density": 0.8,
  "trajectory_decay_rate": 0.8,
  "render_every_month": 1
}
```

#### 7.2 å»ºç­‘é…ç½® (`configs/building_config.json`)
```json
{
  "building_types": {
    "public": {
      "capacity": 500,
      "cost": 1000,
      "service_radius": 50,
      "color": "#22A6B3",
      "symbol": "ğŸ›ï¸",
      "description": "å…¬å…±å»ºç­‘"
    },
    "residential": {
      "capacity": 200,
      "cost": 500,
      "revenue_per_person": 10,
      "color": "#F6C344",
      "symbol": "ğŸ ",
      "description": "ä½å®…å»ºç­‘"
    },
    "commercial": {
      "capacity": 800,
      "cost": 1000,
      "revenue_per_person": 20,
      "color": "#FD7E14",
      "symbol": "ğŸª",
      "description": "å•†ä¸šå»ºç­‘"
    }
  },
  "land_price_factors": {
    "core_distance_weight": 0.5,
    "transport_weight": 0.3,
    "facility_weight": 0.2,
    "decay_rate": 0.01,
    "transport_decay_rate": 0.02
  },
  "trajectory_config": {
    "commute_color": "#0066CC",
    "commercial_color": "#CC3300",
    "combined_color": "#660099",
    "heatmap_alpha": 0.6,
    "trajectory_width": 2
  }
}
```

#### 7.3 æ™ºèƒ½ä½“é…ç½® (`configs/agent_config.json`)
```json
{
  "government_agent": {
    "decision_frequency": 3,
    "budget_limit": 10000,
    "public_facility_threshold": 0.8,
    "coverage_threshold": 0.6,
    "avg_time_threshold": 10
  },
  "business_agent": {
    "decision_frequency": 1,
    "profit_threshold": 0.6,
    "usage_ratio_threshold": 0.7,
    "expansion_probability": 0.4
  },
  "resident_agent": {
    "movement_speed": 4,
    "preference_weight": {
      "cost": 0.4,
      "convenience": 0.3,
      "quality": 0.3
    },
    "income_range": [3000, 8000],
    "housing_cost_ratio": 0.4
  }
}
```

### 8. éªŒæ”¶æ ‡å‡†

#### 8.1 åŠŸèƒ½éªŒæ”¶
- [ ] æœˆçº§æ—¶é—´ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
- [ ] çœŸå®é€šå‹¤è½¨è¿¹ç”Ÿæˆ
- [ ] çƒ­åŠ›å›¾æ­£ç¡®æ˜¾ç¤ºå’Œè¡°å‡
- [ ] äººå£å¢é•¿ç¬¦åˆé¢„æœŸ (24ä¸ªæœˆåè¾¾åˆ°800-1200äºº)
- [ ] å»ºç­‘å¢é•¿ç¬¦åˆé¢„æœŸ (24ä¸ªæœˆåè¾¾åˆ°60-100ä¸ªå»ºç­‘)
- [ ] åœ°ä»·ç³»ç»Ÿæ­£ç¡®è®¡ç®—å’Œæ›´æ–°

#### 8.2 å¯è§†åŒ–éªŒæ”¶
- [ ] æœ€ç»ˆåŸå¸‚å¸ƒå±€æ¸…æ™°æ˜¾ç¤º
- [ ] 24å¸§åŠ¨ç”»æµç•…æ’­æ”¾
- [ ] çƒ­åŠ›å›¾é¢œè‰²å’Œé€æ˜åº¦æ­£ç¡®
- [ ] è½¨è¿¹ç±»å‹å¯åŒºåˆ†
- [ ] ç»Ÿè®¡ä¿¡æ¯å‡†ç¡®æ˜¾ç¤º

#### 8.3 æ€§èƒ½éªŒæ”¶
- [ ] 24ä¸ªæœˆæ¨¡æ‹Ÿåœ¨5åˆ†é’Ÿå†…å®Œæˆ
- [ ] å†…å­˜ä½¿ç”¨ä¸è¶…è¿‡2GB
- [ ] è¾“å‡ºæ–‡ä»¶å¤§å°åˆç†
- [ ] åŠ¨ç”»æ’­æ”¾æµç•…

### 9. å¼€å‘è®¡åˆ’

#### 9.1 ç¬¬ä¸€é˜¶æ®µ: æ—¶é—´ç³»ç»Ÿæ”¹é€  (1-2å¤©)
- ä¿®æ”¹æ—¶é—´å•ä½ä¸ºæœˆ
- è°ƒæ•´æ›´æ–°é¢‘ç‡
- æ›´æ–°é…ç½®å‚æ•°

#### 9.2 ç¬¬äºŒé˜¶æ®µ: è½¨è¿¹ç³»ç»Ÿå¼€å‘ (2-3å¤©)
- å®ç°çœŸå®é€šå‹¤è½¨è¿¹
- å¼€å‘çƒ­åŠ›å›¾ç³»ç»Ÿ
- æ·»åŠ è½¨è¿¹è¡°å‡æœºåˆ¶

#### 9.3 ç¬¬ä¸‰é˜¶æ®µ: å¢é•¿ç³»ç»Ÿä¼˜åŒ– (1-2å¤©)
- è°ƒæ•´äººå£å¢é•¿å‚æ•°
- ä¼˜åŒ–å»ºç­‘å¢é•¿é€»è¾‘
- å¹³è¡¡ç³»ç»Ÿå‚æ•°

#### 9.4 ç¬¬å››é˜¶æ®µ: å¯è§†åŒ–å¢å¼º (1-2å¤©)
- æ”¹è¿›çƒ­åŠ›å›¾æ˜¾ç¤º
- ä¼˜åŒ–åŠ¨ç”»æ•ˆæœ
- å®Œå–„ç»Ÿè®¡å›¾è¡¨

#### 9.5 ç¬¬äº”é˜¶æ®µ: æµ‹è¯•å’Œä¼˜åŒ– (1å¤©)
- åŠŸèƒ½æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–
- æ–‡æ¡£å®Œå–„

### 10. é£é™©è¯„ä¼°

#### 10.1 æŠ€æœ¯é£é™©
- **çƒ­åŠ›å›¾æ€§èƒ½**: å¤§é‡è½¨è¿¹æ•°æ®å¯èƒ½å½±å“æ€§èƒ½
- **å†…å­˜ä½¿ç”¨**: 24ä¸ªæœˆçš„æ•°æ®å¯èƒ½å ç”¨è¾ƒå¤šå†…å­˜
- **åŠ¨ç”»æµç•…æ€§**: å¤æ‚çƒ­åŠ›å›¾å¯èƒ½å½±å“åŠ¨ç”»æ’­æ”¾

#### 10.2 ç¼“è§£æªæ–½
- ä½¿ç”¨numpyä¼˜åŒ–çƒ­åŠ›å›¾è®¡ç®—
- å®šæœŸæ¸…ç†å†å²æ•°æ®
- æä¾›å¤šç§å¯è§†åŒ–é€‰é¡¹

### 11. ç‰ˆæœ¬å†å²

#### v2.2 (å½“å‰ç‰ˆæœ¬)
- æ–°å¢Logisticå¢é•¿å‡½æ•°ï¼Œå®ç°Så‹åŸå¸‚ç”Ÿé•¿æ›²çº¿
- æ–°å¢åˆ†æ‰¹é—ªç°æœºåˆ¶ï¼Œä¼˜åŒ–è§†è§‰ä½“éªŒ
- ä¿®å¤åœ°ä»·ç³»ç»Ÿæ ¸å¿ƒç‚¹ä½ç½®ï¼ˆäº¤é€šæ¢çº½ï¼‰
- æ–°å¢å»ºç­‘é˜²é‡å¤æ”¾ç½®æœºåˆ¶
- æ–°å¢å»ºç­‘é—´æœ€å°è·ç¦»çº¦æŸ
- ä¼˜åŒ–å»ºç­‘åˆ†å¸ƒç®—æ³•

#### v2.0 (ä¸Šä¸€ç‰ˆæœ¬)
- æ–°å¢æœˆçº§æ—¶é—´ç³»ç»Ÿ
- æ–°å¢çœŸå®é€šå‹¤è½¨è¿¹
- æ–°å¢çƒ­åŠ›å›¾ç³»ç»Ÿ
- ä¼˜åŒ–å¢é•¿å‚æ•°

#### v1.0 (åŸç‰ˆæœ¬)
- åŸºç¡€å¤šæ™ºèƒ½ä½“ç³»ç»Ÿ
- æ—¥çº§æ—¶é—´ç³»ç»Ÿ
- åŸºç¡€å¯è§†åŒ–

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.2  
**æœ€åæ›´æ–°**: 2024å¹´8æœˆ28æ—¥  
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ
