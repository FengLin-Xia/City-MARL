# v5.0 åŸå¸‚æ¨¡æ‹Ÿç³»ç»Ÿè®¡ç®—é€»è¾‘è¯´æ˜

## ğŸ“‹ ç›®å½•
1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [åŠ¨ä½œé©±åŠ¨è®¾è®¡](#åŠ¨ä½œé©±åŠ¨è®¾è®¡)
3. [æˆæœ¬è®¡ç®—è¯¦è§£](#æˆæœ¬è®¡ç®—è¯¦è§£)
4. [å¥–åŠ±è®¡ç®—è¯¦è§£](#å¥–åŠ±è®¡ç®—è¯¦è§£)
5. [å£°æœ›è®¡ç®—è¯¦è§£](#å£°æœ›è®¡ç®—è¯¦è§£)
6. [RLå¥–åŠ±è®¡ç®—æœºåˆ¶](#rlå¥–åŠ±è®¡ç®—æœºåˆ¶)
7. [é¢„ç®—ç³»ç»Ÿ](#é¢„ç®—ç³»ç»Ÿ)
8. [åŠ¨ä½œé€‰æ‹©ä¸è¯„åˆ†](#åŠ¨ä½œé€‰æ‹©ä¸è¯„åˆ†)
9. [é…ç½®å‚æ•°è¯¦è§£](#é…ç½®å‚æ•°è¯¦è§£)
10. [è®¡ç®—æµç¨‹ç¤ºä¾‹](#è®¡ç®—æµç¨‹ç¤ºä¾‹)

---

## ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### åŠ¨ä½œé©±åŠ¨æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    V5RewardCalculator                    â”‚
â”‚  è®¡ç®—åŠ¨ä½œç»æµæŒ‡æ ‡ (cost/reward/prestige)                 â”‚
â”‚  ä½ç½®: logic/v5_reward_calculator.py                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    V5CityEnvironment                    â”‚
â”‚  åŸºäºåŠ¨ä½œå±æ€§ â†’ è®¡ç®—RLçš„total_reward                     â”‚
â”‚  ä½ç½®: envs/v5_0/city_env.py                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸»è¦ç»„ä»¶
- **V5RewardCalculator**: è®¡ç®—æ¯ä¸ªåŠ¨ä½œçš„ç»æµæŒ‡æ ‡
- **V5CityEnvironment**: å°†ç»æµæŒ‡æ ‡è½¬æ¢ä¸ºRLè®­ç»ƒå¥–åŠ±
- **BudgetPoolManager**: ç®¡ç†æ™ºèƒ½ä½“çš„è´¢åŠ¡çº¦æŸ
- **GaussianLandPriceSystem**: æä¾›åœ°ä»·ä¿¡æ¯ç”¨äºæˆæœ¬è®¡ç®—
- **åŠ¨æ€è®¡ç®—å™¨**: åœ°ä»·ã€é‚»è¿‘æ€§ã€æ²³æµã€è§„æ¨¡å¥–åŠ±è®¡ç®—

---

## åŠ¨ä½œé©±åŠ¨è®¾è®¡

### åŠ¨ä½œIDæ˜ å°„
```json
{
    "EDU": {
        "0": "EDU_S",    // å°å‹æ•™è‚²å»ºç­‘
        "1": "EDU_M",    // ä¸­å‹æ•™è‚²å»ºç­‘
        "2": "EDU_L"     // å¤§å‹æ•™è‚²å»ºç­‘
    },
    "IND": {
        "3": "IND_S",    // å°å‹å·¥ä¸šå»ºç­‘
        "4": "IND_M",    // ä¸­å‹å·¥ä¸šå»ºç­‘
        "5": "IND_L"     // å¤§å‹å·¥ä¸šå»ºç­‘
    },
    "COUNCIL": {
        "6": "COUNCIL_A", // å¸‚æ”¿Aå‹å»ºç­‘
        "7": "COUNCIL_B", // å¸‚æ”¿Bå‹å»ºç­‘
        "8": "COUNCIL_C"  // å¸‚æ”¿Cå‹å»ºç­‘
    }
}
```

### åŠ¨ä½œå‚æ•°ç»“æ„
æ¯ä¸ªåŠ¨ä½œåŒ…å«å®Œæ•´çš„ç»æµå‚æ•°ï¼š
```json
{
    "action_params": {
        "3": {
            "desc": "IND_S",
            "base_cost": 900,        // åŸºç¡€å»ºé€ æˆæœ¬
            "base_reward": 180,      // åŸºç¡€æœˆæ”¶å…¥
            "opex": 100,             // è¿è¥æˆæœ¬
            "rent": 25,              // ç§Ÿé‡‘
            "prestige_base": 0.2,    // åŸºç¡€å£°æœ›
            "pollution": 0.6,        // æ±¡æŸ“å€¼
            "capacity": 1.0,         // å®¹é‡ç³»æ•°
            "land_price_k": 0.25,    // åœ°ä»·æ•æ„Ÿåº¦ç³»æ•°
            "river_pct": 20.0,       // æ²³æµæº¢ä»·ç™¾åˆ†æ¯”
            "size_bonus": 0          // è§„æ¨¡å¥–åŠ±
        }
    }
}
```

---

## æˆæœ¬è®¡ç®—è¯¦è§£

### åŸºç¡€å…¬å¼

**æ‰€æœ‰åŠ¨ä½œ**:
```
cost = base_cost + zone_cost + land_price_cost
```

### å‚æ•°è¯¦è§£

#### åŸºç¡€å»ºé€ æˆæœ¬
```json
{
    "0": {"base_cost": 700},   // EDU_S
    "1": {"base_cost": 1200},  // EDU_M
    "2": {"base_cost": 1900},  // EDU_L
    "3": {"base_cost": 900},   // IND_S
    "4": {"base_cost": 1500},  // IND_M
    "5": {"base_cost": 2400},  // IND_L
    "6": {"base_cost": 570},   // COUNCIL_A
    "7": {"base_cost": 870},   // COUNCIL_B
    "8": {"base_cost": 1150}    // COUNCIL_C
}
```

#### åŒºä½é™„åŠ æˆæœ¬
```json
ZC = {
    "near": 200,  // é è¿‘æ¢çº½åŒºåŸŸ
    "mid": 100,   // ä¸­ç­‰è·ç¦»åŒºåŸŸ
    "far": 0      // è¿œç¦»æ¢çº½åŒºåŸŸ
}
```

#### åœ°ä»·æˆæœ¬
```
land_price_cost = land_price_norm Ã— 1000

å…¶ä¸­:
- land_price_norm: 0.0~1.0 (ä»GaussianLandPriceSystemè·å–)
- land_price_costèŒƒå›´: 0~1000 kGBP
```

### æˆæœ¬è®¡ç®—ç¤ºä¾‹

**IND_SåŠ¨ä½œ** (zone=near, land_price_norm=0.8):
```
base_cost = 900
zone_cost = 200
land_price_cost = 0.8 Ã— 1000 = 800
total_cost = 900 + 200 + 800 = 1900 kGBP
```

---

## å¥–åŠ±è®¡ç®—è¯¦è§£

### åŸºç¡€å…¬å¼

**æ‰€æœ‰åŠ¨ä½œ**:
```
reward_base = base_reward + zone_reward + adj_bonus - opex - rent + river_premium
reward = reward_base Ã— (1 + land_price_k Ã— land_price_norm)
reward += proximity_bonus + size_bonus
```

### å‚æ•°è¯¦è§£

#### åŸºç¡€æœˆæ”¶å…¥
```json
{
    "0": {"base_reward": 140},  // EDU_S
    "1": {"base_reward": 260},  // EDU_M
    "2": {"base_reward": 420},  // EDU_L
    "3": {"base_reward": 180},  // IND_S
    "4": {"base_reward": 320},  // IND_M
    "5": {"base_reward": 520},  // IND_L
    "6": {"base_reward": 570},  // COUNCIL_A
    "7": {"base_reward": 870},  // COUNCIL_B
    "8": {"base_reward": 1150}  // COUNCIL_C
}
```

#### åŒºä½æ”¶å…¥åŠ æˆ
```json
ZR = {
    "near": 80,  // é è¿‘æ¢çº½åŒºåŸŸ
    "mid": 40,   // ä¸­ç­‰è·ç¦»åŒºåŸŸ
    "far": 0     // è¿œç¦»æ¢çº½åŒºåŸŸ
}
```

#### è¿è¥æˆæœ¬
```json
{
    "0": {"opex": 70},   // EDU_S
    "1": {"opex": 120},  // EDU_M
    "2": {"opex": 190},  // EDU_L
    "3": {"opex": 100},  // IND_S
    "4": {"opex": 180},  // IND_M
    "5": {"opex": 300},  // IND_L
    "6": {"opex": 50},   // COUNCIL_A
    "7": {"opex": 80},   // COUNCIL_B
    "8": {"opex": 120}   // COUNCIL_C
}
```

#### ç§Ÿé‡‘æœºåˆ¶
```json
Rent = {
    "S": 25,    // å°å‹å»ºç­‘ç§Ÿé‡‘
    "M": 45,    // ä¸­å‹å»ºç­‘ç§Ÿé‡‘
    "L": 70     // å¤§å‹å»ºç­‘ç§Ÿé‡‘
}
```

**ç§Ÿé‡‘é€»è¾‘**:
- INDå»ºç­‘: æ”¯ä»˜ç§Ÿé‡‘ (reward -= Rent)
- EDUå»ºç­‘: è·å¾—ç§Ÿé‡‘ (reward += Rent)
- COUNCILå»ºç­‘: æ— ç§Ÿé‡‘å½±å“

#### åœ°ä»·æ•æ„Ÿåº¦ç³»æ•°
```json
land_price_k = {
    "0": 0.10,  // EDU_S
    "1": 0.10,  // EDU_M
    "2": 0.10,  // EDU_L
    "3": 0.25,  // IND_S
    "4": 0.25,  // IND_M
    "5": 0.25,  // IND_L
    "6": 0.15,  // COUNCIL_A
    "7": 0.15,  // COUNCIL_B
    "8": 0.15   // COUNCIL_C
}
```

### æ²³æµæº¢ä»·æœºåˆ¶

```
decay = 2^(-river_dist / RiverD_half_m)
BaseForPremium = base_reward + zone_reward
RawRiverPrem = BaseForPremium Ã— river_pct/100 Ã— decay
RiverPremium = clamp(round_nearest(RawRiverPrem), 0, RiverPremiumCap)
```

**å‚æ•°**:
- `river_pct`: åŠ¨ä½œç‰¹å®šå€¼
- `RiverD_half_m`: 120ç±³ (åŠè¡°è·ç¦»)
- `RiverPremiumCap`: 10000 kGBP (å°é¡¶å€¼)

### é‚»è¿‘æ€§å¥–åŠ±/æƒ©ç½š

**é‚»è¿‘å¥–åŠ±** (è·ç¦» â‰¤ 10å•ä½):
```
proximity_bonus = proximity_reward_val Ã— (1.0 - min_dist / proximity_threshold)
```

**è·ç¦»æƒ©ç½š** (è·ç¦» > 10å•ä½):
```
distance_penalty = (min_dist - proximity_threshold) Ã— distance_penalty_coef
```

**å‚æ•°**:
- `proximity_threshold`: 10.0
- `proximity_reward_val`: 50.0
- `distance_penalty_coef`: 2.0

### è§„æ¨¡å¥–åŠ± (Size Bonus)

```json
size_bonus = {
    "1": 1000,  // EDU_M
    "2": 2000,  // EDU_L
    "4": 1000,  // IND_M
    "5": 2000,  // IND_L
    "7": 1000,  // COUNCIL_B
    "8": 2000   // COUNCIL_C
}
```

### æ”¶ç›Šè®¡ç®—ç¤ºä¾‹

**IND_SåŠ¨ä½œ** (zone=near, land_price_norm=0.8, è·ç¦»æ²³æµ30ç±³):
```
base_reward = 180
zone_reward = 80
opex = 100
rent = 25
river_premium = 61

reward_base = 180 + 80 + 0 - 100 - 25 + 61 = 196
reward = 196 Ã— (1 + 0.25 Ã— 0.8) = 196 Ã— 1.2 = 235
proximity_bonus = 50
size_bonus = 0
total_reward = 235 + 50 + 0 = 285 kGBP/æœˆ
```

---

## å£°æœ›è®¡ç®—è¯¦è§£

### åŸºç¡€å…¬å¼

**æ‰€æœ‰åŠ¨ä½œ**:
```
prestige = prestige_base + zone_bonus + adj_bonus - pollution_penalty
```

### å‚æ•°è¯¦è§£

#### åŸºç¡€å£°æœ›å€¼
```json
{
    "0": {"prestige_base": 0.2},   // EDU_S
    "1": {"prestige_base": 0.6},   // EDU_M
    "2": {"prestige_base": 1.0},  // EDU_L
    "3": {"prestige_base": 0.2},   // IND_S
    "4": {"prestige_base": 0.1},   // IND_M
    "5": {"prestige_base": -0.1},  // IND_L
    "6": {"prestige_base": 0.3},   // COUNCIL_A
    "7": {"prestige_base": 0.7},   // COUNCIL_B
    "8": {"prestige_base": 1.2}    // COUNCIL_C
}
```

#### åŒºä½å’Œé‚»æ¥åŠ æˆ
- `zone_bonus`: é è¿‘æ¢çº½åŒºåŸŸæ—¶ +1.0
- `adj_bonus`: æœ‰é‚»æ¥å»ºç­‘æ—¶ +1.0

#### æ±¡æŸ“æƒ©ç½š
```json
pollution = {
    "0": 0.2,   // EDU_S
    "1": 0.4,   // EDU_M
    "2": 0.6,   // EDU_L
    "3": 0.6,   // IND_S
    "4": 0.9,   // IND_M
    "5": 1.2,   // IND_L
    "6": 0.1,   // COUNCIL_A
    "7": 0.2,   // COUNCIL_B
    "8": 0.3    // COUNCIL_C
}
```

### å£°æœ›è®¡ç®—ç¤ºä¾‹

**EDU_LåŠ¨ä½œ** (nearåŒºåŸŸ, æœ‰é‚»æ¥):
```
prestige_base = 1.0
zone_bonus = 1.0
adj_bonus = 1.0
pollution_penalty = 0.6
prestige = 1.0 + 1.0 + 1.0 - 0.6 = 2.4
```

---

## RLå¥–åŠ±è®¡ç®—æœºåˆ¶

### è®¡ç®—æµç¨‹ (`envs/v5_0/city_env.py`)

```python
def _calculate_reward(self, agent, action):
    """è®¡ç®—å¥–åŠ±ï¼ˆå›ºå®šNPVæœºåˆ¶ï¼‰"""
    # 1. è®¡ç®—å»ºé€ æˆæœ¬
    build_cost = float(action.cost) if action.cost is not None else 0.0
    
    if build_cost > 0:  # æœ‰å»ºé€ 
        # 2. è®¡ç®—æœªæ¥æ”¶ç›Šï¼ˆå›ºå®šå›æŠ¥æœŸï¼‰
        expected_lifetime = 12  # é¢„æœŸç”Ÿå‘½å‘¨æœŸ(æœˆ)
        monthly_reward = float(action.reward) if action.reward is not None else 0.0
        future_income = monthly_reward * expected_lifetime
        
        # 3. NPV = æœªæ¥æ”¶ç›Š - æˆæœ¬
        npv = future_income - build_cost
        
        # 4. è¿›åº¦å¥–åŠ±
        progress_reward = len(self.buildings) * 0.5
        
        # 5. åä½œå¥–åŠ±ï¼ˆå¯é…ç½®ï¼‰
        cooperation_bonus = self._calculate_cooperation_reward(agent, action)
        
        # 6. Budgetæƒ©ç½šï¼ˆè½¯çº¦æŸï¼‰
        budget_penalty = self._calculate_budget_penalty(agent, action)
        
        # 7. æ€»å¥–åŠ± = NPV + è¿›åº¦ + åä½œ - æƒ©ç½š
        total_reward = npv + progress_reward + cooperation_bonus - budget_penalty
    else:
        # ç©ºåºåˆ—ï¼ˆä¸å»ºé€ ï¼‰ï¼šæ— reward
        total_reward = 0.0
    
    # 8. å¥–åŠ±ç¼©æ”¾
    scaled_reward = total_reward / reward_scale  # é»˜è®¤30000
    scaled_reward = np.clip(scaled_reward, -1.0, 1.0)
    
    return scaled_reward
```

### åä½œå¥–åŠ±æœºåˆ¶

```python
def _calculate_cooperation_reward(self, agent, action):
    cooperation_lambda = 0.2  # åä½œæƒé‡
    
    cooperation_bonus = 0.0
    
    # åŠŸèƒ½äº’è¡¥å¥–åŠ±
    if agent == 'EDU':
        cooperation_bonus += len(industrial_buildings) * 0.05
    elif agent == 'IND':
        cooperation_bonus += len(public_buildings) * 0.05
    
    # ç©ºé—´åè°ƒå¥–åŠ±
    for other_building in all_buildings:
        distance = calculate_distance(action, other_building)
        if 5 <= distance <= 20:
            cooperation_bonus += 0.02
    
    return cooperation_lambda * cooperation_bonus
```

### æœˆåº¦æ”¶ç›Šç´¯ç§¯æœºåˆ¶

```python
def _calculate_monthly_income(self, agent):
    """è®¡ç®—agentçš„æœˆåº¦æ”¶ç›Šï¼ˆæ‰€æœ‰åœ¨è¥å»ºç­‘çš„ç´¯åŠ ï¼‰"""
    total_income = sum([
        asset['monthly_income'] 
        for asset in self.active_assets[agent]
    ])
    return total_income

def _advance_turn(self):
    """æ¯æœˆå¼€å§‹æ—¶ï¼Œä¸ºæ‰€æœ‰agentç´¯åŠ æœˆåº¦æ”¶ç›Šåˆ°budget"""
    # ã€æœˆåº¦æ”¶ç›Šæœºåˆ¶ã€‘æ¯æœˆå¼€å§‹æ—¶ï¼Œä¸ºæ‰€æœ‰agentç´¯åŠ æœˆåº¦æ”¶ç›Šåˆ°budget
    if self.budgets is not None:
        for agent in self.rl_cfg['agents']:
            monthly_income = self._calculate_monthly_income(agent)
            self.budgets[agent] += monthly_income  # æ¯æœˆçœŸå®ç´¯ç§¯æ”¶ç›Š
            
            # è®°å½•æœˆåº¦æ”¶ç›Šå†å²
            self.monthly_income_history[agent].append(monthly_income)

def _place_building(self, agent, action):
    """æ”¾ç½®å»ºç­‘æ—¶è®°å½•ä¸ºåœ¨è¥èµ„äº§"""
    # ã€æœˆåº¦æ”¶ç›Šæœºåˆ¶ã€‘è®°å½•ä¸ºåœ¨è¥èµ„äº§
    asset = {
        'action_id': action.id,
        'monthly_income': float(action.reward),  # å­˜å‚¨æœˆåº¦æ”¶ç›Š
        'cost': float(action.cost),
        'built_month': self.current_month,
    }
    self.active_assets[agent].append(asset)  # æ·»åŠ åˆ°åœ¨è¥èµ„äº§åˆ—è¡¨
```

### åŒé‡æ”¶ç›Šæœºåˆ¶è¯¦è§£

ç³»ç»Ÿè®¾è®¡äº†**åŒé‡æ”¶ç›Šæœºåˆ¶**æ¥å¹³è¡¡RLè®­ç»ƒå’Œè´¢åŠ¡çº¦æŸï¼š

#### 1. **RLå¥–åŠ±å±‚é¢ï¼ˆNPVæœºåˆ¶ï¼‰**
```python
# RLçœ‹åˆ°çš„æ˜¯é•¿æœŸä»·å€¼
expected_lifetime = 12  # 12ä¸ªæœˆé¢„æœŸç”Ÿå‘½å‘¨æœŸ
future_income = monthly_reward * expected_lifetime
npv = future_income - build_cost

# ç¤ºä¾‹ï¼šIND_SåŠ¨ä½œ
# npv = 285 * 12 - 1900 = 3420 - 1900 = 1520 kGBP (æ­£æ”¶ç›Š)
```

**ä½œç”¨**ï¼šç»™RLæ™ºèƒ½ä½“æ­£ç¡®çš„"æŠ•èµ„å›æŠ¥"ä¿¡å·ï¼Œé¼“åŠ±é•¿æœŸæŠ•èµ„è¡Œä¸ºã€‚

#### 2. **Budgetç³»ç»Ÿå±‚é¢ï¼ˆç°é‡‘æµç®¡ç†ï¼‰**
```python
# æ¯æœˆçœŸå®ç´¯ç§¯æ”¶ç›Š
def _advance_turn(self):
    for agent in agents:
        monthly_income = sum([asset.monthly_income for asset in active_assets])
        budget[agent] += monthly_income

# ç¤ºä¾‹ï¼šIND_SåŠ¨ä½œçš„Budgetå˜åŒ–
# Month 0: budget = 15000 - 1900 = 13100  # å»ºé€ æˆæœ¬
# Month 1: budget = 13100 + 285 = 13385   # ç¬¬1ä¸ªæœˆæ”¶ç›Š
# Month 2: budget = 13385 + 285 = 13670   # ç¬¬2ä¸ªæœˆæ”¶ç›Š
# ...
# Month 12: budget = 15000 + 1520 = 16520 # 12ä¸ªæœˆåå‡€æ”¶ç›Š1520
```

**ä½œç”¨**ï¼šæä¾›çœŸå®çš„ç°é‡‘æµç®¡ç†ï¼Œé˜²æ­¢è¿‡åº¦å€Ÿè´·ï¼Œç¡®ä¿è´¢åŠ¡å¯æŒç»­æ€§ã€‚

#### 3. **ä¸¤è€…åè°ƒæ€§**
- **è®¾è®¡ä¸€è‡´æ€§**ï¼š12ä¸ªæœˆåBudgetå¢é•¿ä¸NPVè®¡ç®—å®Œå…¨ä¸€è‡´
- **åŠŸèƒ½äº’è¡¥**ï¼šRLè´Ÿè´£é•¿æœŸç­–ç•¥ï¼ŒBudgetè´Ÿè´£çŸ­æœŸçº¦æŸ
- **é¿å…çŸ›ç›¾**ï¼šä¸å­˜åœ¨"RLè¯´èµšé’±ä½†Budgetè¯´äºé’±"çš„æƒ…å†µ

---

## é¢„ç®—ç³»ç»Ÿ

### é…ç½®å‚æ•°

```json
"budget_system": {
    "enabled": true,
    "mode": "soft_constraint",
    "initial_budgets": {
        "IND": 15000,   // å·¥ä¸šæ™ºèƒ½ä½“åˆå§‹é¢„ç®—
        "EDU": 20000,   // æ•™è‚²æ™ºèƒ½ä½“åˆå§‹é¢„ç®—
        "COUNCIL": 20000 // å¸‚æ”¿æ™ºèƒ½ä½“åˆå§‹é¢„ç®—
    },
    "debt_penalty_coef": 0.1,        // è´Ÿå€ºæƒ©ç½šç³»æ•°
    "max_debt": -2000,               // æœ€å¤§å…è®¸è´Ÿå€º
    "bankruptcy_threshold": -5000,   // ç ´äº§é˜ˆå€¼
    "bankruptcy_penalty": -100.0     // ç ´äº§æƒ©ç½š
}
```

### Budgetæƒ©ç½šè®¡ç®—

```python
def _calculate_budget_penalty(self, agent, action):
    if self.budgets is None:
        return 0.0
    
    # é¢„ä¼°å»ºé€ åçš„budget
    budget_after = self.budgets[agent] - action.cost
    
    budget_penalty = 0.0
    
    # è´Ÿå€ºæƒ©ç½š
    if budget_after < 0:
        debt_penalty_coef = 0.1
        budget_penalty = abs(budget_after) * debt_penalty_coef
    
    # ç ´äº§æƒ©ç½š
    if budget_after < -5000:
        budget_penalty += 100.0
    
    return budget_penalty
```

### Budgetæ›´æ–°æœºåˆ¶

```python
def step(self, action):
    # 1. å»ºé€ æ—¶æ‰£é™¤æˆæœ¬
    if action.build:
        self.budgets[agent] -= action.cost
    
    # 2. æ¯æœˆç´¯åŠ æœˆåº¦æ”¶ç›Š
    monthly_income = self._calculate_monthly_income(agent)
    self.budgets[agent] += monthly_income
    
    # 3. è®°å½•budgetå†å²
    self.budget_history[agent].append(self.budgets[agent])
```

---

## åŠ¨ä½œé€‰æ‹©ä¸è¯„åˆ†

### V5ActionScorerè¯„åˆ†æœºåˆ¶

```python
def score_actions(self, actions):
    # 1. è®¡ç®—åŸå§‹cost/reward/prestige
    for action in actions:
        self._calc_crp(action)
    
    # 2. å½’ä¸€åŒ–å„ç»´åº¦
    costs = [a.cost for a in actions]
    rewards = [a.reward for a in actions]
    prestiges = [a.prestige for a in actions]
    
    c_min, c_max = min(costs), max(costs)
    r_min, r_max = min(rewards), max(rewards)
    p_min, p_max = min(prestiges), max(prestiges)
    
    def norm(v, lo, hi):
        return (v - lo) / (hi - lo) if hi - lo > 1e-9 else 0.5
    
    # 3. æŒ‰æ™ºèƒ½ä½“ä½¿ç”¨ä¸åŒæƒé‡è®¡ç®—ç»¼åˆè¯„åˆ†
    for action in actions:
        w = self.objective.get(action.agent, {"w_r": 0.5, "w_p": 0.3, "w_c": 0.2})
        
        nr = norm(action.reward, r_min, r_max)
        np = norm(action.prestige, p_min, p_max)
        nc = norm(action.cost, c_min, c_max)
        
        action.score = w["w_r"] * nr + w["w_p"] * np - w["w_c"] * nc
    
    return actions
```

### æ™ºèƒ½ä½“æƒé‡é…ç½®

```json
"objective": {
    "EDU": {
        "w_r": 0.45,  // rewardæƒé‡
        "w_p": 0.45,  // prestigeæƒé‡  
        "w_c": 0.1    // costæƒé‡
    },
    "IND": {
        "w_r": 0.6,   // rewardæƒé‡
        "w_p": 0.2,   // prestigeæƒé‡
        "w_c": 0.2    // costæƒé‡
    },
    "COUNCIL": {
        "w_r": 0.4,   // rewardæƒé‡
        "w_p": 0.5,   // prestigeæƒé‡
        "w_c": 0.1    // costæƒé‡
    }
}
```

### åŠ¨ä½œé€‰æ‹©ç­–ç•¥

1. **æšä¸¾é˜¶æ®µ**: ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„å»ºç­‘åŠ¨ä½œ
2. **è¯„åˆ†é˜¶æ®µ**: ä½¿ç”¨V5ActionScorerè®¡ç®—ç»¼åˆè¯„åˆ†
3. **æ’åºé˜¶æ®µ**: æŒ‰è¯„åˆ†é™åºæ’åˆ—
4. **é€‰æ‹©é˜¶æ®µ**: RLæ™ºèƒ½ä½“ä»æ’åºåçš„åŠ¨ä½œä¸­é€‰æ‹©

---

## é…ç½®å‚æ•°è¯¦è§£

### æ ¸å¿ƒé…ç½®ç»“æ„

```json
{
    "simulation": {
        "total_months": 30
    },
    "city": {
        "map_size": [200, 200],
        "transport_hubs": [[122, 80], [112, 121]]
    },
    "budget_system": {
        "enabled": true,
        "initial_budgets": {"IND": 15000, "EDU": 20000, "COUNCIL": 20000},
        "debt_penalty_coef": 0.1,
        "bankruptcy_threshold": -5000
    },
    "action_params": {
        "0": {"base_cost": 700, "base_reward": 140, "opex": 70, "rent": 25, "prestige_base": 0.2, "pollution": 0.2, "land_price_k": 0.10, "river_pct": 15.0, "size_bonus": 0},
        "1": {"base_cost": 1200, "base_reward": 260, "opex": 120, "rent": 45, "prestige_base": 0.6, "pollution": 0.4, "land_price_k": 0.10, "river_pct": 15.0, "size_bonus": 1000},
        "2": {"base_cost": 1900, "base_reward": 420, "opex": 190, "rent": 70, "prestige_base": 1.0, "pollution": 0.6, "land_price_k": 0.10, "river_pct": 15.0, "size_bonus": 2000},
        "3": {"base_cost": 900, "base_reward": 180, "opex": 100, "rent": 25, "prestige_base": 0.2, "pollution": 0.6, "land_price_k": 0.25, "river_pct": 20.0, "size_bonus": 0},
        "4": {"base_cost": 1500, "base_reward": 320, "opex": 180, "rent": 45, "prestige_base": 0.1, "pollution": 0.9, "land_price_k": 0.25, "river_pct": 20.0, "size_bonus": 1000},
        "5": {"base_cost": 2400, "base_reward": 520, "opex": 300, "rent": 70, "prestige_base": -0.1, "pollution": 1.2, "land_price_k": 0.25, "river_pct": 20.0, "size_bonus": 2000},
        "6": {"base_cost": 570, "base_reward": 570, "opex": 50, "rent": 0, "prestige_base": 0.3, "pollution": 0.1, "land_price_k": 0.15, "river_pct": 10.0, "size_bonus": 0},
        "7": {"base_cost": 870, "base_reward": 870, "opex": 80, "rent": 0, "prestige_base": 0.7, "pollution": 0.2, "land_price_k": 0.15, "river_pct": 10.0, "size_bonus": 1000},
        "8": {"base_cost": 1150, "base_reward": 1150, "opex": 120, "rent": 0, "prestige_base": 1.2, "pollution": 0.3, "land_price_k": 0.15, "river_pct": 10.0, "size_bonus": 2000}
    },
    "reward_terms": {
        "enabled": true,
        "calculation_mode": "full",
        "components": {
            "land_price": true,
            "proximity": true,
            "river": true,
            "size_bonus": true
        },
        "land_price": {
            "LP_idx_min": 10,
            "LP_idx_max": 100,
            "LandPriceBase": 11.0,
            "RewardLP_k": {"IND": 0.25, "EDU": 0.10, "COUNCIL": 0.15}
        },
        "proximity": {
            "proximity_threshold": 10.0,
            "proximity_reward": 50.0,
            "distance_penalty_coef": 2.0
        },
        "river": {
            "RiverD_half_m": 120.0,
            "RiverPremiumCap": 10000.0
        }
    },
    "solver": {
        "rl": {
            "reward_scale": 30000.0,
            "reward_clip": 1.0,
            "cooperation_lambda": 0.0
        }
    }
}
```

---

## è®¡ç®—æµç¨‹ç¤ºä¾‹

### å®Œæ•´è®¡ç®—ç¤ºä¾‹

å‡è®¾è¦åœ¨ä½ç½®(100, 80)å»ºé€ ä¸€ä¸ªIND_SåŠ¨ä½œ (action_id=3):

#### 1. è¾“å…¥å‚æ•°
- agent: "IND"
- action_id: 3
- zone: "near" (è·ç¦»hub1 < 15å•ä½)
- land_price_norm: 0.8 (åœ°ä»·å½’ä¸€åŒ–å€¼)
- adj: 1 (æœ‰é‚»æ¥å»ºç­‘)
- river_dist_m: 30 (è·ç¦»æ²³æµ30ç±³)

#### 2. æˆæœ¬è®¡ç®—
```
base_cost = 900
zone_cost = 200  # nearåŒºåŸŸ
land_price_cost = 0.8 Ã— 1000 = 800
total_cost = 900 + 200 + 800 = 1900 kGBP
```

#### 3. å¥–åŠ±è®¡ç®—
```
base_reward = 180
zone_reward = 80
opex = 100
rent = 25
river_premium = 61  # æ²³æµæº¢ä»·è®¡ç®—

reward_base = 180 + 80 + 0 - 100 - 25 + 61 = 196
reward = 196 Ã— (1 + 0.25 Ã— 0.8) = 196 Ã— 1.2 = 235
proximity_bonus = 50  # é‚»è¿‘æ€§å¥–åŠ±
size_bonus = 0
total_reward = 235 + 50 + 0 = 285 kGBP/æœˆ
```

#### 4. å£°æœ›è®¡ç®—
```
prestige_base = 0.2
zone_bonus = 1.0
adj_bonus = 1.0
pollution_penalty = 0.6
prestige = 0.2 + 1.0 + 1.0 - 0.6 = 1.6
```

#### 5. V5ActionScorerè¯„åˆ†
```
# å‡è®¾å½“å‰æ‰¹æ¬¡ä¸­:
# costs: [1000, 1500, 1900, 2500]
# rewards: [100, 200, 285, 400]  
# prestiges: [0.5, 1.0, 1.6, 2.0]

nr = (285-100)/(400-100) = 0.62
np = (1.6-0.5)/(2.0-0.5) = 0.73
nc = (1900-1000)/(2500-1000) = 0.60

score = 0.6 Ã— 0.62 + 0.2 Ã— 0.73 - 0.2 Ã— 0.60 = 0.50
```

#### 6. RLå¥–åŠ±è®¡ç®—
```
# NPVè®¡ç®— (12ä¸ªæœˆé¢„æœŸæ”¶ç›Š)
future_income = 285 Ã— 12 = 3420 kGBP
npv = 3420 - 1900 = 1520 kGBP

progress_reward = 5 Ã— 0.5 = 2.5
cooperation_bonus = 0 (é»˜è®¤ç¦ç”¨)
budget_penalty = 0 (å‡è®¾budgetå……è¶³)

total_reward = 1520 + 2.5 + 0 - 0 = 1522.5
scaled_reward = 1522.5 / 30000 = 0.051
```

#### 7. Budgetæ›´æ–°
```
# å»ºé€ æ—¶
budget_IND = 15000 - 1900 = 13100

# æ¯æœˆæ”¶ç›Š
budget_IND = 13100 + 285 = 13385
```

---

## æ€»ç»“

### ç³»ç»Ÿç‰¹ç‚¹
1. **åŠ¨ä½œé©±åŠ¨æ¶æ„**: åŸºäºaction_idè€Œésizeè¿›è¡Œå‚æ•°æŸ¥æ‰¾
2. **å®Œæ•´ç»æµå»ºæ¨¡**: åŒ…å«æˆæœ¬ã€å¥–åŠ±ã€å£°æœ›çš„å®Œæ•´è®¡ç®—
3. **åŠ¨æ€å½±å“å› å­**: åœ°ä»·ã€æ²³æµã€é‚»è¿‘æ€§ã€åŒºä½ç­‰åŠ¨æ€å½±å“
4. **åŒé‡æ”¶ç›Šæœºåˆ¶**: RLä½¿ç”¨NPVè€ƒè™‘é•¿æœŸä»·å€¼ï¼ŒBudgetç³»ç»Ÿç®¡ç†çœŸå®ç°é‡‘æµ
5. **æœˆåº¦æ”¶ç›Šæœºåˆ¶**: å»ºç­‘å»ºæˆåæŒç»­äº§ç”Ÿæ”¶ç›Šï¼Œæ¯æœˆçœŸå®ç´¯ç§¯åˆ°Budget
6. **è½¯çº¦æŸBudget**: å…è®¸é€‚åº¦è´Ÿå€ºï¼Œé¿å…è¿‡åº¦ä¿å®ˆ

### å…³é”®è®¾è®¡ç†å¿µ
- **ç»æµåˆç†æ€§**: æˆæœ¬æ”¶ç›Šè®¡ç®—åŸºäºçœŸå®ç»æµé€»è¾‘
- **å¯æŒç»­æ€§**: æœˆåº¦æ”¶ç›Šç¡®ä¿é•¿æœŸç›ˆåˆ©
- **åä½œæ€§**: å¤šæ™ºèƒ½ä½“é—´çš„åŠŸèƒ½äº’è¡¥å’Œç©ºé—´åè°ƒ
- **å¯é…ç½®æ€§**: ä¸°å¯Œçš„å‚æ•°é…ç½®æ”¯æŒä¸åŒåœºæ™¯

### ç³»ç»Ÿä¼˜åŠ¿
1. **åŒé‡æ”¶ç›Šæœºåˆ¶**: RLä½¿ç”¨NPVè€ƒè™‘é•¿æœŸä»·å€¼ï¼ŒBudgetç³»ç»Ÿç®¡ç†çœŸå®ç°é‡‘æµ
2. **åˆç†çš„ç»æµé€»è¾‘**: 12ä¸ªæœˆé¢„æœŸç”Ÿå‘½å‘¨æœŸä¸æœˆåº¦æ”¶ç›Šç´¯ç§¯æœºåˆ¶åè°ƒä¸€è‡´
3. **æ™ºèƒ½ä½“å·®å¼‚åŒ–**: ä¸åŒæ™ºèƒ½ä½“æœ‰ä¸åŒçš„æƒé‡å’Œå‚æ•°è®¾ç½®
4. **è½¯çº¦æŸBudget**: å…è®¸é€‚åº¦è´Ÿå€ºï¼Œé¿å…è¿‡åº¦ä¿å®ˆï¼ŒåŒæ—¶é˜²æ­¢ç ´äº§

### å½“å‰å¯èƒ½çš„é—®é¢˜
1. **å‚æ•°è°ƒä¼˜**: expected_lifetimeã€reward_scaleç­‰å‚æ•°å¯èƒ½éœ€è¦æ ¹æ®å®é™…è®­ç»ƒæ•ˆæœè°ƒæ•´
2. **åä½œæœºåˆ¶è¾ƒå¼±**: cooperation_lambda=0.0é»˜è®¤ç¦ç”¨ï¼Œå¤šæ™ºèƒ½ä½“åä½œä¿¡å·å¾®å¼±
3. **è®­ç»ƒè¶…å‚æ•°**: å­¦ä¹ ç‡ã€clip_epsç­‰å¯èƒ½éœ€è¦é’ˆå¯¹å…·ä½“åœºæ™¯ä¼˜åŒ–

### ç³»ç»Ÿè®¾è®¡åˆç†æ€§
- **RLå¥–åŠ±æœºåˆ¶**: ä½¿ç”¨NPVç»™RLæ­£ç¡®çš„"æŠ•èµ„å›æŠ¥"ä¿¡å·ï¼Œé¼“åŠ±é•¿æœŸæŠ•èµ„
- **Budgetç³»ç»Ÿ**: æ¯æœˆçœŸå®ç´¯ç§¯æ”¶ç›Šï¼Œæä¾›è´¢åŠ¡çº¦æŸï¼Œé˜²æ­¢è¿‡åº¦å€Ÿè´·
- **ä¸¤è€…åè°ƒ**: 12ä¸ªæœˆåBudgetå¢é•¿ä¸NPVè®¡ç®—ä¸€è‡´ï¼Œè®¾è®¡åˆç†

è¿™ä¸ªç³»ç»Ÿä¸ºåŸå¸‚è§„åˆ’å’Œå¤šæ™ºèƒ½ä½“å†³ç­–æä¾›äº†ä¸€ä¸ªå®Œæ•´çš„è®¡ç®—æ¡†æ¶ï¼Œé€šè¿‡ç²¾ç»†çš„ç»æµå»ºæ¨¡å’Œå¥–åŠ±è®¾è®¡æ¥æŒ‡å¯¼æ™ºèƒ½ä½“çš„å†³ç­–è¡Œä¸ºã€‚æ ¸å¿ƒé€»è¾‘è®¾è®¡åˆç†ï¼Œé—®é¢˜ä¸»è¦åœ¨äºå‚æ•°è°ƒä¼˜å’Œè®­ç»ƒé…ç½®ã€‚
