1020-3.md — v5 重构落地指令（给 Cursor）

目标：最小侵入、可回滚地完成 v5 配置化 + 契约层 + 数字化动作 + 可配置调度（phase_cycle）。
不改环境动力学与槽位导入；主要完成装配与数据结构“统一口径”。

✅ 结果验收标准（DoD）

配置：city_config_v5.json（数字化动作）可被加载；支持 phase_cycle 调度。

契约：统一使用 ActionCandidate / Sequence / StepLog 三个数据结构。

训练/评估：主循环仅依赖契约对象与配置，不再散落 if-else。

导出：txt 直接输出动作编号；无任何“名称↔编号”映射代码。

表格/分析：仅读取 StepLog.reward_terms 与 chosen。

回归：用 v4.1 固定种子跑 1 条 golden trace，比对 reward 分项与预算曲线不劣化。

0. 新建分支 & 目录

Cursor 指令：

新建分支








1. 契约层（最低可用集）

新建 contracts/contracts.py，后续所有模块只用这里的类型交流。

创建文件：contracts/contracts.py

from dataclasses import dataclass
from typing import Dict, List, Any
import numpy as np

# 统一候选动作的“评分对象”
@dataclass(frozen=True)
class ActionCandidate:
    id: int                   # 动作编号（0..N-1）
    features: np.ndarray      # 给策略网络打分的特征
    meta: Dict[str, Any]      # 例如 slot_id、agent、合法性标记等

# 统一动作序列（每个 agent 在一个阶段内的选择）
@dataclass(frozen=True)
class Sequence:
    agent: str                # "IND" / "EDU" / "COUNCIL" / ...
    actions: List[int]        # 例如 [0,3,5]：全是编号

# 统一一步日志
@dataclass
class StepLog:
    t: int
    agent: str
    chosen: List[int]                     # 实际执行的动作编号
    reward_terms: Dict[str, float]        # {"revenue":..., "cost":..., ...}
    budget_snapshot: Dict[str, float] | None = None


后续修改要求：训练/评估/导出/表格脚本全部以 StepLog 为唯一数据源；禁止再写自定义 JSON 结构。