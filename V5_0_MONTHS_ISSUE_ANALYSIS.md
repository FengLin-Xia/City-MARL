# v5.0 月份问题深度分析

## 🚨 问题描述

**用户期望**: 运行30个月
**实际结果**: 只有16个月份
**问题**: 越改越奇怪，月份数量不对

## 🔍 问题分析

### **1. 配置层面**
```json
"time_model": { "step_unit": "month", "total_steps": 30 }
```
- **期望**: 30个月
- **配置**: 30个时间步

### **2. 环境层面**
```python
def _should_switch_month(self) -> bool:
    return True  # 每1步切换1个月
```
- **逻辑**: 每1步 = 1个月
- **执行**: 30步 = 30个月

### **3. 调度器层面**
```json
"scheduler": {
  "period": 1,
  "phases": [
    { "agents": ["IND"], "mode": "sequential" },
    { "agents": ["EDU","COUNCIL"], "mode": "concurrent" }
  ]
}
```
- **逻辑**: 每1步切换阶段
- **执行**: IND → EDU+COUNCIL → IND → EDU+COUNCIL

### **4. 实际执行结果**
```
步骤0: IND执行 (月份1)
步骤1: EDU执行 (月份2)  
步骤2: IND执行 (月份3)
步骤3: EDU执行 (月份4)
...
步骤29: EDU执行 (月份30)
```

## 🤔 问题根源分析

### **问题1: 月份编号混乱**
- **环境月份**: 0, 1, 2, 3, ..., 30 (31个月)
- **导出月份**: 1, 2, 3, 4, ..., 16 (16个月)
- **配置月份**: 30个月

### **问题2: 月份切换逻辑错误**
```python
def _should_switch_month(self) -> bool:
    return True  # 每步都切换月份
```
**问题**: 每步都切换月份，导致月份增长过快！

### **问题3: 调度器与月份切换冲突**
- **调度器**: 每1步切换阶段 (IND → EDU+COUNCIL)
- **月份切换**: 每1步切换月份 (0 → 1 → 2 → 3)
- **结果**: 每个智能体执行时月份都在变化

## 🎯 真正的问题

### **用户期望的逻辑**
```
月份0: IND执行
月份1: EDU+COUNCIL执行
月份2: IND执行
月份3: EDU+COUNCIL执行
...
月份29: IND执行 (30个月)
```

### **当前实现的逻辑**
```
步骤0: IND执行 (月份0→1)
步骤1: EDU执行 (月份1→2)
步骤2: IND执行 (月份2→3)
步骤3: EDU执行 (月份3→4)
...
步骤29: EDU执行 (月份29→30)
```

### **问题在于**
1. **月份切换时机错误**: 每步都切换月份
2. **智能体执行时机错误**: 智能体执行时月份已经变化
3. **导出逻辑错误**: 只导出有动作的月份

## 💡 正确的逻辑应该是

### **方案1: 每2步切换月份**
```python
def _should_switch_month(self) -> bool:
    """检查是否需要切换月份"""
    # 每2步切换1个月 (每2个智能体执行后切换月份)
    return self.current_step % 2 == 0
```

### **方案2: 每阶段切换月份**
```python
def _should_switch_month(self) -> bool:
    """检查是否需要切换月份"""
    # 每阶段切换1个月 (IND阶段和EDU+COUNCIL阶段后切换月份)
    # 需要检测阶段是否变化
    return self._phase_changed()
```

### **方案3: 每智能体切换月份**
```python
def _should_switch_month(self) -> bool:
    """检查是否需要切换月份"""
    # 每智能体执行后切换月份
    return True  # 当前实现
```

## 🔧 问题总结

### **核心问题**
1. **月份切换逻辑**: 每步都切换月份，导致月份增长过快
2. **智能体执行时机**: 智能体执行时月份已经变化
3. **导出逻辑**: 只导出有动作的月份，导致月份不连续

### **用户期望**
- **30个月**: 月份0到29 (30个月)
- **月份轮次**: IND → EDU+COUNCIL → IND → EDU+COUNCIL
- **每2步**: 1个月 (IND执行 + EDU+COUNCIL执行 = 1个月)

### **当前问题**
- **月份增长**: 每步都增长，导致月份过多
- **智能体执行**: 每个智能体执行时月份不同
- **导出结果**: 月份不连续，只有16个月

## 🎯 解决方案

### **正确的逻辑应该是**
```
月份0: IND执行 (步骤0-1)
月份1: EDU+COUNCIL执行 (步骤2-3)
月份2: IND执行 (步骤4-5)
月份3: EDU+COUNCIL执行 (步骤6-7)
...
月份29: IND执行 (步骤58-59)
```

### **需要修复**
1. **月份切换逻辑**: 每2步切换1个月
2. **智能体执行**: 每2步执行1个月
3. **导出逻辑**: 导出所有月份数据

**问题根源**: 月份切换逻辑错误，导致月份增长过快！**
