# v5.0 æ—¶é—´å•ä½é€»è¾‘åˆ†æ

## ğŸ” é—®é¢˜æè¿°

**æ ¸å¿ƒé—®é¢˜**: ç»éªŒæ”¶é›†çš„æ—¶é—´å•ä½å’Œå®é™…æœˆä»½å•ä½ä¹‹é—´çš„å…³ç³»é€»è¾‘ä¸æ¸…æ™°ï¼Œå­˜åœ¨æ¦‚å¿µæ··æ·†ã€‚

## ğŸ“Š å½“å‰å®ç°åˆ†æ

### **1. é…ç½®å±‚é¢çš„æ—¶é—´å•ä½**

#### **é…ç½®æ–‡ä»¶å®šä¹‰**
```json
"time_model": { 
    "step_unit": "month", 
    "total_steps": 30 
}
```

**å«ä¹‰è§£è¯»**:
- `step_unit: "month"` â†’ æ¯ä¸ªæ—¶é—´æ­¥ä»£è¡¨1ä¸ªæœˆ
- `total_steps: 30` â†’ æ€»å…±30ä¸ªæ—¶é—´æ­¥ = 30ä¸ªæœˆ

### **2. ç¯å¢ƒå±‚é¢çš„æ—¶é—´å•ä½**

#### **ç¯å¢ƒçŠ¶æ€ç®¡ç†**
```python
class V5CityEnvironment:
    def __init__(self):
        self.current_step = 0      # ç¯å¢ƒå†…éƒ¨æ­¥æ•°è®¡æ•°å™¨
        self.current_month = 0     # ç¯å¢ƒæœˆä»½è®¡æ•°å™¨
        self.current_agent = None  # å½“å‰æ´»è·ƒæ™ºèƒ½ä½“
```

#### **çŠ¶æ€æ›´æ–°é€»è¾‘**
```python
def _update_state(self):
    """æ›´æ–°ç¯å¢ƒçŠ¶æ€"""
    self.current_step += 1         # æ¯è°ƒç”¨ä¸€æ¬¡ï¼Œæ­¥æ•°+1
    
    if self._should_switch_agent():
        self._switch_agent()      # åˆ‡æ¢æ™ºèƒ½ä½“
    
    if self._should_switch_month():
        self._switch_month()      # åˆ‡æ¢æœˆä»½
```

#### **æœˆä»½åˆ‡æ¢é€»è¾‘**
```python
def _should_switch_month(self) -> bool:
    """æ£€æŸ¥æ˜¯å¦éœ€è¦åˆ‡æ¢æœˆä»½"""
    # æ¯1æ­¥åˆ‡æ¢ä¸€ä¸ªæœˆ (ç¬¦åˆtotal_stepsé…ç½®)
    return True
```

### **3. è®­ç»ƒå™¨å±‚é¢çš„æ—¶é—´å•ä½**

#### **ç»éªŒæ”¶é›†é€»è¾‘**
```python
def collect_experience(self, num_steps: int) -> List[Dict]:
    """æ”¶é›†ç»éªŒæ•°æ®"""
    while steps_collected < num_steps:  # num_steps = 30
        state = self.env.reset()        # é‡ç½®ç¯å¢ƒ
        episode_experiences = []
        done = False
        step_count = 0
        
        while not done and steps_collected < num_steps:
            # æ‰§è¡Œä¸€æ­¥
            next_state, reward, done, info = self.env.step(...)
            step_count += 1
            steps_collected += 1
```

## ğŸ¤” é€»è¾‘æ··ä¹±åˆ†æ

### **é—®é¢˜1: åŒé‡æ—¶é—´å•ä½**

#### **ç¯å¢ƒå†…éƒ¨æ—¶é—´**
- `current_step`: ç¯å¢ƒå†…éƒ¨æ­¥æ•°è®¡æ•°å™¨
- `current_month`: ç¯å¢ƒæœˆä»½è®¡æ•°å™¨
- **å…³ç³»**: æ¯1æ­¥ = 1ä¸ªæœˆ (å› ä¸º`_should_switch_month()`è¿”å›True)

#### **è®­ç»ƒå™¨æ”¶é›†æ—¶é—´**
- `num_steps`: è®­ç»ƒå™¨è¦æ±‚æ”¶é›†çš„æ­¥æ•° (30)
- `steps_collected`: è®­ç»ƒå™¨å®é™…æ”¶é›†çš„æ­¥æ•°
- **å…³ç³»**: 30æ­¥ç»éªŒ = 30ä¸ªæœˆæ•°æ®

### **é—®é¢˜2: æ—¶é—´å•ä½ä¸ä¸€è‡´**

#### **é…ç½®å±‚é¢**
```
total_steps: 30 â†’ 30ä¸ªæœˆ
step_unit: "month" â†’ æ¯æ­¥1ä¸ªæœˆ
```

#### **å®ç°å±‚é¢**
```
ç¯å¢ƒ: current_step += 1, current_month += 1 (æ¯æ­¥1ä¸ªæœˆ)
è®­ç»ƒå™¨: æ”¶é›†30æ­¥ â†’ 30ä¸ªæœˆæ•°æ®
```

#### **ç»“æœå±‚é¢**
```
å¯¼å‡º: 17ä¸ªæœˆæ•°æ® (1, 3, 4, 6, 7, 8, 10, 11, 12, 14, 15, 16, 18, 19, 20, 22, 23, 26, 30)
```

### **é—®é¢˜3: æ¦‚å¿µæ··æ·†**

#### **"æ­¥æ•°"çš„å¤šé‡å«ä¹‰**
1. **ç¯å¢ƒæ­¥æ•°** (`current_step`): ç¯å¢ƒå†…éƒ¨æ‰§è¡Œæ¬¡æ•°
2. **ç»éªŒæ­¥æ•°** (`num_steps`): è®­ç»ƒå™¨æ”¶é›†çš„ç»éªŒæ•°é‡
3. **æ—¶é—´æ­¥æ•°** (`total_steps`): é…ç½®ä¸­çš„æ€»æ—¶é—´æ­¥æ•°
4. **æœˆä»½æ­¥æ•°**: å®é™…æœˆä»½è®¡æ•°

#### **"æœˆä»½"çš„å¤šé‡å«ä¹‰**
1. **é…ç½®æœˆä»½** (`total_steps: 30`): 30ä¸ªæœˆ
2. **ç¯å¢ƒæœˆä»½** (`current_month`): ç¯å¢ƒå½“å‰æœˆä»½
3. **å¯¼å‡ºæœˆä»½**: å®é™…å¯¼å‡ºçš„æœˆä»½æ•°æ®

## ğŸ¯ é€»è¾‘æ¢³ç†

### **å½“å‰å®é™…é€»è¾‘**

#### **æ—¶é—´å•ä½å…³ç³»**
```
1ä¸ªç¯å¢ƒæ­¥ (current_step) = 1ä¸ªæœˆ (current_month)
30ä¸ªç¯å¢ƒæ­¥ = 30ä¸ªæœˆ
```

#### **ç»éªŒæ”¶é›†é€»è¾‘**
```
è®­ç»ƒå™¨æ”¶é›†30æ­¥ç»éªŒ
â†“
ç¯å¢ƒæ‰§è¡Œ30æ­¥
â†“
ç¯å¢ƒæœˆä»½ä»0åˆ°30
â†“
å¯¼å‡º17ä¸ªæœˆæ•°æ® (å› ä¸ºä¸æ˜¯æ¯ä¸ªæœˆéƒ½æœ‰åŠ¨ä½œ)
```

#### **å¯¼å‡ºé€»è¾‘**
```
ç¯å¢ƒæœˆä»½: 0, 1, 2, 3, ..., 30
æœ‰åŠ¨ä½œçš„æœˆä»½: 1, 3, 4, 6, 7, 8, 10, 11, 12, 14, 15, 16, 18, 19, 20, 22, 23, 26, 30
å¯¼å‡ºæ–‡ä»¶: month_01, month_03, ..., month_30
```

### **é€»è¾‘ä¸€è‡´æ€§æ£€æŸ¥**

#### **é…ç½®ä¸å®ç°ä¸€è‡´æ€§**
- âœ… **é…ç½®**: `total_steps: 30` (30ä¸ªæœˆ)
- âœ… **å®ç°**: ç¯å¢ƒæ‰§è¡Œ30æ­¥ï¼Œæœˆä»½0â†’30
- âœ… **ç»“æœ**: è¦†ç›–30ä¸ªæœˆèŒƒå›´

#### **æ—¶é—´å•ä½ä¸€è‡´æ€§**
- âœ… **ç¯å¢ƒ**: æ¯æ­¥1ä¸ªæœˆ
- âœ… **è®­ç»ƒå™¨**: æ”¶é›†30æ­¥ = 30ä¸ªæœˆ
- âœ… **å¯¼å‡º**: 17ä¸ªæœˆæœ‰æ•ˆæ•°æ®

## ğŸš¨ æ½œåœ¨é—®é¢˜

### **é—®é¢˜1: æœˆä»½ç¼–å·ä¸ä¸€è‡´**
- **ç¯å¢ƒæœˆä»½**: 0, 1, 2, 3, ..., 30 (31ä¸ªæœˆ)
- **å¯¼å‡ºæœˆä»½**: 1, 3, 4, 6, ..., 30 (17ä¸ªæœˆ)
- **é…ç½®æœˆä»½**: 30ä¸ªæœˆ

### **é—®é¢˜2: æ•°æ®ä¸è¿ç»­**
- **æœˆä»½0**: æ²¡æœ‰å¯¼å‡º (åˆå§‹çŠ¶æ€)
- **æœˆä»½2, 5, 9, 13, 17, 21, 24, 25, 27, 28, 29**: æ²¡æœ‰åŠ¨ä½œï¼Œæ²¡æœ‰å¯¼å‡º

### **é—®é¢˜3: æ¦‚å¿µæ··æ·†**
- **"æ­¥æ•°"**: ç¯å¢ƒæ­¥æ•° vs ç»éªŒæ­¥æ•° vs æ—¶é—´æ­¥æ•°
- **"æœˆä»½"**: é…ç½®æœˆä»½ vs ç¯å¢ƒæœˆä»½ vs å¯¼å‡ºæœˆä»½

## ğŸ’¡ å»ºè®®æ”¹è¿›

### **æ–¹æ¡ˆ1: æ˜ç¡®æ—¶é—´å•ä½**
```json
"time_model": {
    "step_unit": "month",
    "total_steps": 30,
    "start_month": 0,
    "end_month": 30
}
```

### **æ–¹æ¡ˆ2: ç»Ÿä¸€å‘½å**
```python
# ç¯å¢ƒå±‚é¢
self.current_time_step = 0    # æ—¶é—´æ­¥
self.current_month = 0        # æœˆä»½

# è®­ç»ƒå™¨å±‚é¢
def collect_experience(self, num_time_steps: int)  # æ—¶é—´æ­¥æ•°
```

### **æ–¹æ¡ˆ3: æ¸…æ™°æ–‡æ¡£**
```
æ—¶é—´å•ä½å…³ç³»:
- 1ä¸ªæ—¶é—´æ­¥ = 1ä¸ªæœˆ
- 30ä¸ªæ—¶é—´æ­¥ = 30ä¸ªæœˆ
- ç¯å¢ƒæ‰§è¡Œ30æ­¥ â†’ æœˆä»½0åˆ°30
- å¯¼å‡ºæ•°æ®è¦†ç›–1åˆ°30æœˆ
```

## ğŸ“ æ€»ç»“

**å½“å‰é€»è¾‘å®é™…ä¸Šæ˜¯æ­£ç¡®çš„**ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

1. **å‘½åæ··æ·†**: "æ­¥æ•°"å’Œ"æœˆä»½"æ¦‚å¿µé‡å 
2. **æ–‡æ¡£ä¸æ¸…**: æ—¶é—´å•ä½å…³ç³»æ²¡æœ‰æ˜ç¡®è¯´æ˜
3. **å®ç°å¤æ‚**: å¤šå±‚æ—¶é—´å•ä½ç®¡ç†

**å»ºè®®**: ä¿æŒå½“å‰å®ç°ï¼Œä½†éœ€è¦ï¼š
1. æ˜ç¡®æ–‡æ¡£è¯´æ˜æ—¶é—´å•ä½å…³ç³»
2. ç»Ÿä¸€å‘½åè§„èŒƒ
3. æ·»åŠ æ³¨é‡Šè¯´æ˜é€»è¾‘

**æ ¸å¿ƒé€»è¾‘æ˜¯æ­£ç¡®çš„**: 30æ­¥ç»éªŒ = 30ä¸ªæœˆæ•°æ®ï¼Œå¯¼å‡º17ä¸ªæœˆæœ‰æ•ˆæ•°æ®ã€‚

