# V4.1 æœ€ç»ˆè®­ç»ƒé…ç½®æ€»ç»“

## ğŸ“‹ é…ç½®ä¿®æ”¹æ€»è§ˆ

åŸºäº50 episodesè®­ç»ƒç»“æœå’Œä¸“ä¸šå»ºè®®ï¼Œç»¼åˆä¼˜åŒ–é…ç½®ã€‚

---

## ğŸ¯ è§£å†³çš„é—®é¢˜

### é—®é¢˜1ï¼šValue Lossè¿‡é«˜ï¼ˆ14000+ï¼‰âœ… å·²è§£å†³
- **åŸå› **ï¼šreward_scaleå¤ªå°ï¼ˆ500ï¼‰
- **ä¿®å¤**ï¼šreward_scale â†’ 2000ï¼Œcritic_lr â†’ 5e-4
- **æ•ˆæœ**ï¼šValue Lossé™åˆ°630ï¼ˆé™95%ï¼‰

### é—®é¢˜2ï¼šè¿‡æ—©æ”¶æ•›ï¼ˆEpisode 2å°±å›ºå®š90.0ï¼‰âš ï¸ å¾…è§£å†³
- **åŸå› **ï¼šEntropyå¤ªä½ï¼Œexplorationä¸è¶³
- **ä¿®å¤**ï¼šæé«˜ent_coef, entropy_coef, temperature
- **é¢„æœŸ**ï¼šç­–ç•¥æŒç»­æ¢ç´¢ï¼Œreturnæœ‰æ³¢åŠ¨

### é—®é¢˜3ï¼š100% Så‹å»ºç­‘âš ï¸ å¾…è§£å†³
- **åŸå› **ï¼šSize bonusä¸è¶³
- **ä¿®å¤**ï¼šsize_bonuså¤§å¹…æé«˜ï¼ˆM:1000, L:2000ï¼‰
- **é¢„æœŸ**ï¼šå‡ºç°M/Lå‹å»ºç­‘

---

## âš™ï¸ å®Œæ•´é…ç½®å‚æ•°

### æ ¸å¿ƒRLå‚æ•°

```json
{
  "solver": {
    "rl": {
      // === å­¦ä¹ ç‡ï¼ˆç¨³å®šæ›´æ–°ï¼‰===
      "actor_lr": 5e-5,          // é™ä½50%ï¼Œæ›´æ¸©å’Œ
      "critic_lr": 5e-4,         // ä¿æŒï¼ŒValueéœ€è¦å¿«å­¦
      
      // === PPOè£å‰ªï¼ˆæ”¶ç´§ï¼‰===
      "clip_eps": 0.15,          // ä»0.2é™åˆ°0.15
      
      // === Explorationï¼ˆå¢å¼ºï¼‰===
      "ent_coef": 0.15,          // ä»0.05æé«˜åˆ°0.15ï¼ˆ3å€ï¼‰
      "entropy_coef": 0.08,      // ä»0.02æé«˜åˆ°0.08ï¼ˆ4å€ï¼‰
      "temperature": 3.5,        // ä»2.0æé«˜åˆ°3.5
      
      // === è®­ç»ƒè®¾ç½® ===
      "num_epochs": 3,           // ä»2æ”¹åˆ°3ï¼ˆæ•´é™¤batchï¼‰
      "max_updates": 30,         // ä»50é™åˆ°30
      "rollout_steps": 10,
      "mini_batch_size": 10,
      
      // === Rewardç¼©æ”¾ ===
      "reward_scale": 2000.0,    // ä»500æé«˜åˆ°2000
      "reward_clip": 1.0,        // ä¸¥æ ¼é™åˆ¶[-1,1]
      
      // === å…¶ä»– ===
      "gamma": 0.99,
      "gae_lambda": 0.95,
      "vf_coef": 0.5,
      "max_grad_norm": 0.5,
      "cooperation_lambda": 0.0,
    }
  }
}
```

### Sizeæ¿€åŠ±å‚æ•°

```json
{
  "growth_v4_1": {
    "evaluation": {
      "size_bonus": {"S": 0, "M": 1000, "L": 2000},
      "proximity_reward": 1500.0,
    }
  }
}
```

---

## ğŸ“Š å‚æ•°ä¿®æ”¹å¯¹æ¯”

| å‚æ•° | æ—§å€¼ | æ–°å€¼ | å˜åŒ– | ç›®çš„ |
|------|------|------|------|------|
| **actor_lr** | 1e-4 | 5e-5 | -50% | ç¨³å®šè®­ç»ƒ |
| **critic_lr** | 1e-4 | 5e-4 | +400% | åŠ é€ŸValueå­¦ä¹  |
| **clip_eps** | 0.2 | 0.15 | -25% | æ”¶ç´§æ›´æ–° |
| **ent_coef** | 0.05 | 0.15 | +200% | å¢å¼ºæ¢ç´¢ |
| **entropy_coef** | 0.02 | 0.08 | +300% | å¢å¼ºæ¢ç´¢ |
| **temperature** | 2.0 | 3.5 | +75% | å¢åŠ éšæœºæ€§ |
| **num_epochs** | 2 | 3 | +50% | æ•´é™¤ä¼˜åŒ– |
| **max_updates** | 50 | 30 | -40% | é€‚åº¦è®­ç»ƒ |
| **reward_scale** | 500 | 2000 | +300% | é™ä½Value Loss |
| **reward_clip** | 5.0 | 1.0 | -80% | ä¸¥æ ¼é™åˆ¶ |
| **size_bonus M** | 300 | 1000 | +233% | é¼“åŠ±Må‹ |
| **size_bonus L** | 800 | 2000 | +150% | é¼“åŠ±Lå‹ |

---

## ğŸ¯ é¢„æœŸè®­ç»ƒæ•ˆæœ

### Episode 1-10ï¼ˆæ¢ç´¢é˜¶æ®µï¼‰
```
Return: 60-120ï¼ˆæ³¢åŠ¨ï¼‰
Value Loss: 500-1000
KL: 1.0-3.0
Clip: 60-90%
Entropy: 1.2-1.6
Sizeåˆ†å¸ƒ: ä¸»è¦Sï¼Œå¶å°”M
```

### Episode 10-20ï¼ˆå­¦ä¹ é˜¶æ®µï¼‰
```
Return: 100-150ï¼ˆä¸Šå‡ï¼‰
Value Loss: 200-500
KL: 0.5-1.5
Clip: 40-70%
Entropy: 1.0-1.4
Sizeåˆ†å¸ƒ: Sä¸ºä¸»ï¼ŒMå¢åŠ ï¼ŒLå¼€å§‹å‡ºç°
```

### Episode 20-30ï¼ˆæ”¶æ•›é˜¶æ®µï¼‰
```
Return: 150-200ï¼ˆç¨³å®šï¼‰
Value Loss: 100-300
KL: 0.1-0.5
Clip: 20-50%
Entropy: 0.8-1.2
Sizeåˆ†å¸ƒ: S 50-60%, M 20-30%, L 10-20%
```

---

## ğŸ”¬ å…³é”®æ”¹è¿›ç‚¹

### 1. **Value Lossä¿®å¤** âœ…
- reward_scale: 500 â†’ 2000
- critic_lr: 1e-4 â†’ 5e-4
- **æ•ˆæœ**ï¼šValue Lossä»14000é™åˆ°630

### 2. **Explorationå¢å¼º** ğŸ†•
- ent_coef: 0.05 â†’ 0.15
- entropy_coef: 0.02 â†’ 0.08
- temperature: 2.0 â†’ 3.5
- **ç›®æ ‡**ï¼šæ‰“ç ´Episode 2å°±å›ºå®šçš„åƒµå±€

### 3. **æ›´æ–°ç¨³å®šæ€§** ğŸ†•
- actor_lr: 1e-4 â†’ 5e-5
- clip_eps: 0.2 â†’ 0.15
- **ç›®æ ‡**ï¼šé™ä½KLæ³¢åŠ¨

### 4. **Sizeå¤šæ ·æ€§** ğŸ†•
- size_bonus: {M:300, L:800} â†’ {M:1000, L:2000}
- **ç›®æ ‡**ï¼šé¼“åŠ±å»ºé€ M/Lå‹

### 5. **è®­ç»ƒæ•ˆç‡** ğŸ†•
- num_epochs: 2 â†’ 3
- max_updates: 50 â†’ 30
- **ç›®æ ‡**ï¼šbatchæ•´é™¤ä¼˜åŒ–ï¼Œé€‚åº¦è®­ç»ƒé‡

---

## ğŸš€ è®­ç»ƒå‘½ä»¤

```bash
# åˆ é™¤æ—§æ¨¡å‹ï¼ˆé‡æ–°è®­ç»ƒï¼‰
rm models/v4_1_rl/*.pth

# æˆ–å¤‡ä»½
mv models/v4_1_rl models/v4_1_rl_backup_50ep

# é‡æ–°è®­ç»ƒ
python enhanced_city_simulation_v4_1.py --mode rl
```

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

è®­ç»ƒæ—¶é‡ç‚¹è§‚å¯Ÿï¼š

### å…³é”®æŒ‡æ ‡
1. **Value Loss**: åº”è¯¥<1000ï¼Œé€æ¸é™åˆ°<300
2. **KL**: åº”è¯¥<2.0ï¼Œé€æ¸é™åˆ°<0.5
3. **Clip**: åº”è¯¥<80%ï¼Œé€æ¸é™åˆ°<40%
4. **Entropy**: åº”è¯¥>1.0ï¼Œä¿æŒæ¢ç´¢
5. **Return**: åº”è¯¥æ³¢åŠ¨ï¼ˆ60-200ï¼‰ï¼Œä¸åº”è¯¥å›ºå®š

### æˆåŠŸæ ‡å¿—
- âœ… Value Lossç¨³å®šåœ¨100-300
- âœ… Returnåœ¨150-200èŒƒå›´
- âœ… å‡ºç°M/Lå‹å»ºç­‘ï¼ˆ>10%ï¼‰
- âœ… å»ºç­‘æ€»æ•°>50ä¸ª

### å¤±è´¥ä¿¡å·
- ğŸ”´ Returnå†æ¬¡å›ºå®šï¼ˆå¦‚éƒ½æ˜¯120.0ï¼‰
- ğŸ”´ Value Loss>1000ä¸é™
- ğŸ”´ ä»ç„¶100% Så‹

---

## ğŸ“ é…ç½®æ–‡ä»¶å·²æ›´æ–°

æ‰€æœ‰ä¿®æ”¹å·²åº”ç”¨åˆ°`configs/city_config_v4_1.json`

**å‡†å¤‡å¥½é‡æ–°è®­ç»ƒäº†ï¼**

---

**é…ç½®ç‰ˆæœ¬**: v4.1_optimized  
**ä¿®æ”¹æ—¥æœŸ**: 2025-10-12  
**çŠ¶æ€**: âœ… å·²åº”ç”¨ï¼Œå¾…è®­ç»ƒéªŒè¯

